<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MVP - Alocação Agenda pelo Próprio Parceiro</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#263244;

      --green:#22c55e;
      --orange:#f59e0b;
      --red:#ef4444;
      --blue:#60a5fa;

      --chip:#1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(900px 600px at 85% 20%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0;
      z-index:8;
      background:
        linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.80)),
        radial-gradient(120% 120% at 10% 0%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(120% 120% at 90% 0%, rgba(245,158,11,.16), transparent 60%);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(38,50,68,.75);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    header:after{
      content:"";
      display:block;
      height:2px;
      background: linear-gradient(90deg, rgba(34,197,94,.55), rgba(96,165,250,.45), rgba(245,158,11,.55));
      opacity:.7;
    }
    .wrap{max-width:none;width:100%;margin:0 auto;padding:16px 18px}
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:800;
      letter-spacing:.3px;
      text-transform:uppercase;
      font-size:14px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--green), var(--orange));
      box-shadow: 0 0 0 6px rgba(34,197,94,.08);
    }
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:6px;
      border:1px solid rgba(38,50,68,.6);
      background: rgba(2,6,23,.35);
      border-radius:16px;
    }
    .tab{
      padding:10px 14px;
      border:1px solid rgba(38,50,68,.75);
      background: rgba(17,24,39,.7);
      color:var(--text);
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      font-weight:700;
      letter-spacing:.2px;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .tab-break{flex-basis:100%;height:0}
    .tab:hover{transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.25)}
    .tab.active{
      background: linear-gradient(135deg, rgba(34,197,94,.28), rgba(96,165,250,.18));
      border-color: rgba(34,197,94,.6);
      box-shadow: 0 10px 22px rgba(34,197,94,.18);
    }

    main .wrap{padding-top:18px;padding-bottom:36px}

    .grid{display:grid;grid-template-columns: 380px 1fr;gap:14px}
    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.92));
      border:1px solid rgba(38,50,68,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card h2, .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.3px;
      text-transform:uppercase;
      color:#cbd5e1;
    }
    .card .content{padding:14px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .inline-input{display:flex;gap:8px;align-items:center}
    .inline-input > input{flex:1}
    .inline-input > button{white-space:nowrap}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 0}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(38,50,68,.9);
      background: rgba(2,6,23,.55);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(96,165,250,.65);
      box-shadow: 0 0 0 4px rgba(96,165,250,.12);
    }

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .actions.tight{gap:6px}
    .btn-sm{
      padding:6px 8px;
      border-radius:10px;
      font-weight:700;
      font-size:12px;
    }
    button{
      border:none;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(31,41,55,.9);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      border:1px solid rgba(38,50,68,.85);
    }
    button.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(96,165,250,.16));
      border-color: rgba(34,197,94,.35);
    }
    button.warn{
      background: linear-gradient(135deg, rgba(245,158,11,.25), rgba(239,68,68,.10));
      border-color: rgba(245,158,11,.35);
    }
    button.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
    }
    button:disabled{opacity:.45;cursor:not-allowed}

    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35}

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;
      margin-bottom:10px;
    }
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(31,41,55,.75);
      border:1px solid rgba(38,50,68,.7);
      color:#cbd5e1;
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 0 0}
    .sw{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px}
    .sw.green{background:rgba(34,197,94,.9)}
    .sw.orange{background:rgba(245,158,11,.95)}
    .sw.sel{background:rgba(96,165,250,.95)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(38,50,68,.85);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(38,50,68,.65);
      vertical-align:top;
      font-size:13px;
    }
    th{
      text-align:left;
      background: rgba(2,6,23,.45);
      color:#cbd5e1;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    tr:last-child td{border-bottom:none}

    .meta{display:flex;flex-direction:column;gap:4px}
    .sub{font-size:12px;color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(38,50,68,.7);
      background: rgba(15,23,42,.6);
      font-size:12px;color:#dbeafe;font-weight:700
    }

    .slots-wrap{overflow-x:auto}
    .slots{
      display:flex;
      gap:6px;
      width:max-content;
      padding-bottom:2px;
    }
    .slot{
      border-radius:12px;
      padding:6px 6px;
      border:1px solid rgba(38,50,68,.7);
      background: rgba(2,6,23,.35);
      user-select:none;
      cursor:pointer;
      text-align:center;
      font-weight:800;
      font-size:11px;
      line-height:1.1;
    }
    .slot .d{display:block;font-size:10px;color:#cbd5e1;font-weight:800}
    .slot .p{display:block;font-size:10px;color:var(--muted);font-weight:800;margin-top:2px}
    .slot.free{background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.40)}
    .slot.reserved{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.45)}
    .slot.selected{outline: 3px solid rgba(96,165,250,.65); background: rgba(96,165,250,.16); border-color: rgba(96,165,250,.55)}
    .slot.disabled{opacity:.35; cursor:not-allowed}

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(11,15,20,.75);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(920px, 100%);
      border-radius:18px;
      border:1px solid rgba(38,50,68,.9);
      background: linear-gradient(180deg, rgba(17,24,39,.96), rgba(15,23,42,.96));
      box-shadow: 0 24px 70px rgba(0,0,0,.5);
      overflow:hidden;
      max-height:90vh;
      display:flex;
      flex-direction:column;
    }
    .modal .hd{
      padding:14px 14px;
      border-bottom:1px solid rgba(38,50,68,.7);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background: rgba(2,6,23,.45);
    }
    .modal .hd strong{letter-spacing:.2px}
    .modal .bd{padding:14px; overflow:auto}
    .modal .ft{
      padding:14px;
      border-top:1px solid rgba(38,50,68,.7);
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      background: rgba(2,6,23,.35);
    }
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi .chip{font-weight:800}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hidden{display:none !important}
    .split{display:grid;grid-template-columns: 1fr 1fr; gap:12px}

    /* TOAST */
    .toast{
      position:fixed;
      right:18px;
      bottom:18px;
      width:min(420px, calc(100% - 36px));
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(38,50,68,.9);
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.92));
      box-shadow: 0 18px 55px rgba(0,0,0,.5);
      z-index:60;
      display:none;
    }
    .toast .ttl{font-weight:900;letter-spacing:.2px}
    .toast .msg{margin-top:4px;color:#cbd5e1;font-size:13px;line-height:1.3}
    .toast.warn{border-color: rgba(245,158,11,.55)}
    .toast.info{border-color: rgba(96,165,250,.55)}
    .toast .bar{
      height:3px;border-radius:999px;margin-top:10px;
      background: rgba(96,165,250,.55);
      width:100%;
      transform-origin:left;
      transform: scaleX(1);
    }
    .warn-text{color:var(--orange); font-weight:700}
    .tag-origem{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(239,68,68,.15);
      border:1px solid rgba(239,68,68,.45);
      color:#fecaca;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.4px;
      font-size:10px;
      margin-left:6px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
    }
      /* ===== Agenda (modelo MPV) – visual padrão (print) ===== */
      .agendaWrap{
        --left-col:260px;
        overflow-x:auto;
        overflow-y:hidden;
        max-width:100%;
        position:relative;
        padding-bottom:8px;
      }
      .scroll-mask{
        position:absolute;
        left:0;
        bottom:0;
        width:var(--left-col);
        height:18px;
        background: rgba(2,6,23,.82);
        pointer-events:none;
        z-index:5;
      }

    /* grade com linhas sutis, como no padrão do MPV */
    #agendaTable{
        background: rgba(2,6,23,.25);
        width:max-content;
        min-width:100%;
      }
    #agendaTable th, #agendaTable td{
        white-space:nowrap;
        text-align:center;
        border-right:1px solid rgba(38,50,68,.55);
      }
    #agendaTable tr > *:last-child{border-right:none}

    #agendaTable thead th{
        position:sticky; top:0; z-index:3;
        background: rgba(2,6,23,.72);
        font-weight:900;
        letter-spacing:.2px;
      }
    #agendaTable th:first-child, #agendaTable td:first-child{
      position:sticky; left:0; z-index:4;
      background: rgba(2,6,23,.82);
      text-align:left;
      min-width:100px;
      width:100px;
      max-width:100px;
      border-right:1px solid rgba(38,50,68,.7);
    }
    #agendaTable th:nth-child(2), #agendaTable td:nth-child(2){
      text-align:left;
    }

    .agCell{
      display:grid;
      gap:6px;
      min-width:90px;
      padding:2px 0;
    }

    /* chips em formato “pílula” (Manhã/Tarde + L/R) */
    .aChip{
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      border:1px solid rgba(38,50,68,.75);
      user-select:none;
      display:flex;
      justify-content:center;
      gap:8px;
      align-items:center;
      background: rgba(2,6,23,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .aChip span{display:inline-block}
    .aChip small{font-weight:1000; opacity:.95; font-size:10px}

    .aChip.L{
      background: rgba(34,197,94,.22);
      border-color: rgba(34,197,94,.65);
      cursor:pointer;
    }
    .aChip.L:hover{filter:brightness(1.07)}

    .aChip.R{
      background: rgba(245,158,11,.22);
      border-color: rgba(245,158,11,.70);
      cursor:not-allowed;
      opacity:.92;
    }
    .aChip.DB{
      background: rgba(14,165,233,.22);
      border-color: rgba(14,165,233,.85);
      cursor:pointer;
      opacity:.95;
    }
    .aChip.DB:hover{filter:brightness(1.07)}

    .aChip.sel{
      outline: 3px solid rgba(96,165,250,.65);
      border-color: rgba(96,165,250,.62);
      background: rgba(96,165,250,.16);
    }
    .multiBar{
      position:sticky;
      top:0;
      z-index:6;
      margin-top:10px;
      padding:10px 12px;
      border:1px solid rgba(38,50,68,.85);
      background: rgba(17,24,39,.92);
      backdrop-filter: blur(10px);
      border-radius:14px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .multiBar.show{display:flex}
    .multiBar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

/* ===== Modal MPV (Reservar agenda) ===== */
.modalBack{position:fixed;inset:0;background:rgba(11,15,20,.75);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
.modalBack.show{display:flex}
.modalBack .modal{
  width:min(820px,96vw);
  background: linear-gradient(180deg, rgba(17,24,39,.96), rgba(15,23,42,.96));
  border:1px solid rgba(38,50,68,.9);
  border-radius:14px;
  box-shadow:0 22px 70px rgba(0,0,0,.45);
  overflow:hidden;
  color:var(--text);
}
.modalBack .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(38,50,68,.7);background: rgba(2,6,23,.45)}
.modalBack .body{padding:14px 16px}
.modalBack .foot{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid rgba(38,50,68,.7);background: rgba(2,6,23,.35)}
.modalBack .row{display:flex;gap:14px;align-items:flex-start}
.modalBack label{display:block;margin-top:10px;margin-bottom:6px;font-weight:700}
.modalBack select,.modalBack textarea{
  width:100%;
  background: rgba(2,6,23,.55);
  color:var(--text);
  border:1px solid rgba(38,50,68,.9);
  border-radius:12px;
  padding:10px 10px;
}
.modalBack .btnRow{display:flex;gap:10px;margin-top:12px}
    .modalBack .rowItem{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid rgba(0,0,0,.08);border-radius:10px;margin-top:6px}
    .swap-option{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:8px 10px;
      border:1px solid rgba(38,50,68,.7);
      border-radius:12px;
      background: rgba(2,6,23,.35);
      cursor:pointer;
    }
    .swap-option:hover{filter:brightness(1.06)}
    .swap-option .t1{font-weight:800}
    .swap-option .t2{font-size:12px;color:var(--muted)}
    .swap-option .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 6px;border-radius:999px;
      border:1px solid rgba(38,50,68,.7);
      background: rgba(15,23,42,.6);
      font-size:11px;font-weight:700;color:#dbeafe;
    }
    .swap-bd h3{margin:0 0 8px 0}
    .swap-col{
      border:1px solid rgba(38,50,68,.7);
      border-radius:14px;
      padding:12px;
      background: rgba(2,6,23,.25);
    }
    .swap-split{gap:14px}
    .swap-options{display:grid;gap:8px}
.terceiros-list{display:grid;gap:12px;margin-top:10px}
.terceiro-card{border:1px solid rgba(38,50,68,.7);border-radius:14px;padding:12px;background: rgba(2,6,23,.35)}
.terceiro-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
.terceiro-name{font-weight:800}
.terceiro-sub{color:var(--muted);font-size:12px}
.terceiro-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.meta-pill{padding:6px 8px;border-radius:10px;background: rgba(30,41,59,.6);border:1px solid rgba(38,50,68,.7);font-size:11px}
.pack-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.pack-pill{padding:6px 8px;border-radius:10px;background: rgba(15,23,42,.7);border:1px solid rgba(38,50,68,.75);font-size:11px}
.pack-pill b{font-weight:800}
.terceiro-actions{display:flex;gap:8px;flex-wrap:wrap}
.terceiro-grid{display:grid;grid-template-columns: 320px 1fr;gap:14px;margin-top:10px}
.terceiro-pane{border:1px solid rgba(38,50,68,.7);border-radius:16px;padding:14px;background:
  radial-gradient(120% 140% at 10% 0%, rgba(34,197,94,.08), transparent 60%),
  rgba(2,6,23,.35)}
.terceiro-kicker{font-size:11px;text-transform:uppercase;letter-spacing:.3px;color:#cbd5e1;margin-bottom:6px}
.terceiro-pack-select{width:100%;min-height:220px}
.terceiro-selected{display:grid;gap:8px;margin-top:10px}
.terceiro-selected .rowItem{
  display:grid;
  grid-template-columns: 1fr 180px 90px;
  gap:10px;
  align-items:center;
  padding:8px 10px;
  border:1px solid rgba(38,50,68,.8);
  border-radius:12px;
  background: rgba(15,23,42,.55);
}
.terceiro-selected .rowItem button{justify-self:end}
.terceiro-help{font-size:12px;color:var(--muted);margin-top:8px}
.terceiro-flow{display:grid;grid-template-columns: 1fr;gap:10px}
.terceiro-badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background: rgba(96,165,250,.16);border:1px solid rgba(96,165,250,.35);font-size:11px;color:#dbeafe}
.terceiro-packs-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 6px}
.terceiro-packs-toolbar input{flex:1;min-width:180px}
.terceiro-selected .rowItem > div:first-child{max-width:none}
@media (max-width: 900px){
  .terceiro-grid{grid-template-columns:1fr}
  .terceiro-selected .rowItem{grid-template-columns: 1fr}
  .terceiro-selected .rowItem button{justify-self:start}
}
.modalidadeRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.modalidadeOption{display:flex;gap:8px;align-items:center;border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:8px 10px;cursor:pointer}
.modalidadeOption input{margin:0}

.valorHoraCell{
  background: linear-gradient(180deg, rgba(34,197,94,.12), rgba(15,23,42,.3));
  border-right:1px solid rgba(38,50,68,.6);
  width:100px;
  min-width:100px;
  max-width:100px;
  text-align:left;
  vertical-align:top;
  overflow:hidden;
}
.vh-wrap{
  display:flex;
  flex-direction:column;
  gap:3px;
  padding:6px 6px;
  border-radius:12px;
  background: rgba(2,6,23,.35);
  border:1px solid rgba(38,50,68,.6);
  align-items:flex-start;
  width:100%;
  max-width:100%;
}
.vh-label{
  font-size:10px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.3px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.vh-value{
  font-weight:900;
  font-size:12px;
  color:#d1fae5;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.consultorCell{
  text-align:left;
  vertical-align:top;
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> MVP - Alocação Agenda pelo Próprio Parceiro</div>
      <div class="tabs">
        <div class="tab active" data-tab="alocacao">Localizar Agenda Atendimento</div>
        <div class="tab" data-tab="resumo">Resumo da sua Solicitação</div>
        <div class="tab" data-tab="acompanhamento">Status de Suas Solicitações</div>
        <div class="tab-break"></div>
        <div class="tab" data-tab="validacao">Validação Torre</div>
        <div class="tab" data-tab="clt">Cadastro Recurso Sankhya</div>
        <div class="tab" data-tab="gestao">Parceiros Homologados</div>
        <div class="tab" data-tab="terceiros">Cadastro Recursos Homologados</div>
        <div class="tab" data-tab="clt-disponibilizar">Disponibilizar Recurso Sankhya para Base</div>
        <div class="tab" data-tab="valor-hora">Valor hora Vendida</div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <section id="tab-alocacao">
      <div class="grid">

        <div class="card">
          <div class="content">
            <h2>Entrada da Demanda</h2>

            <div class="row">
              <div>
                <label>Código do Parceiro</label>
                <input id="inCodCliente" placeholder="Ex: 001234" />
              </div>
              <div>
                <label>Origem da Entrada</label>
                <select id="inOrigem">
                  <option value="">Selecione</option>
                  <option>Fila Unidade - OS</option>
                  <option>Contato Direto</option>
                  <option>Gestor / Torre</option>
                  <option>Comercial</option>
                  <option>CS / Suporte</option>
                  <option>Outro</option>
                </select>
              </div>
            </div>

            <div class="row hidden" id="osRow" style="margin-top:10px">
              <div>
                <label>Número da OS</label>
                <input id="inOS" inputmode="numeric" pattern="\\d*" placeholder="Ex: 12345" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Nome do Parceiro</label>
              <input id="inNomeCliente" placeholder="Ex: Cliente XYZ" />
            </div>

            <div style="margin-top:10px">
              <label>Filial Slim</label>
              <input id="inFilial" placeholder="Ex: Filial Belo Horizonte" />
            </div>

            <div style="margin-top:10px">
                <label>Nome Usuário Solicitante</label>
              <input id="inAnalista" placeholder="Ex: Ana Flávia" />
              <div class="small muted" style="margin-top:6px">Irá trazer sempre o usuário logado.</div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Telefone contato do solicitante</label>
                <input id="inTelefoneContato" placeholder="Ex: (11) 98888-7777" />
              </div>
              <div>
                <label>Email de contato</label>
                <input id="inEmailContato" type="email" placeholder="Ex: solicitante@cliente.com" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Link da reunião (se remoto)</label>
              <input id="inLinkReuniao" placeholder="Ex: https://meet.google.com/abc-defg-hij" />
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Gerente de Relacionamento</label>
                <input id="inGerRel" placeholder="Ex: João Silva" />
              </div>
              <div>
                <label>Gerente do Sucesso Cliente</label>
                <input id="inGerCS" placeholder="Ex: Maria Souza" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Pack Relacionado</label>
              <select id="inPack">
                <option value="">Selecione</option>
                <option>5353 Análise de Crédito - Pack 4</option>
                <option>5324 Atacado / Distribuidor - Pack 1</option>
                <option>5325 Atacado / Distribuidor - Pack 2 / MDFe</option>
                <option>5309 Caixas e Bancos - Pack 1</option>
                <option>5337 Cálculo de Frete - Pack 1</option>
                <option>5356 Central de Certificação</option>
                <option>5283 Compras - Pack 1</option>
                <option>5285 Compras - Pack 3 / MD-e/DF-e</option>
                <option>5729 Compras - Pack 5 / Gestão de Verbas</option>
                <option>5354 Conciliação Bancária Automática OFX - Pack 2.1</option>
                <option>5310 Conciliação Cartões de Crédito/Débito - Pack 2</option>
                <option>5377 Contabilidade</option>
                <option>5376 Contabilização</option>
                <option>5378 Controle Patrimonial - Pack 4</option>
                <option>5284 Cotação - Pack 2</option>
                <option>5388 Dashboard (Editor de Dashboard) - Pack 4</option>
                <option>5292 Estocagem - Pack 1</option>
                <option>5316 Fiscal - Pack 1 / Livro e SPED Fiscal</option>
                <option>5317 Fiscal - Pack 2 / SPED Contribuições</option>
                <option>5318 Fiscal - Pack 3 / EFD Reinf</option>
                <option>5381 Folha - Pack 2 (Pessoal +)</option>
                <option>5382 Folha - Pack 3 (Gestão Pessoas +)</option>
                <option>5383 Folha - Pack 4 (Pessoas + App)</option>
                <option>5540 Folha - Pack 8</option>
                <option>BP</option>
              </select>
            </div>

            <div style="margin-top:10px">
              <label>Detalhamento da Demanda</label>
              <textarea id="inDetalhe" placeholder="Descreva o escopo, prioridade e observações..."></textarea>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Data Início (solicitada)</label>
                <input id="inDtIni" type="date" />
              </div>
              <div>
                <label>Data Fim (solicitada)</label>
                <input id="inDtFim" type="date" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Filtro de Recursos</label>
                <select id="inFiltroTipo">
                  <option value="TERCEIRO">Homologado</option>
                  <option value="TERCEIRO_CLT">Homologado + Recursos Sankhya</option>
                  <option value="SANKHYA">Recursos Sankhya</option>
                  <option value="BP">BP (Teste)</option>
                </select>
              </div>
              <div>
                <label>Proficiencia recurso (fila)</label>
                <select id="inFiltroSenioridade">
                  <option value="ALL">Todas</option>
                  <option value="Executor">Executor</option>
                  <option value="Autônomo">Autônomo</option>
                  <option value="Proficiente">Proficiente</option>
                  <option value="Referencia">Referencia</option>
                </select>
              </div>
            </div>

            <div class="actions">
              <button class="primary" id="btnGerarFila">Localizar Recurso</button>
              <button id="btnProximoFila">Próximo da fila</button>
              <button id="btnLimpar">Limpar</button>
            </div>

            <div id="priorityHint" class="hint" style="display:none; color:#f59e0b; font-weight:800">
              Existem recursos com prioridade (CLT DB ou Terceiro Presencial) para esta janela.
            </div>

            <div class="hint">
              <div><span class="sw green"></span><b>L</b> = Livre</div>
              <div><span class="sw orange"></span><b>R</b> = Reservado</div>
              <div><span class="sw sel"></span><b>Seleção</b>: Ctrl (multi) / Shift (intervalo)</div>
              <div class="muted" style="margin-top:8px">
                Critério de fila (score): tempo parceria + nº recursos + senioridade + ociosidade (%).
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <div class="toolbar">
              <div class="chip">Fila: <span id="kFila">0</span></div>
              <div class="chip">Elegíveis: <span id="pillCount">0</span></div>
              <div class="chip">Selecionados: <span id="kSel">0</span></div>
              <div class="chip">Janela: <span id="kJanela">—</span></div>
              <div class="chip">Consultor selecionado: <span id="kCons">—</span></div>
            </div>

              <div class="multiBar" id="multiBar">
                <div class="left">
                  <button class="warn btn-sm" id="btnReservar" disabled>Reservar agendas selecionadas</button>
                  <span class="chip">Multi seleção: <span id="multiCount">0</span></span>
                  <span class="muted small" id="multiHint">Ctrl (multi) / Shift (intervalo) • mesma pessoa</span>
                </div>
                <div class="actions tight" style="margin:0">
                  <button class="btn-sm" id="btnLimparSel" disabled>Limpar</button>
                </div>
              </div>

            <div class="agendaWrap" style="margin-top:12px">
              <div class="scroll-mask"></div>
              <table id="agendaTable">
                  <thead>
                    <tr id="theadRow">
                      <th style="min-width:240px">Consultor</th>
                    </tr>
                  </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div class="legend" style="margin-top:10px">
              <div class="chip"><span class="sw green"></span>Livre</div>
              <div class="chip"><span class="sw orange"></span>Reservado</div>
              <div class="chip"><span class="sw sel"></span>Disponibilizado para Base</div>
            </div>
            <div class="hint" style="margin-top:8px">
              <div><b>Proficiência (descrição completa):</b></div>
              <div class="small muted">Executor – Executa tarefas mais simples e rotineiras, como levantamento inicial de dados e auxílio em treinamento, seguindo processos definidos. Requer supervisão.</div>
              <div class="small muted">Autônomo – Lida com tarefas mais complexas, como análises detalhadas de processos de negócios, configuração do sistema e suporte a testes. Consegue propor soluções para problemas dentro da sua área de atuação.</div>
              <div class="small muted">Proficiente – Possui domínio técnico em uma área muito particular do sistema, atuando como referência naquele assunto específico. Foca mais na configuração, parametrização e solução de problemas técnicos pontuais dentro da sua especialidade, seguindo as diretrizes do projeto.</div>
              <div class="small muted">Referência – Além de ser especialista em alguma área, atua de forma autônoma e estratégica, comunica-se com clareza e precisão tanto com as equipes técnicas, quanto com os níveis diretivos dos clientes. Possui maturidade e experiência para resolver problemas de alta complexidade e lidar com cenários de mudança organizacional durante a implantação.</div>
            </div>

            <div class="hint">
              Regra MVP, seleção <b>somente</b> dentro do mesmo consultor. Se clicar em outro consultor, aparece aviso e a seleção atual é mantida
            </div>
          </div>
        </div>

      </div>
    </section>

    <section id="tab-gestao" class="hidden">
      <div class="grid" style="grid-template-columns: 420px 1fr; margin-top:14px;">
        <div class="card">
          <div class="content">
            <h2>Cadastro – Parceiros Homologados (Prestadores)</h2>

            <div class="row">
              <div>
                <label>Código do Parceiro</label>
                <input id="hCodigo" placeholder="Ex: 90001" />
              </div>
              <div>
                <label>Nome do Parceiro</label>
                <input id="hNome" placeholder="Ex: Parceiro Alpha" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Nº de Recursos</label>
                <input id="hRecursos" type="number" min="0" value="5" />
              </div>
              <div>
                <label>Tempo de Parceria (meses)</label>
                <input id="hTempo" type="number" min="0" value="12" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Valor Hora por Proficiência (nome reduzido)</label>
              <div class="row" style="margin-top:6px">
                <div>
                  <label>Executor</label>
                  <input id="hValorHoraExecutor" placeholder="R$ 0,00" />
                </div>
                <div>
                  <label>Autônomo</label>
                  <input id="hValorHoraAutonomo" placeholder="R$ 0,00" />
                </div>
              </div>
              <div class="row" style="margin-top:6px">
                <div>
                  <label>Proficiente</label>
                  <input id="hValorHoraProficiente" placeholder="R$ 0,00" />
                </div>
                <div>
                  <label>Referencia</label>
                  <input id="hValorHoraReferencia" placeholder="R$ 0,00" />
                </div>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Data de início da parceria</label>
              <input id="hInicio" type="date" />
            </div>

            <div class="actions">
              <button class="primary" id="btnAddHomologado">Adicionar Parceiro</button>
              <button id="btnResetHomologados">Restaurar padrão</button>
            </div>
            <div class="hint" id="homologadoHint" style="display:none">
              Parceiro já cadastrado. Revise os dados e clique em <b>Salvar alterações</b>.
            </div>

            <div class="hint">
              O cadastro de homologados influencia o score da fila.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h2>Parceiros homologados</h2>
            <div class="toolbar">
              <div class="chip">Ordem gerada: <span id="kOrdem">0</span></div>
              <button id="btnEditHomologados">Alterar Número recursos/Tempo/Data Início Parceria</button>
              <button class="primary" id="btnSaveHomologados" style="display:none">Salvar alterações</button>
            </div>
            <div class="actions" style="margin-top:10px">
              <button id="btnParamsOrdem">Cadastrar parâmetros da ordem</button>
              <button class="primary" id="btnGerarOrdem">Gerar Ordem da Fila</button>
            </div>
            <div style="overflow:auto">
              <table>
                <thead>
    <tr>
      <th>Ordem</th>
      <th>Código</th>
      <th>Parceiro</th>
      <th>Nº Recursos</th>
      <th>Tempo (meses)</th>
      <th>Valor Hora por Proficiência (E/A/P/R)</th>
      <th>Início parceria</th>
      <th style="width:120px">Ações</th>
    </tr>
                </thead>
                <tbody id="tbodyHomologados"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 420px 1fr;">
        <div class="card">
          <div class="content">
            <h2>Cadastro de Parceiros</h2>

            <div class="row">
              <div>
                <label>Código do Cliente</label>
                <input id="cCodigo" placeholder="Ex: 70784" />
              </div>
              <div>
                <label>Nome do Cliente</label>
                <input id="cNome" placeholder="Ex: DON LUCHESI & CO." />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Nome da Filial Slim</label>
              <input id="cFilial" placeholder="Ex: Filial Belo Horizonte" />
            </div>

            <div style="margin-top:10px">
              <label>Nome Analista Cliente</label>
              <input id="cAnalista" placeholder="Ex: Maria Silva" />
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Gerente de Relacionamento</label>
                <input id="cGerRel" placeholder="Ex: João Silva" />
              </div>
              <div>
                <label>Gerente do Sucesso Cliente</label>
                <input id="cGerCS" placeholder="Ex: Maria Souza" />
              </div>
            </div>

            <div class="actions">
              <button class="primary" id="btnAddCliente">Adicionar Cliente</button>
              <button class="danger" id="btnClearLocal">Limpar dados locais</button>
            </div>
            <div class="hint">
              Este botão é apenas para MVP e não estará disponível em produção.
            </div>

            <div class="hint">
              Cadastro de clientes não influencia o score da fila.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h2>Parceiros cadastrados</h2>
            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Cliente</th>
                    <th>Filial Slim</th>
                    <th>Analista</th>
                    <th>Ger. Relacionamento</th>
                    <th>Ger. Sucesso Cliente</th>
                  </tr>
                </thead>
                <tbody id="tbodyClientes"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-terceiros" class="hidden">
      <div class="grid" style="grid-template-columns: 420px 1fr; margin-top:14px;">
        <div class="card">
          <div class="content">
            <h2>Cadastro – Recurso Terceiros</h2>

            <div class="row">
              <div>
                <label>Empresa/Parceiro</label>
                <input id="tEmpresa" placeholder="Ex: Parceiro Alpha" />
              </div>
              <div>
                <label>Código do Parceiro</label>
                <input id="tCodigo" placeholder="Ex: 90001" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Nome do Recurso</label>
                <input id="tNome" placeholder="Ex: Joana Silva" />
              </div>
              <div>
                <label>Função</label>
                <input id="tFuncao" placeholder="Ex: Analista Base" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Senioridade</label>
                <select id="tSenioridade">
                  <option value="">Selecione</option>
                  <option>Junior</option>
                  <option>Pleno</option>
                  <option>Senior</option>
                  <option>Especialista</option>
                </select>
              </div>
              <div>
                <label>Modalidade</label>
                <select id="tModalidade">
                  <option value="">Selecione</option>
                  <option>PJ</option>
                  <option>CLT</option>
                  <option>Alocação por projeto</option>
                  <option>Banco de horas</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>E-mail</label>
                <input id="tEmail" type="email" placeholder="Ex: joana@parceiro.com" />
              </div>
              <div>
                <label>Telefone</label>
                <input id="tTelefone" placeholder="Ex: (11) 98888-7777" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Disponível a partir</label>
                <input id="tDisponivel" type="date" />
              </div>
              <div>
                <label>Carga semanal (h)</label>
                <input id="tCarga" type="number" min="0" value="40" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Presencial</label>
                <label class="chip" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
                  <input id="tPresencial" type="checkbox" style="margin:0" />
                  <span>Recurso presencial</span>
                </label>
              </div>
              <div class="hidden" id="tFilialRow">
                <label>Filial SLIM</label>
                <select id="tFilialSlim">
                  <option value="">Selecione</option>
                  <option>Filial Belo Horizonte</option>
                  <option>Filial Espirito Santo</option>
                  <option>Filial Brasil Central</option>
                  <option>Filial Porto Alegre</option>
                  <option>Filial Campinas</option>
                  <option>Filial São Paulo</option>
                  <option>Filial Triangulo Mineiro/Virtual</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Observações</label>
              <textarea id="tObs" placeholder="Ex: certificações, restrições, etc."></textarea>
            </div>

            <div class="actions">
              <button class="primary" id="btnAddTerceiro">Adicionar Recurso</button>
              <button id="btnResetTerceiro">Limpar</button>
            </div>
            <div class="hint">
              Cadastro de recursos terceiros para composição da demanda.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h2>Recursos cadastrados</h2>
            <div class="toolbar">
              <div class="chip">Total: <span id="terceirosCount">0</span></div>
            </div>
            <div id="terceirosList" class="terceiros-list"></div>
          </div>
        </div>
      </div>
    </section>


    <section id="tab-clt" class="hidden">
      <div class="grid" style="grid-template-columns: 420px 1fr; margin-top:14px;">
        <div class="card">
          <div class="content">
            <h2>Cadastro – Recurso Sankhya</h2>

            <div class="row">
              <div>
                <label>Nome do Recurso</label>
                <input id="cltNome" placeholder="Ex: João Pereira" />
              </div>
              <div>
                <label>Cargo</label>
                <input id="cltCargo" placeholder="Ex: Analista Base" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Senioridade</label>
                <select id="cltSenioridade">
                  <option value="">Selecione</option>
                  <option>Junior</option>
                  <option>Pleno</option>
                  <option>Senior</option>
                  <option>Especialista</option>
                </select>
              </div>
              <div>
                <label>Gestor</label>
                <input id="cltGestor" placeholder="Ex: Carla Souza" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>E-mail</label>
                <input id="cltEmail" type="email" placeholder="Ex: joao@empresa.com" />
              </div>
              <div>
                <label>Telefone</label>
                <input id="cltTelefone" placeholder="Ex: (11) 98888-7777" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Disponível a partir</label>
                <input id="cltDisponivel" type="date" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Observações</label>
              <textarea id="cltObs" placeholder="Ex: certificações, restrições, etc."></textarea>
            </div>

            <div class="actions">
              <button class="primary" id="btnAddClt">Adicionar Recurso</button>
              <button id="btnResetClt">Limpar</button>
            </div>
            <div class="hint">
              Cadastro de Recurso Sankhya para composição da demanda.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h2>Recurso Sankhya Cadastrado</h2>
            <div class="toolbar">
              <div class="chip">Total: <span id="cltCount">0</span></div>
            </div>
            <div id="cltList" class="terceiros-list"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-clt-disponibilizar" class="hidden">
      <div class="grid" style="grid-template-columns: 420px 1fr; margin-top:14px;">
        <div class="card">
          <div class="content">
            <h2>Disponibilizar Recurso Sankhya para Base</h2>

            <div class="row">
              <div>
                <label>Buscar Recurso Sankhya</label>
                <input id="cltBuscaNome" placeholder="Nome do recurso" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Data inicial</label>
                <input id="cltDtIni" type="date" />
              </div>
              <div>
                <label>Data final</label>
                <input id="cltDtFim" type="date" />
              </div>
            </div>

            <div class="actions">
              <button class="primary" id="btnCltBuscar">Buscar agenda</button>
              <button id="btnCltLimpar">Limpar</button>
            </div>

            <div class="hint">
              Selecione o Recurso Sankhya e reserve a agenda (multi-seleção com Ctrl/Shift).
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h2>Agenda Recurso Sankhya</h2>
            <div class="toolbar">
              <div class="chip">Janela: <span id="cltKJanela">—</span></div>
              <div class="chip">Selecionado: <span id="cltKCons">—</span></div>
              <div class="chip">Seleção: <span id="cltSelCount">0</span></div>
              <div class="chip">DB Selecionados: <span id="cltLbCount">0</span></div>
              <div class="chip">Recursos: <span id="cltPillCount">0</span></div>
            </div>
            <div class="actions" style="margin-top:8px">
              <button class="warn btn-sm" id="btnReservarClt" disabled>Disponibilizar agendas selecionadas</button>
              <button class="btn-sm" id="btnLimparSelClt" disabled>Limpar</button>
              <button class="danger btn-sm" id="btnRemoveLbClt" disabled>Remover DB selecionados</button>
              <button class="btn-sm" id="btnClearLbClt" disabled>Limpar DB</button>
            </div>

            <div class="agendaWrap" style="margin-top:12px">
              <div class="scroll-mask"></div>
              <table id="agendaTableClt">
                <thead>
                  <tr id="theadRowClt">
                    <th style="min-width:240px">Recurso Sankhya</th>
                  </tr>
                </thead>
                <tbody id="tbodyClt"></tbody>
              </table>
            </div>

            <div class="legend" style="margin-top:10px">
              <div class="chip"><span class="sw green"></span>Livre</div>
              <div class="chip"><span class="sw orange"></span>Reservado</div>
              <div class="chip"><span class="sw sel"></span>Disponibilizado para Base</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-valor-hora" class="hidden">
      <div class="grid" style="grid-template-columns: 1fr; margin-top:14px;">
        <div class="card">
          <div class="content">
            <h2>Valor Hora por Proficiência</h2>
            <div class="hint" style="margin-top:6px">
              Lista dos níveis de proficiência (descrição longa) encontrados no cadastro de Terceiros e CLT. Informe o valor por hora (R$).
            </div>
            <div class="toolbar" style="margin-top:10px">
              <div class="chip">Proficiências: <span id="kValorHoraCount">0</span></div>
              <button class="primary" id="btnSaveValorHoraVendida">Salvar valor hora vendida</button>
            </div>
            <div class="agendaWrap" style="margin-top:12px">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:520px">Proficiência (descrição)</th>
                    <th style="min-width:180px">Valor Hora (R$)</th>
                  </tr>
                </thead>
                <tbody id="tbodyValorHora"></tbody>
              </table>
            </div>
            <div class="hint" id="valorHoraEmpty" style="display:none;margin-top:8px">
              Nenhuma proficiência encontrada no cadastro de recursos.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-resumo" class="hidden">
      <div class="grid" style="grid-template-columns: 420px 1fr; margin-top:14px;">
        <aside class="card">
          <div class="content">
            <h2>Resumo do Cronograma</h2>

            <div class="toolbar">
              <div class="chip">Reservas (turnos): <span id="kResTurnos">0</span></div>
              <div class="chip">Reservas (requisições): <span id="kResReq">0</span></div>
            </div>

            <div class="hint" style="margin-top:10px">
              Nesta aba você visualiza as reservas geradas na Agenda e pode seguir para a validação da Torre.
            </div>

            <div class="actions" style="margin-top:12px">
              <button class="primary" id="btnResumoIrValidacao" style="width:100%">Enviar para Validação da Torre →</button>
              <button id="btnResumoVoltar" style="min-width:240px">← Voltar para Alocação</button>
              <button class="danger" id="btnResumoLimpar" style="min-width:240px">Limpar reservas</button>
            </div>

            <div class="hint">
              *MVP:* “Remoto/Presencial” aparece como “—” neste protótipo (não está capturado no fluxo atual).
            </div>
          </div>
        </aside>

        <section class="card">
          <div class="content">
            <h2>Lista de reservas</h2>

            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>SVR</th>
                    <th>Parceiro informado</th>
                    <th>Solicitação</th>
                    <th>OS</th>
                    <th>Pack</th>
                    <th>Detalhamento</th>
                    <th>Consultor</th>
                    <th>Parceiro homologado</th>
                    <th>Data início</th>
                    <th>Data fim</th>
                    <th>Período</th>
                    <th>Remoto/Presencial</th>
                    <th>Horas</th>
                    <th>Valor hora</th>
                    <th>Valor total</th>
                  </tr>
                </thead>
                <tbody id="tbodyResumo"></tbody>
              </table>
            </div>

            <div id="resumoEmpty" class="hint" style="display:none; margin-top:10px">
              Nenhuma reserva registrada ainda.
            </div>
          </div>
        </section>
      </div>
    </section>

    <section id="tab-validacao" class="hidden">
      <div class="card">
          <div class="content">
            <h2>Validação da Torre – Consultores</h2>

          <div class="toolbar">
            <div class="chip">Pendentes: <span id="kPend">0</span></div>
            <div class="chip">Aprovadas: <span id="kAp">0</span></div>
            <div class="chip">Reprovadas: <span id="kRep">0</span></div>
            <div class="chip">Taxa aprovação: <span id="kTaxa">—</span></div>
            <div class="chip">Tempo médio: <span id="kTempo">—</span></div>
            <div class="chip">
              Buscar SVR:
              <input id="validBuscaSvr" style="width:120px; margin-left:6px" placeholder="SVR-00001" />
            </div>
            <div class="chip">
              Status:
              <select id="validStatus" style="margin-left:6px">
                <option value="ALL">Todos</option>
                <option value="PENDENTE">Aguardando aprovação</option>
                <option value="APROVADA">Aprovadas</option>
                <option value="REPROVADA">Reprovadas</option>
                <option value="CANCELADA">Solicitação Cancelada</option>
                <option value="CANCELADA_FATURADA">Cancelada e Faturada</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:240px">Demanda</th>
                  <th style="min-width:180px">Consultor / Parceiro</th>
                  <th>Slots Reservados</th>
                  <th style="min-width:220px">Validação</th>
                </tr>
              </thead>
              <tbody id="tbodyValidacao"></tbody>
            </table>
          </div>

          <div class="hint">
            MVF: aprovar/reprovar muda status e mantém histórico local.
          </div>
        </div>
      </div>
    </section>

    <section id="tab-acompanhamento" class="hidden">
      <div class="card">
          <div class="content">
            <h2>Status de Suas Solicitações</h2>

            <div class="toolbar">
              <div class="chip">Aprovadas: <span id="kAcompAp">0</span></div>
              <div class="chip">Aguardando aprovação: <span id="kAcompPend">0</span></div>
              <div class="chip">Alterações da Torre: <span id="kAcompAlt">0</span></div>
              <div class="chip">
                Buscar SVR:
                <input id="acompBuscaSvr" style="width:120px; margin-left:6px" placeholder="SVR-00001" />
              </div>
              <div class="chip">
                Status:
                <select id="acompStatus" style="margin-left:6px">
                  <option value="ALL">Todos</option>
                  <option value="PENDENTE">Aguardando aprovação</option>
                  <option value="APROVADA">Aprovadas</option>
                  <option value="REPROVADA">Reprovadas</option>
                  <option value="CANCELADA">Solicitação Cancelada</option>
                  <option value="CANCELADA_FATURADA">Cancelada e Faturada</option>
                </select>
              </div>
            </div>

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>SVR</th>
                  <th style="min-width:220px">Solicitação</th>
                  <th style="min-width:200px">Consultor</th>
                  <th style="min-width:160px">Data / Período</th>
                  <th>Status</th>
                  <th>Alterações da Torre</th>
                  <th>Observação</th>
                  <th>Ação</th>
                  <th>PDF confirmação</th>
                </tr>
              </thead>
              <tbody id="tbodyAcompanhamento"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Confirmar Reserva de Agenda</strong>
      <button id="btnCloseModal">Fechar</button>
    </div>
    <div class="bd">
      <div class="split">
        <div>
          <h3>Demanda</h3>
          <div class="small muted" id="mDemanda"></div>

          <div class="kpi">
            <div class="chip">Cliente: <span id="mCliente"></span></div>
            <div class="chip">Pack: <span id="mPack"></span></div>
            <div class="chip">Origem: <span id="mOrigem"></span></div>
          </div>

          <div style="margin-top:12px">
            <label>Observação (opcional)</label>
            <textarea id="mObs" placeholder="Ex: priorizar encaixe até sexta, demanda de Base..."></textarea>
          </div>
        </div>

        <div>
          <h3>Reserva</h3>
          <div class="small muted">Consultor selecionado: <b id="mConsultor"></b></div>
          <div class="small muted">Parceiro: <b id="mParceiro"></b> • Senioridade: <b id="mSenior"></b></div>

          <div style="margin-top:12px">
            <label>Slots selecionados</label>
            <div id="mSlots" class="small" style="line-height:1.55"></div>
          </div>

          <div style="margin-top:12px" class="small muted">
            Ao confirmar, os slots viram <b>R</b> e a demanda entra em <b>Validação da Torre</b>.
          </div>
        </div>
      </div>
    </div>
    <div class="ft">
      <button id="btnCancelarModal">Cancelar</button>
      <button class="primary" id="btnConfirmarReserva">Confirmar Reserva</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="orderBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Parâmetros da Ordem da Fila</strong>
      <button id="btnCloseOrder">Fechar</button>
    </div>
    <div class="bd">
      <div class="small muted">Regra atual (ordem de prioridade)</div>
      <div id="orderSummary" style="margin-top:8px"></div>

      <div style="margin-top:14px">
        <h3>Editar regra</h3>
        <div id="orderRules"></div>
        <div class="actions" style="margin-top:10px">
          <button id="btnAddRule">Incluir nova regra</button>
        </div>
      </div>
    </div>
    <div class="ft">
      <button id="btnCancelOrder">Cancelar</button>
      <button class="primary" id="btnSaveOrder">Salvar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="swapBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Trocar agenda</strong>
      <button id="btnCloseSwap">Fechar</button>
    </div>
    <div class="bd swap-bd">
      <div class="small muted" id="swapInfo"></div>

      <div class="split swap-split" style="margin-top:10px">
        <div class="swap-col">
          <h3>Mesmo consultor</h3>
          <input id="swapConsultorId" type="hidden" />
          <div>
            <label>Consultor</label>
            <input id="swapConsultor" placeholder="Ex: João Silva" />
          </div>
          <div style="margin-top:10px">
            <label>Nova data</label>
            <input id="swapData" type="date" />
          </div>
          <div style="margin-top:10px">
            <label>Novo período</label>
            <select id="swapPeriodo">
              <option value="Manhã">Manhã</option>
              <option value="Tarde">Tarde</option>
            </select>
          </div>
          <div class="hint" style="margin-top:10px">
            Troca mantendo o mesmo consultor.
          </div>
          <div style="margin-top:12px">
            <label>Observação da troca (obrigatória)</label>
            <textarea id="swapObs" placeholder="Descreva o motivo da troca..."></textarea>
          </div>
        </div>
        <div class="swap-col">
          <h3>Outros consultores (mesma data)</h3>
          <div class="small muted">Disponíveis (L) por ordem de parceiros homologados.</div>
          <div class="actions tight" style="margin-top:8px">
            <button class="btn-sm" id="btnSwapNext">Próximo da fila</button>
            <span class="chip">Ordem: <span id="swapOrderInfo">—</span></span>
          </div>
          <div id="swapOptions" class="swap-options" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
    <div class="ft">
      <button id="btnCancelarSwap">Cancelar</button>
      <button class="primary" id="btnSalvarSwap">Salvar troca</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="infoBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Aviso</strong>
      <button id="btnCloseInfo">Fechar</button>
    </div>
    <div class="bd">
      <div id="infoMessage" style="font-size:16px; line-height:1.5"></div>
    </div>
    <div class="ft">
      <button class="primary" id="btnOkInfo">OK</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="terceiroBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Definir Proficiencia do Recurso</strong>
      <button id="btnCloseTerceiro">Fechar</button>
    </div>
    <div class="bd">
      <div class="small muted" id="terceiroInfo"></div>
      <div class="terceiro-grid">
        <div class="terceiro-pane">
          <div class="terceiro-kicker">Nível de execução</div>
          <div class="terceiro-flow">
            <div class="terceiro-badge">Etapa 1 • Escolha o nível</div>
            <label>Nível</label>
            <select id="tNivelModal"></select>
            <div class="terceiro-help">Ao selecionar packs, o nível escolhido será aplicado automaticamente. Para alterar um pack, remova e selecione novamente.</div>
          </div>
        </div>
        <div class="terceiro-pane">
          <div class="terceiro-kicker">Packs certificados</div>
          <div class="terceiro-flow">
            <div class="terceiro-badge">Etapa 2 • Selecione packs</div>
            <label>Selecione um ou mais packs</label>
            <select id="tPackModal" multiple class="terceiro-pack-select"></select>
            <div class="terceiro-help">Use Ctrl/Shift para multiseleção.</div>
            <div id="terceiroSelecionados" class="terceiro-selected"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="ft">
      <button id="btnCancelarTerceiro">Cancelar</button>
      <button class="primary" id="btnSalvarTerceiro">Salvar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="cltReserveBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Disponibilizar Agenda Recurso Sankhya para Base</strong>
      <button id="btnCloseCltReserve">Fechar</button>
    </div>
    <div class="bd">
      <div class="small muted" id="cltReserveInfo"></div>
      <div style="margin-top:10px">
        <label>Slots selecionados</label>
        <div id="cltReserveSlots" class="small" style="line-height:1.6"></div>
      </div>
    </div>
    <div class="ft">
      <button id="btnCancelCltReserve">Cancelar</button>
      <button class="primary" id="btnConfirmCltReserve">Disponibilizar Agenda Base</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="cltManageBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Disponibilizado para Base (DB)</strong>
      <button id="btnCloseCltManage">Fechar</button>
    </div>
    <div class="bd">
      <div class="small muted" id="cltManageInfo"></div>
      <div style="margin-top:10px">
        Deseja manter ou remover a disponibilização para Base deste slot?
      </div>
    </div>
    <div class="ft">
      <button id="btnKeepCltManage">Manter Disponibilização Base</button>
      <button class="danger" id="btnRemoveCltManage">Remover Disponibilização Base</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="cancelBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Confirmar Cancelamento</strong>
      <button id="btnCloseCancel">Fechar</button>
    </div>
    <div class="bd">
      <div class="small muted" id="cancelMsg">Deseja confirmar o cancelamento?</div>
      <div class="small" id="cancelWarn" style="margin-top:8px; color:#f59e0b; font-weight:800; display:none">
        O prazo de cancelamento já passou. As horas serão faturadas conforme contrato.
      </div>
    </div>
    <div class="ft">
      <button id="btnCancelNo">Não</button>
      <button class="danger" id="btnCancelYes">Sim, cancelar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast warn" id="toast">
  <div class="ttl" id="toastTtl">Aviso</div>
  <div class="msg" id="toastMsg">Mensagem</div>
  <div class="bar" id="toastBar"></div>
</div>

<script>
const DEFAULT_CLIENTS = [
  { code: "70764", name: "ANA FLÁVIA", analista: "ANA FLÁVIA" },
  { code: "70784", name: "DON LUCHESI & CO. Filial Slim Filial Belo Horizonte", analista: "ANA FLÁVIA" },
  { code: "28370", name: "VCEDU SERVICOS TECNOLOGICOS LTDA Filial Slim Filial Triangulo Mineiro" },
  { code: "29514", name: "COPLAST Filial Slim Filial Triangulo Mineiro" },
  { code: "20227", name: "BISCOITOS BARBIERI Filial Slim Filial Virtual" },
  { code: "1494", name: "DIMEX DO TRIANGULO LTDA Filial Slim Filial Belo Horizonte", analista: "ANA FLÁVIA" },
  { code: "65883", name: "LEONARDO RODRIGUES LOPES Filial Slim Filial Triangulo Mineiro" },
  { code: "7121", name: "AUTO PECAS QUIRINÓPOLIS Filial Slim Filial Triangulo Mineiro" },
  { code: "12582", name: "EXTRAFRUTI S A COMERCIO DE HORTIFRUTIGRA Filial Slim Filial Espirito Santo" },
  { code: "14841", name: "HUMAN DO BRASIL Filial Slim Filial Espirito Santo" },
  { code: "34439", name: "CERAMICA XINGU Filial Slim Filial Virtual" },
  { code: "01010", name: "EMPRESA TESTE Filial Slim Filial Campinas" },
  { code: "02020", name: "EMPRESA TESTE 2 Filial Slim Filial Brasil Central" },
  { code: "35141", name: "COAGRIL Filial Slim - Filial Brasil Central" },
  { code: "30932", name: "VEGAN DO BRASIL INDUSTRIA DE COSMETICOS Filial Slim - Filial Paulista" },
];

const DEFAULT_HOMOLOGADOS = [
  { name: "ALIBERTI CONSULTORIA TECNOLOGICA", resources: 5, months: 12 },
  { name: "BOLT CONSULTORIA E SERVIÇOS LTDA", resources: 21, months: 12 },
  { name: "BRAION SOLUCOES GERENCIAIS LTDA", resources: 12, months: 12 },
  { name: "DEV STUDIOS TECNOLOGIA", resources: 6, months: 12 },
  { name: "DHARA TECNOLOGIA", resources: 19, months: 12 },
  { name: "ENCODE GESTAO E TECNOLOGIA", resources: 4, months: 12 },
  { name: "HERO1 TECNOLOGIA E NEGOCIOS LTDA", resources: 8, months: 12 },
  { name: "PEC TECNOLOGIA LTDA", resources: 5, months: 12 },
  { name: "PWN SERVICOS EM TECNOLOGIA E SISTEMAS LTDA", resources: 8, months: 12 },
  { name: "ZAYA TECNOLOGIA LTDA", resources: 16, months: 12 },
  { name: "UDAYA", resources: 7, months: 12 },
  { name: "EVO NETWORK", resources: 7, months: 12 },
  { name: "ELSE SOLUCION", resources: 9, months: 12 },
  { name: "BHZ", resources: 10, months: 12 },
];

const PROF_LABELS = ["Executor","Autônomo","Proficiente","Referencia"];

function emptyValorHoraByProf(){
  return {
    Executor: 0,
    "Autônomo": 0,
    Proficiente: 0,
    Referencia: 0
  };
}

function normalizeProfShortLabel(label){
  const raw = String(label || "").trim();
  if(!raw || raw === "—") return "";
  const clear = raw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  if(clear.startsWith("exec")) return "Executor";
  if(clear.startsWith("auto")) return "Autônomo";
  if(clear.startsWith("prof")) return "Proficiente";
  if(clear.startsWith("ref")) return "Referencia";
  return raw;
}

function buildPartnerRateMap(raw, legacySingleValue = 0){
  const map = emptyValorHoraByProf();
  const source = raw && typeof raw === "object" ? raw : {};
  Object.entries(source).forEach(([k, v]) => {
    const short = normalizeProfShortLabel(shortNivelLabel(String(k || "")));
    if(PROF_LABELS.includes(short)){
      map[short] = Number(v) || 0;
    }
  });
  const fallback = Number(legacySingleValue) || 0;
  if(fallback > 0 && PROF_LABELS.every(x => (Number(map[x]) || 0) <= 0)){
    PROF_LABELS.forEach(x => { map[x] = fallback; });
  }
  return map;
}

function partnerRateSummary(valorHoraByProf){
  const map = buildPartnerRateMap(valorHoraByProf);
  const ex = map.Executor > 0 ? formatBRL(map.Executor) : "—";
  const au = map["Autônomo"] > 0 ? formatBRL(map["Autônomo"]) : "—";
  const pr = map.Proficiente > 0 ? formatBRL(map.Proficiente) : "—";
  const rf = map.Referencia > 0 ? formatBRL(map.Referencia) : "—";
  return `E: ${ex} | A: ${au} | P: ${pr} | R: ${rf}`;
}

const DEFAULT_TERCEIROS = [
  {
    empresa: "ALIBERTI CONSULTORIA TECNOLOGICA",
    codigo: "90001",
    nome: "RIBEIRO SOUZA",
    funcao: "Analista Base",
    senioridade: "Pleno",
    modalidade: "PJ",
    email: "ribeiro@aliberti.com",
    telefone: "(31) 98888-0001",
    disponivel: "",
    carga: 40,
    presencial: true,
    filialSlim: "Filial Belo Horizonte",
    obs: "",
    packLevels: [
      { pack: "5353 Análise de Crédito - Pack 4", nivel: "Autônomo - Lida com tarefas mais complexas, como analises detalhadas de processos de negocios, configuração do sistema e suporte a testes. Consegue propor soluções para problemas dentro da sua área de atuação." },
      { pack: "5309 Caixas e Bancos - Pack 1", nivel: "Executor - Executa tarefas mais simples e rotineiras, como levantamento inicial de dados e auxilio em treinamento, seguindo processos definidos. Requer supervisão." }
    ]
  },
  {
    empresa: "BOLT CONSULTORIA E SERVIÇOS LTDA",
    codigo: "90002",
    nome: "JULIANA FERNANDES",
    funcao: "Especialista Fiscal",
    senioridade: "Senior",
    modalidade: "PJ",
    email: "juliana@bolt.com",
    telefone: "(11) 98888-0002",
    disponivel: "",
    carga: 40,
    presencial: false,
    filialSlim: "",
    obs: "",
    packLevels: [
      { pack: "5316 Fiscal - Pack 1 / Livro e SPED Fiscal", nivel: "Proficiente - Possui dominio tecnico em uma área muito particular do sistema, atuando como referencia naquele assunto especifico. Foca mais na configuração, parametrização e solução de problemas tecnicos pontuais dentro da sua especialidade, seguindo as diretrizes do projeto." }
    ]
  },
  {
    empresa: "BP",
    codigo: "90003",
    nome: "Recurso BP Curitiba",
    funcao: "Consultor BP",
    senioridade: "Pleno",
    modalidade: "PJ",
    email: "bp.curitiba@bp.com",
    telefone: "(41) 98888-0003",
    disponivel: "",
    carga: 40,
    presencial: true,
    filialSlim: "Filial Curitiba",
    obs: "Recurso de teste BP",
    packLevels: [
      { pack: "5309 Caixas e Bancos - Pack 1", nivel: "Executor - Executa tarefas mais simples e rotineiras, como levantamento inicial de dados e auxilio em treinamento, seguindo processos definidos. Requer supervisão." }
    ]
  },
  {
    empresa: "BP",
    codigo: "90004",
    nome: "Recurso BP Sorocaba",
    funcao: "Consultor BP",
    senioridade: "Pleno",
    modalidade: "PJ",
    email: "bp.sorocaba@bp.com",
    telefone: "(15) 98888-0004",
    disponivel: "",
    carga: 40,
    presencial: true,
    filialSlim: "Filial Sorocaba",
    obs: "Recurso de teste BP",
    packLevels: [
      { pack: "5309 Caixas e Bancos - Pack 1", nivel: "Autônomo - Lida com tarefas mais complexas, como analises detalhadas de processos de negocios, configuração do sistema e suporte a testes. Consegue propor soluções para problemas dentro da sua área de atuação." }
    ]
  },
  {
    empresa: "BP",
    codigo: "90005",
    nome: "FLAVIO.CARVALHO",
    funcao: "Consultor BP",
    senioridade: "Pleno",
    modalidade: "PJ",
    email: "flavio.carvalho@bp.com",
    telefone: "(41) 98888-0005",
    disponivel: "",
    carga: 40,
    presencial: true,
    filialSlim: "Filial Curitiba",
    obs: "Recurso BP Curitiba cadastrado para teste",
    packLevels: [
      { pack: "5309 Caixas e Bancos - Pack 1", nivel: "Executor - Executa tarefas mais simples e rotineiras, como levantamento inicial de dados e auxilio em treinamento, seguindo processos definidos. Requer supervisão." }
    ]
  },
  {
    empresa: "BP",
    codigo: "90006",
    nome: "GUILHERME.FERREIRA",
    funcao: "Consultor BP",
    senioridade: "Pleno",
    modalidade: "PJ",
    email: "guilherme.ferreira@bp.com",
    telefone: "(41) 98888-0006",
    disponivel: "",
    carga: 40,
    presencial: true,
    filialSlim: "Filial Curitiba",
    obs: "Recurso BP Curitiba cadastrado para teste",
    packLevels: [
      { pack: "5309 Caixas e Bancos - Pack 1", nivel: "Autônomo - Lida com tarefas mais complexas, como analises detalhadas de processos de negocios, configuração do sistema e suporte a testes. Consegue propor soluções para problemas dentro da sua área de atuação." }
    ]
  }
];

const DEFAULT_CLT = [
  {
    nome: "CARLA RIBEIRO",
    cargo: "Consultora Base",
    senioridade: "Senior",
    gestor: "MARTA LIMA",
    email: "carla.ribeiro@empresa.com",
    telefone: "(11) 98888-1111",
    disponivel: "",
    obs: "",
    packLevels: [
      { pack: "5309 Caixas e Bancos - Pack 1", nivel: "Autônomo - Lida com tarefas mais complexas, como analises detalhadas de processos de negocios, configuração do sistema e suporte a testes. Consegue propor soluções para problemas dentro da sua área de atuação." }
    ]
  },
  {
    nome: "DIEGO MARTINS",
    cargo: "Consultor Fiscal",
    senioridade: "Pleno",
    gestor: "MARTA LIMA",
    email: "diego.martins@empresa.com",
    telefone: "(11) 98888-2222",
    disponivel: "",
    obs: "",
    packLevels: [
      { pack: "5317 Fiscal - Pack 2 / SPED Contribuições", nivel: "Executor - Executa tarefas mais simples e rotineiras, como levantamento inicial de dados e auxilio em treinamento, seguindo processos definidos. Requer supervisão." }
    ]
  }
];

function buildDefaultTerceiros(){
  return DEFAULT_TERCEIROS.map(t => ({
    id: crypto.randomUUID(),
    empresa: t.empresa || "",
    codigo: t.codigo || "",
    nome: t.nome || "",
    funcao: t.funcao || "",
    senioridade: t.senioridade || "",
    modalidade: t.modalidade || "",
    email: t.email || "",
    telefone: t.telefone || "",
    disponivel: t.disponivel || "",
    carga: Number(t.carga) || 0,
    presencial: t.presencial === true,
    filialSlim: t.filialSlim || "",
    obs: t.obs || "",
    packLevels: Array.isArray(t.packLevels) ? t.packLevels.filter(x => x && x.pack) : []
  }));
}

function buildDefaultClt(){
  return DEFAULT_CLT.map(c => ({
    id: crypto.randomUUID(),
    nome: c.nome || "",
    cargo: c.cargo || "",
    senioridade: c.senioridade || "",
    gestor: c.gestor || "",
    email: c.email || "",
    telefone: c.telefone || "",
    disponivel: c.disponivel || "",
    obs: c.obs || "",
    packLevels: Array.isArray(c.packLevels) ? c.packLevels.filter(x => x && x.pack) : []
  }));
}

function splitClientName(name){
  const raw = name || "";
  const marker = /filial\s+slim/i;
  const m = raw.match(marker);
  if(!m) return { name: raw.trim(), filial: "" };
  const idx = m.index ?? raw.length;
  const left = raw.slice(0, idx).trim();
  let right = raw.slice(idx).replace(marker, "").trim();
  if(right.toLowerCase().startsWith("filial ")){
    right = right.replace(/^filial\s+/i, "").trim();
  }
  return { name: left, filial: right };
}

const state = {
  clients: DEFAULT_CLIENTS.map(c => {
    const parts = splitClientName(c.name);
    return {
      id: crypto.randomUUID(),
      code: c.code,
      name: parts.name || c.name,
      filial: parts.filial || c.filial || "",
      analista: c.analista || "",
      gerenteRel: c.gerenteRel || "",
      gerenteCS: c.gerenteCS || ""
    };
  }),
  homologados: DEFAULT_HOMOLOGADOS.map(h => ({
    id: crypto.randomUUID(),
    code: h.code || null,
    name: h.name,
    resources: h.resources || 0,
    months: h.months || 0,
    valorHora: Number(h.valorHora) || 0,
    valorHoraByProf: buildPartnerRateMap(h.valorHoraByProf, Number(h.valorHora) || 0),
    inicio: h.inicio || "",
    orderRank: null
  })),
  terceiros: buildDefaultTerceiros(),
  clt: buildDefaultClt(),
  cltConsultants: [],
  cltSelected: { consultantId: null, slotKeys: new Set(), lastIndex: null, lastConsultantId: null },
  cltSelectedLb: { consultantId: null, slotKeys: new Set(), lastIndex: null, lastConsultantId: null },
  cltAgenda: {},
  valorHora: {},
  pendingThirdSelection: null,
  pendingReserveAfterInfo: false,
  priorityChecked: false,
  editing: { clienteId: null, homologadoId: null },
  orderRules: [
    { field: "resources", dir: "desc" },
    { field: "months", dir: "desc" }
  ],
  lastOrderCount: 0,
  currentPartnerIndex: 0,
  svrSeq: 0,
  lastHomologadoWarn: "",
  editModeHomologados: false,
  homologadosDirty: false,
  orderPrompted: false,
  swapPartnerIndex: 0,
  consultants: [],
  reservations: [],
  selected: { consultantId: null, slotKeys: new Set(), lastIndex: null },
  modalContext: null
};
state.swapContext = null;

const STORAGE_KEY = "mvf-demanda-base:v1";

const $$ = (id) => document.getElementById(id);

const fmtDate = (d) => {
  const x = new Date(d);
  const dd = String(x.getDate()).padStart(2,'0');
  const mm = String(x.getMonth()+1).padStart(2,'0');
  const yy = x.getFullYear();
  return `${dd}/${mm}/${yy}`;
};
const addDays = (date, n) => { const d = new Date(date); d.setDate(d.getDate()+n); return d; };
const dayKey = (d) => new Date(d).toISOString().slice(0,10);

function normalizeFilial(v){
  return String(v || "").toLowerCase().replace(/\s+/g," ").trim();
}

function normalizePriorityAvail(value){
  if(!value) return [];
  if(Array.isArray(value)) return value.filter(Boolean);
  if(typeof value === "string") return [value];
  if(typeof value === "object"){
    return Object.keys(value).filter(k => value[k]);
  }
  return [];
}

function getKnowledgeLabel(c){
  const packNeed = $$("inPack")?.value.trim() || "";
  if(c.type === "CLT-DB"){
    const res = state.clt.find(x=>x.id===c.id);
    if(res && packNeed){
      const lvl = (res.packLevels || []).find(p => p.pack === packNeed)?.nivel || "";
      return shortNivelLabel(lvl) || "—";
    }
    return "—";
  }
  if(c.type === "TERCEIRO-PRESENCIAL"){
    const res = state.terceiros.find(x=>x.id===c.id);
    if(res && packNeed){
      const lvl = (res.packLevels || []).find(p => p.pack === packNeed)?.nivel || "";
      return shortNivelLabel(lvl) || "—";
    }
    return "—";
  }
  if(c.profShort) return c.profShort;
  return "—";
}

function getConsultorTypeLabel(c){
  if(c.type === "CLT-DB") return "RECURSO SANKHYA";
  if(c.type === "TERCEIRO-PRESENCIAL") return "HOMOLOGADO-PRESENCIAL FILIAL SLIM";
  if(c.type === "TERCEIRO") return "HOMOLOGADO";
  return c.type || "—";
}

function fmtDateSafe(d){
  if(!d) return "—";
  const x = new Date(d);
  if(isNaN(x)) return "—";
  const dd = String(x.getDate()).padStart(2,'0');
  const mm = String(x.getMonth()+1).padStart(2,'0');
  const yy = x.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function statusLabel(s){
  if(s === "APROVADA") return "Aprovada";
  if(s === "REPROVADA") return "Reprovada";
  if(s === "CANCELADA") return "Solicitação Cancelada";
  if(s === "CANCELADA_FATURADA") return "Cancelada e Faturada";
  return "Aguardando aprovação";
}

function updateOsVisibility(){
  const origem = $$("inOrigem").value.trim();
  const row = $$("osRow");
  if(!row) return;
  const show = origem === "Fila Unidade - OS";
  row.classList.toggle("hidden", !show);
  if(!show) $$("inOS").value = "";
}

function setTodayIfEmpty(){
  const el = $$("inDtIni");
  if(!el) return;
  if(!el.value){
    const today = new Date();
    el.value = today.toISOString().slice(0,10);
  }
}

function setFimFromInicio(){
  const ini = $$("inDtIni")?.value;
  const fimEl = $$("inDtFim");
  if(!ini || !fimEl) return;
  const d = new Date(ini);
  if(isNaN(d)) return;
  d.setDate(d.getDate() + 4);
  fimEl.value = d.toISOString().slice(0,10);
}

function setCltDatesDefault(){
  const iniEl = $$("cltDtIni");
  const fimEl = $$("cltDtFim");
  if(!iniEl || !fimEl) return;
  const today = new Date();
  if(!iniEl.value){
    iniEl.value = today.toISOString().slice(0,10);
  }
  if(!fimEl.value){
    const d = new Date(iniEl.value || today);
    if(!isNaN(d)){
      d.setDate(d.getDate() + 7);
      fimEl.value = d.toISOString().slice(0,10);
    }
  }
}

function readStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch {
    return null;
  }
}

function saveState(){
  const data = {
    clients: state.clients,
    homologados: state.homologados,
    terceiros: state.terceiros,
    clt: state.clt,
    cltAgenda: state.cltAgenda,
    valorHora: state.valorHora,
    orderRules: state.orderRules,
    lastOrderCount: state.lastOrderCount,
    svrSeq: state.svrSeq,
    reservations: state.reservations,
    demandaForm: {
      codCliente: $$("inCodCliente").value.trim(),
      nomeCliente: $$("inNomeCliente").value.trim(),
      filial: $$("inFilial").value.trim(),
      analista: $$("inAnalista").value.trim(),
      telefoneContato: $$("inTelefoneContato").value.trim(),
      emailContato: $$("inEmailContato").value.trim(),
      linkReuniao: $$("inLinkReuniao").value.trim(),
      gerenteRel: $$("inGerRel").value.trim(),
      gerenteCS: $$("inGerCS").value.trim(),
      origem: $$("inOrigem").value,
      pack: $$("inPack").value.trim(),
      detalhe: $$("inDetalhe").value.trim(),
      osNumero: $$("inOS").value.trim(),
      dtIni: $$("inDtIni").value,
      dtFim: $$("inDtFim").value,
      filtroTipo: $$("inFiltroTipo").value,
      filtroSenioridade: $$("inFiltroSenioridade").value
    }
  };
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch {
    // ignore storage errors (quota / private mode)
  }
}

function normalizeLoaded(data){
  if(Array.isArray(data.clients) && data.clients.length){
    state.clients = data.clients.map(c => ({
      id: c.id || crypto.randomUUID(),
      code: c.code || null,
      name: c.filial ? (c.name || "Cliente") : (splitClientName(c.name || "").name || "Cliente"),
      filial: c.filial || splitClientName(c.name || "").filial || "",
      analista: c.analista || "",
      gerenteRel: c.gerenteRel || "",
      gerenteCS: c.gerenteCS || ""
    }));
  } else if(Array.isArray(data.partners) && data.partners.length){
    // compatibilidade com versão antiga (partners => clients)
    state.clients = data.partners.map(c => ({
      id: c.id || crypto.randomUUID(),
      code: c.code || null,
      name: c.filial ? (c.name || "Cliente") : (splitClientName(c.name || "").name || "Cliente"),
      filial: c.filial || splitClientName(c.name || "").filial || "",
      analista: c.analista || "",
      gerenteRel: c.gerenteRel || "",
      gerenteCS: c.gerenteCS || ""
    }));
  }

  if(Array.isArray(data.homologados) && data.homologados.length){
    state.homologados = data.homologados.map(h => ({
      id: h.id || crypto.randomUUID(),
      code: h.code || null,
      name: h.name || "Parceiro",
      resources: Number(h.resources) || 0,
      months: Number(h.months) || 0,
      valorHora: Number(h.valorHora) || 0,
      valorHoraByProf: buildPartnerRateMap(h.valorHoraByProf, Number(h.valorHora) || 0),
      inicio: h.inicio || "",
      orderRank: Number.isFinite(h.orderRank) ? h.orderRank : null
    }));
  }

  if(Array.isArray(data.terceiros)){
    if(data.terceiros.length){
      state.terceiros = data.terceiros.map(t => ({
        id: t.id || crypto.randomUUID(),
        empresa: t.empresa || "",
        codigo: t.codigo || "",
        nome: t.nome || "",
        funcao: t.funcao || "",
        senioridade: t.senioridade || "",
        modalidade: t.modalidade || "",
        email: t.email || "",
        telefone: t.telefone || "",
        disponivel: t.disponivel || "",
        carga: Number(t.carga) || 0,
        presencial: t.presencial === true,
        filialSlim: t.filialSlim || "",
        obs: t.obs || "",
        packLevels: Array.isArray(t.packLevels)
          ? t.packLevels.filter(x => x && x.pack)
          : (Array.isArray(t.packs)
              ? t.packs.filter(Boolean).map(p => ({ pack: p, nivel: t.nivel || "" }))
              : (t.pack ? [{ pack: t.pack, nivel: t.nivel || "" }] : []))
      }));
    } else {
      state.terceiros = [];
    }
  }

  if(Array.isArray(data.clt)){
    if(data.clt.length){
      state.clt = data.clt.map(c => ({
        id: c.id || crypto.randomUUID(),
        nome: c.nome || "",
        cargo: c.cargo || "",
        senioridade: c.senioridade || "",
        gestor: c.gestor || "",
        email: c.email || "",
        telefone: c.telefone || "",
        disponivel: c.disponivel || "",
        obs: c.obs || "",
        packLevels: Array.isArray(c.packLevels) ? c.packLevels.filter(x => x && x.pack) : []
      }));
    } else {
      state.clt = [];
    }
  }
  if(data.cltAgenda && typeof data.cltAgenda === "object"){
    state.cltAgenda = data.cltAgenda || {};
  }
  if(data.valorHora && typeof data.valorHora === "object"){
    state.valorHora = Object.fromEntries(
      Object.entries(data.valorHora).map(([k,v]) => [String(k), Number(v) || 0])
    );
  }

  if(Array.isArray(data.reservations)){
    state.reservations = data.reservations.map(r => ({
      ...r,
      id: r.id || crypto.randomUUID(),
      demanda: {
        ...r.demanda,
        createdAt: r.demanda?.createdAt || new Date().toISOString()
      },
      validatedAt: r.validatedAt || null,
      validatorNote: r.validatorNote || "",
      towerChanges: Number.isFinite(r.towerChanges) ? r.towerChanges : 0,
      lastTowerChange: r.lastTowerChange || null,
      pendingSwap: r.pendingSwap || null,
      swapHistory: Array.isArray(r.swapHistory) ? r.swapHistory : [],
      prioridadeDisponivel: normalizePriorityAvail(r.prioridadeDisponivel),
      sentToTower: r.sentToTower === true,
      pdfConfirmed: r.pdfConfirmed === true
    }));
  }

  if(Array.isArray(data.orderRules) && data.orderRules.length){
    state.orderRules = data.orderRules.map(r => ({
      field: r.field,
      dir: r.dir === "asc" ? "asc" : "desc"
    }));
  }
  if(Number.isFinite(data.lastOrderCount)){
    state.lastOrderCount = data.lastOrderCount;
  }
  if(Number.isFinite(data.svrSeq)){
    state.svrSeq = data.svrSeq;
  }
}

function loadState(){
  const data = readStorage();
  if(!data){
    setTodayIfEmpty();
    setFimFromInicio();
    saveState();
    return;
  }
  normalizeLoaded(data);
  if(data.demandaForm){
    $$("inCodCliente").value = data.demandaForm.codCliente || "";
    $$("inNomeCliente").value = data.demandaForm.nomeCliente || "";
    $$("inFilial").value = data.demandaForm.filial || "";
    $$("inAnalista").value = data.demandaForm.analista || "";
    $$("inTelefoneContato").value = data.demandaForm.telefoneContato || "";
    $$("inEmailContato").value = data.demandaForm.emailContato || "";
    $$("inLinkReuniao").value = data.demandaForm.linkReuniao || "";
    $$("inGerRel").value = data.demandaForm.gerenteRel || "";
    $$("inGerCS").value = data.demandaForm.gerenteCS || "";
    $$("inOrigem").value = data.demandaForm.origem || "";
    $$("inPack").value = data.demandaForm.pack || "";
    $$("inDetalhe").value = data.demandaForm.detalhe || "";
    $$("inOS").value = data.demandaForm.osNumero || "";
    $$("inDtIni").value = data.demandaForm.dtIni || "";
    $$("inDtFim").value = data.demandaForm.dtFim || "";
    $$("inFiltroTipo").value = data.demandaForm.filtroTipo || "TERCEIRO";
    $$("inFiltroSenioridade").value = data.demandaForm.filtroSenioridade || "ALL";
  }
  updateOsVisibility();
  setTodayIfEmpty();
  setFimFromInicio();
}

function toast(title, msg, type="warn", ms=2600){
  const el = $$("toast");
  el.classList.remove("warn","info");
  el.classList.add(type);
  $$("toastTtl").textContent = title;
  $$("toastMsg").textContent = msg;
  el.style.display = "block";

  const bar = $$("toastBar");
  bar.style.transition = "none";
  bar.style.transform = "scaleX(1)";
  bar.offsetHeight; // reflow
  bar.style.transition = `transform ${ms}ms linear`;
  bar.style.transform = "scaleX(0)";

  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ el.style.display="none"; }, ms);
}

function formatBRL(value){
  const n = Number(value) || 0;
  return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}
function parseBRL(raw){
  const digits = String(raw || "").replace(/\D/g, "");
  if(!digits) return null;
  return Number(digits) / 100;
}

function showTab(tab){
  document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
  const t = document.querySelector(`.tab[data-tab="${tab}"]`);
  if(t) t.classList.add("active");

  const map = [
    ["tab-alocacao","alocacao"],
    ["tab-gestao","gestao"],
    ["tab-terceiros","terceiros"],
    ["tab-clt","clt"],
    ["tab-clt-disponibilizar","clt-disponibilizar"],
    ["tab-valor-hora","valor-hora"],
    ["tab-validacao","validacao"],
    ["tab-resumo","resumo"],
    ["tab-acompanhamento","acompanhamento"]
  ];
  map.forEach(([id, key]) => {
    const el = $$(id);
    if(el) el.classList.toggle("hidden", tab !== key);
  });

  if(tab === "gestao"){
    renderClientes();
    renderHomologados();
  }
  if(tab === "terceiros") renderTerceiros();
  if(tab === "clt") renderClt();
  if(tab === "clt-disponibilizar"){
    setCltDatesDefault();
    renderCltFila();
  }
  if(tab === "valor-hora") renderValorHora();
  if(tab === "resumo") renderResumo();
  if(tab === "validacao") renderValidation();
  if(tab === "acompanhamento") renderAcompanhamento();
}

document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => showTab(t.dataset.tab));
});

document.addEventListener("input", (e)=>{
  const el = e.target;
  if(!el) return;
  if(el.dataset.money === "valor-hora"){
    const pack = el.dataset.pack;
    if(!pack) return;
    const value = parseBRL(el.value);
    if(value === null){
      delete state.valorHora[pack];
      el.value = "";
      saveState();
      return;
    }
    state.valorHora[pack] = value;
    el.value = formatBRL(value);
    saveState();
    return;
  }
  if([
    "hValorHoraExecutor",
    "hValorHoraAutonomo",
    "hValorHoraProficiente",
    "hValorHoraReferencia"
  ].includes(el.id)){
    const value = parseBRL(el.value);
    if(value === null){
      el.value = "";
      return;
    }
    el.value = formatBRL(value);
  }
});

function validateDemandaInputs(){
  const cod = $$("inCodCliente").value.trim();
  const nome = $$("inNomeCliente").value.trim();
  const origem = $$("inOrigem").value.trim();
  const pack = $$("inPack").value.trim();
  const osNumero = $$("inOS").value.trim();
  const di = $$("inDtIni").value;
  const df = $$("inDtFim").value;
  if(!cod || !nome || !origem || !pack || !di || !df) return { ok:false, msg:"Preencha todos os campos da demanda." };
  if(origem === "Fila Unidade - OS" && !osNumero) return { ok:false, msg:"Informe o número da OS." };
  if(new Date(df) < new Date(di)) return { ok:false, msg:"Data fim não pode ser menor que data início." };
  return { ok:true };
}

function makeSlotsWindow(dtIni, dtFim){
  const start = new Date(dtIni);
  const end = new Date(dtFim);
  const days = [];
  let cur = new Date(start);
  while(cur <= end){
    days.push(new Date(cur));
    cur = addDays(cur, 1);
  }
  const slots = [];
  days.forEach(d => {
    const k = dayKey(d);
    slots.push({ day:k, label:`${fmtDate(d)} • Manhã`, period:"Manhã" });
    slots.push({ day:k, label:`${fmtDate(d)} • Tarde`, period:"Tarde" });
  });
  return slots;
}

function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function seniorRank(s){ return s==="Senior" ? 3 : s==="Pleno" ? 2 : 1; }

function partnerById(id){ return state.homologados.find(p=>p.id===id); }

// ======= SCORE REAL (melhoria #1)
// pesos simples (MVF): meses (0..40) + recursos (0..30) + senioridade (0..20) + ociosidade (0..10)
function calcScore({ partnerMonths, partnerResources, seniority, idlePct }){
  const m = Math.min(partnerMonths, 40);
  const r = Math.min(partnerResources, 30);
  const s = seniorRank(seniority) * 6; // Junior=6, Pleno=12, Senior=18 (cap ~20)
  const i = Math.min(Math.max(idlePct,0), 100) / 10; // 0..10
  return Math.round((m + r + s + i) * 10) / 10; // 1 casa
}

function getOrderedHomologados(){
  return state.homologados
    .filter(p => Number.isFinite(p.orderRank))
    .slice()
    .sort((a,b)=> a.orderRank - b.orderRank);
}

function getPartnerOrderByName(name){
  if(!name) return null;
  const p = state.homologados.find(h => (h.name || "").toLowerCase() === String(name).toLowerCase());
  return p ? p.orderRank : null;
}

function getCurrentExpectedOrder(){
  const ordered = getOrderedHomologados();
  return ordered.length ? ordered[0].orderRank : null;
}

function nextSvr(){
  state.svrSeq = (state.svrSeq || 0) + 1;
  return `SVR-${String(state.svrSeq).padStart(5, "0")}`;
}

function getFirstHomologadoByOrder(){
  const ordered = getOrderedHomologados();
  return ordered[0] || null;
}

function generateConsultants(dtIni, dtFim, partnerFilter=null){
  const filtroTipo = $$("inFiltroTipo").value; // TERCEIRO | TERCEIRO_CLT | SANKHYA | BP
  const filtroSen = $$("inFiltroSenioridade").value; // ALL|Executor|Autônomo|Proficiente|Referencia
  const packFilter = $$("inPack")?.value.trim() || "";
  const isBpFilter = filtroTipo === "BP";
  const isBpPack = String(packFilter).trim().toUpperCase() === "BP";
  const isPack5309 = packFilter === "5309 Caixas e Bancos - Pack 1";
  const filialFilter = normalizeFilial($$("inFilial")?.value || "");
  if(state.homologados.length === 0){
    toast("Sem homologados", "Cadastre parceiros homologados para gerar a fila.", "warn", 3000);
    return [];
  }
  const windowSlots = makeSlotsWindow(dtIni, dtFim);

  const base = [
    "Ana Souza","Bruno Lima","Carla Ribeiro","Diego Santos","Elisa Andrade",
    "Felipe Rocha","Gabi Martins","Henrique Silva","Isabela Costa","João Pedro",
    "Kassius Lima","Larissa Nunes","Marcos Vinícius","Natália Melo","Otávio Fernandes",
    "Paula Freitas","Rafael Moreira","Renata Almeida","Sérgio Oliveira","Thiago Augusto"
  ];
  const seniorities = ["Junior","Pleno","Senior"];
  const types = ["TERCEIRO","CLT"];

  const count = (isBpFilter || isBpPack ? 18 : 10) + Math.floor(Math.random()*((isBpFilter || isBpPack) ? 6 : 4));
  const consultants = [];

  const presencialTerceiros = (filtroTipo === "TERCEIRO" || filtroTipo === "TERCEIRO_CLT")
    ? state.terceiros.filter(t => {
        if(!t.presencial) return false;
        if(packFilter){
          const packs = Array.isArray(t.packLevels) ? t.packLevels.map(p => p.pack) : [];
          if(!packs.includes(packFilter)) return false;
        }
        if(filtroSen !== "ALL"){
          const list = getProfShortListFromResource(t, packFilter);
          if(!list.includes(filtroSen)) return false;
        }
        if(filialFilter){
          const tf = normalizeFilial(t.filialSlim || "");
          if(!tf || !tf.includes(filialFilter)) return false;
        }
        return true;
      })
    : [];

  for(let i=0;i<count;i++){
    if(filtroTipo === "SANKHYA" || isBpFilter) continue;
    const pool = partnerFilter ? [partnerFilter] : state.homologados;
    const partner = randomFrom(pool);
    const sen = randomFrom(seniorities);
    const prof = randomFrom(PROF_LABELS);
    const type = randomFrom(types);
    const name = base[i % base.length];

    if(filtroTipo === "TERCEIRO" && type !== "TERCEIRO") continue;
    if(filtroSen !== "ALL" && prof !== filtroSen) continue;

    // agenda: random livre/reservado
    const schedule = windowSlots.map((s, idx) => {
      const reserved = Math.random() < 0.25;
      return {
        index: idx,
        key: `${name}|${partner.name}|${s.day}|${s.period}`,
        day: s.day,
        label: s.label,
        period: s.period,
        status: reserved ? "R" : "L"
      };
    });

    const free = schedule.filter(x=>x.status==="L").length;
    const total = schedule.length || 1;
    const idlePct = Math.round((free/total) * 100);

    const score = calcScore({
      partnerMonths: partner.months,
      partnerResources: partner.resources,
      seniority: sen,
      idlePct
    });

    consultants.push({
      id: crypto.randomUUID(),
      name,
      seniority: sen,
      profShort: prof,
      type,
      partnerId: partner.id,
      partnerName: partner.name,
      partnerOrder: partner.orderRank ?? Infinity,
      idlePct,
      score,
      schedule
    });
  }

  if((isBpFilter || isBpPack || isPack5309) && filtroTipo !== "SANKHYA"){
    const bpPartner = partnerFilter || getFirstHomologadoByOrder() || state.homologados[0];
    if(isBpFilter){
      const bpRegistered = state.terceiros.filter(t => String(t.empresa || "").trim().toUpperCase() === "BP");
      bpRegistered.forEach((t, idx) => {
        const schedule = windowSlots.map((s, sidx) => {
          const reserved = Math.random() < (0.2 + Math.random()*0.35);
          return {
            index: sidx,
            key: `${t.id || t.nome || "BP"}|${s.day}|${s.period}`,
            day: s.day,
            label: s.label,
            period: s.period,
            status: reserved ? "R" : "L"
          };
        });
        const free = schedule.filter(x=>x.status==="L").length;
        const total = schedule.length || 1;
        const idlePct = Math.round((free/total) * 100);
        consultants.push({
          id: t.id || crypto.randomUUID(),
          name: t.nome || `Recurso BP ${idx+1}`,
          seniority: t.senioridade || randomFrom(seniorities),
          profShort: (getProfShortListFromResource(t, packFilter)[0] || "—"),
          type: "TERCEIRO",
          partnerId: bpPartner?.id || null,
          partnerName: "BP",
          partnerOrder: -1 - (idx * 0.01),
          idlePct,
          score: 1300 - idx,
          schedule
        });
      });
    } else {
      const fixedBpNames = [
        "Recurso BP Curitiba",
        "Recurso BP Sorocaba",
        "Recurso BP Recife",
        "Recurso BP Rio de Janeiro"
      ];
      const names = isBpPack ? fixedBpNames : fixedBpNames.slice(0, 2);
      names.forEach((name, idx) => {
        const sen = randomFrom(seniorities);
        const prof = (filtroSen !== "ALL") ? filtroSen : randomFrom(PROF_LABELS);
        const schedule = windowSlots.map((s, sidx) => {
          const reserved = Math.random() < 0.15;
          return {
            index: sidx,
            key: `${name}|BP|${s.day}|${s.period}`,
            day: s.day,
            label: s.label,
            period: s.period,
            status: reserved ? "R" : "L"
          };
        });
        const free = schedule.filter(x=>x.status==="L").length;
        const total = schedule.length || 1;
        const idlePct = Math.round((free/total) * 100);
        consultants.push({
          id: crypto.randomUUID(),
          name,
          seniority: sen,
          profShort: prof,
          type: "TERCEIRO",
          partnerId: bpPartner?.id || null,
          partnerName: "BP",
          partnerOrder: (bpPartner?.orderRank ?? Infinity) - 0.1 - (idx * 0.01),
          idlePct,
          score: 1200 - idx,
          schedule
        });
      });
    }
  }

  // ordena por prioridade do parceiro, depois score e slots livres
  consultants.sort((a,b)=>{
    if(a.partnerOrder !== b.partnerOrder) return a.partnerOrder - b.partnerOrder;
    if(b.score !== a.score) return b.score - a.score;
    const aFree = a.schedule.filter(x=>x.status==="L").length;
    const bFree = b.schedule.filter(x=>x.status==="L").length;
    return bFree - aFree;
  });

  const cltDb = getCltDbConsultants(dtIni, dtFim, packFilter);
  const cltDbFiltered = (filtroSen === "ALL")
    ? cltDb
    : cltDb.filter(c => {
        const res = state.clt.find(x => x.id === c.id);
        const list = getProfShortListFromResource(res, packFilter);
        return list.includes(filtroSen);
      });
  const includeCltDb = (filtroTipo === "TERCEIRO_CLT" || filtroTipo === "SANKHYA");
  const cltDbList = includeCltDb ? cltDbFiltered : [];
  const presencialList = presencialTerceiros.map((t, i) => {
    const schedule = windowSlots.map((s, idx) => {
      const reserved = Math.random() < 0.15;
      return {
        index: idx,
        key: `${t.id}|${s.day}|${s.period}`,
        day: s.day,
        label: s.label,
        period: s.period,
        status: reserved ? "R" : "L"
      };
    });
    const free = schedule.filter(x=>x.status==="L").length;
    const total = schedule.length || 1;
    const idlePct = Math.round((free/total) * 100);
    return {
      id: t.id || crypto.randomUUID(),
      name: t.nome || "Recurso Terceiro",
      seniority: t.senioridade || "—",
      profShort: (getProfShortListFromResource(t, packFilter)[0] || "—"),
      type: "TERCEIRO-PRESENCIAL",
      partnerId: null,
      partnerName: t.empresa || t.codigo || "Terceiro",
      partnerOrder: -0.5,
      idlePct,
      score: 998 - i,
      schedule
    };
  });

  return [...cltDbList, ...presencialList, ...consultants];
}

function generateCltConsultants(dtIni, dtFim, nameFilter=""){
  const windowSlots = makeSlotsWindow(dtIni, dtFim);
  const normFilter = String(nameFilter || "").trim().toLowerCase();
  const list = state.clt.filter(c => {
    if(normFilter && !String(c.nome || "").toLowerCase().includes(normFilter)) return false;
    if(dtIni && c.disponivel){
      const disp = new Date(c.disponivel);
      const ini = new Date(dtIni);
      if(!isNaN(disp) && !isNaN(ini) && disp > ini) return false;
    }
    return true;
  });
  const consultants = [];

  list.forEach(c => {
    const sen = c.senioridade || "—";
    const schedule = windowSlots.map((s, idx) => {
      const key = `${c.id}|${s.day}|${s.period}`;
      const saved = state.cltAgenda?.[key];
      const reserved = Math.random() < 0.2;
      return {
        index: idx,
        key,
        day: s.day,
        label: s.label,
        period: s.period,
        status: saved || (reserved ? "R" : "L")
      };
    });
    const free = schedule.filter(x=>x.status==="L").length;
    const total = schedule.length || 1;
    const idlePct = Math.round((free/total) * 100);
    consultants.push({
      id: c.id,
      name: c.nome || "Recurso CLT",
      seniority: sen,
      type: "CLT",
      partnerId: null,
      partnerName: "Delivery Center",
      partnerOrder: Infinity,
      idlePct,
      score: 0,
      schedule
    });
  });

  return consultants;
}

function getCltDbConsultants(dtIni, dtFim, packFilter=""){
  if(!dtIni || !dtFim) return [];
  const days = buildDaysRange(dtIni, dtFim);
  const result = [];
  const packNeed = String(packFilter || "").trim();
  state.clt.forEach(c => {
    if(packNeed){
      const packs = Array.isArray(c.packLevels) ? c.packLevels.map(p => p.pack) : [];
      if(!packs.includes(packNeed)) return;
    }
    const schedule = [];
    let hasDb = false;
    let idx = 0;
    days.forEach(d=>{
      const day = dayKey(d);
      ["Manhã","Tarde"].forEach(per=>{
        const key = `${c.id}|${day}|${per}`;
        const status = state.cltAgenda?.[key] || "L";
        if(status === "DB") hasDb = true;
        schedule.push({
          index: idx++,
          key,
          day,
          label: `${fmtDate(d)} • ${per}`,
          period: per,
          status
        });
      });
    });
    if(hasDb){
      const free = schedule.filter(x=>x.status==="L").length;
      const total = schedule.length || 1;
      const idlePct = Math.round((free/total) * 100);
      result.push({
        id: c.id,
        name: c.nome || "Recurso CLT",
        seniority: c.senioridade || "—",
        type: "CLT-DB",
        partnerId: null,
        partnerName: "Delivery Center",
        partnerOrder: -1,
        idlePct,
        score: 999,
        schedule
      });
    }
  });
  return result;
}

function buildDaysRange(dtIni, dtFim){
  const start = new Date(dtIni);
  const end = new Date(dtFim);
  const days = [];
  let cur = new Date(start);
  while(cur <= end){
    days.push(new Date(cur));
    cur = addDays(cur, 1);
  }
  return days;
}

  function renderFila(){
    const di = $$("inDtIni").value;
    const df = $$("inDtFim").value;

  $$("kJanela").textContent = (di && df) ? `${fmtDate(di)} → ${fmtDate(df)}` : "—";
  const orders = state.consultants.map(c => c.partnerOrder).filter(n => Number.isFinite(n));
  const ordemAtual = orders.length ? Math.min(...orders) : null;
  $$("kFila").textContent = ordemAtual ? `${ordemAtual}` : "—";
  $$("kCons").textContent = state.selected.consultantId
    ? (state.consultants.find(x=>x.id===state.selected.consultantId)?.name ?? "—")
    : "—";

  // contador elegíveis (no MVP atual: todos na fila)
  const pill = document.getElementById("pillCount");
  if(pill) pill.textContent = String(state.consultants.length);

    const head = document.getElementById("theadRow");
    const tbody = document.getElementById("tbody");
    if(!head || !tbody) return;

  // valida janela
      if(!di || !df){
        head.innerHTML = `<th style="min-width:100px">Valor Hora</th><th style="min-width:240px">Consultor</th>`;
        tbody.innerHTML = "";
        return;
      }

      const days = buildDaysRange(di, df);

    head.innerHTML = `<th style="min-width:100px">Valor Hora</th><th style="min-width:240px">Consultor</th>`;
    days.forEach(d=>{
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      head.innerHTML += `<th>${dd}/${mm}</th>`;
    });

    tbody.innerHTML = "";

    let insertedDivider = false;
    let insertedPresencialDivider = false;
    state.consultants.forEach(c=>{
      if(!insertedPresencialDivider && c.type === "TERCEIRO-PRESENCIAL"){
        const divTr = document.createElement("tr");
        divTr.innerHTML = `<td colspan="${days.length + 2}" class="muted" style="padding:10px 6px;border-top:1px dashed rgba(148,163,184,.4)">Terceiros presenciais (Filial SLIM)</td>`;
        tbody.appendChild(divTr);
        insertedPresencialDivider = true;
      }
      if(!insertedDivider && c.type !== "CLT-DB" && c.type !== "TERCEIRO-PRESENCIAL"){
        const divTr = document.createElement("tr");
        const filaTxt = Number.isFinite(c.partnerOrder) ? `Ordem Fila ${c.partnerOrder}` : "Ordem Fila —";
        const partnerTxt = c.partnerName ? `${c.partnerName}` : "—";
        divTr.innerHTML = `<td colspan="${days.length + 2}" style="padding:10px 6px;border-top:1px dashed rgba(148,163,184,.4)">
          <span style="color:#f59e0b;font-weight:900">${filaTxt}</span>
          <span style="color:#22c55e;font-weight:900;margin-left:8px">${partnerTxt}</span>
        </td>`;
        tbody.appendChild(divTr);
        insertedDivider = true;
      }
      const tr = document.createElement("tr");

      const tdValor = document.createElement("td");
      tdValor.className = "valorHoraCell";
      tdValor.innerHTML = `<div class="vh-wrap"><div class="vh-label">Valor hora</div><div class="vh-value">${getValorHoraLabel(c)}</div></div>`;
      tr.appendChild(tdValor);

      const tdName = document.createElement("td");
      tdName.className = "consultorCell";
      const consultorNomeExibicao = (
        String(c.partnerName || "").trim().toUpperCase() === "BP" &&
        String(c.name || "").trim().toUpperCase() === "RECURSO BP"
      ) ? "Recurso BP Curitiba" : (c.name || "—");
      const tipoExibicao = String(c.type || "").startsWith("CLT") ? "RECURSO SANKHYA" : "HOMOLOGADO";
      const parceiroNomeExibicao = tipoExibicao === "RECURSO SANKHYA"
        ? "Delivery Center"
        : (c.partnerName || "—");
      const priorityMsg = (c.type === "CLT-DB" || c.type === "TERCEIRO-PRESENCIAL")
        ? `<div class="sub" style="color:#f59e0b;font-weight:800">Recurso Prioritário</div>`
        : "";
      const cltMsg = c.type === "CLT-DB"
        ? `<div class="sub" style="color:#22c55e;font-weight:800">Consultor CLT com disponibilidade para Base</div>`
        : "";
      const presMsg = c.type === "TERCEIRO-PRESENCIAL"
        ? `<div class="sub" style="color:#22c55e;font-weight:800">Existe recurso presencial com agenda disponível</div>`
        : "";
      tdName.innerHTML = `
        <div class="meta">
        ${priorityMsg}
        <div><b>${consultorNomeExibicao}</b> <span class="tag">${tipoExibicao}</span></div>
        <div class="sub">Senioridade: <b>${c.seniority}</b> • Ociosidade: <b>${c.idlePct}%</b></div>
        <div class="sub">Parceiro: <b>${parceiroNomeExibicao}</b></div>
        <div class="sub">Proficiência do recurso: <b>${getKnowledgeLabel(c)}</b></div>
        ${cltMsg}
        ${presMsg}
        </div>
      `;
      tr.appendChild(tdName);

    // mapa day|period => slot
    const map = new Map();
    c.schedule.forEach(s=>{
      map.set(`${s.day}|${s.period}`, s);
    });

    days.forEach(d=>{
      const day = dayKey(d);

      const td = document.createElement("td");
      const cell = document.createElement("div");
      cell.className = "agCell";

      ["Manhã","Tarde"].forEach(per=>{
        const slot = map.get(`${day}|${per}`);
        if(!slot){
          const ghost = document.createElement("div");
          ghost.className = "aChip";
          ghost.innerHTML = `<span class="muted">${per}</span><small class="muted">—</small>`;
          cell.appendChild(ghost);
          return;
        }

        const isReserved = slot.status === "R";
        const isSelected = (state.selected.consultantId === c.id) && state.selected.slotKeys.has(slot.key);

        const chip = document.createElement("div");
        chip.className = `aChip ${isReserved ? "R" : "L"} ${isSelected ? "sel" : ""}`;
        chip.title = slot.label + (isReserved ? " (Reservado)" : " (Livre)");
        chip.dataset.consultantId = c.id;
        chip.dataset.slotKey = slot.key;
        chip.dataset.index = slot.index;

        // Padrão visual (print): "Manhã L" / "Tarde R"
        chip.innerHTML = `<span>${per}</span><small>${slot.status}</small>`;

        if(!isReserved){
          chip.addEventListener("click", onSlotClick);
        }
        cell.appendChild(chip);
      });

      td.appendChild(cell);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    updateSelectionKpis();
  }

function updateSelectionKpis(){
  const n = state.selected.slotKeys.size;
  $$("kSel").textContent = n;

  // Botão "Reservar Selecionados" aparece quando houver seleção (>=1)
  const btnR = $$("btnReservar");
  const btnL = $$("btnLimparSel");
  if(btnR){
    btnR.disabled = n === 0;
    btnR.style.display = (n >= 1) ? "" : "none";
  }
  if(btnL){
    btnL.disabled = n === 0;
    btnL.style.display = (n > 0) ? "" : "none";
  }

  const mb = $$("multiBar");
  if(mb){
    mb.classList.toggle("show", n > 0);
  }
  const mc = document.getElementById("multiCount");
  if(mc) mc.textContent = n;
}

function onSlotClickClt(e){
  const el = e.currentTarget;
  const cid = el.dataset.consultantId;
  const key = el.dataset.slotKey;
  const idx = Number(el.dataset.index);

  const ctrl = e.ctrlKey || e.metaKey;
  const shift = e.shiftKey;

  if(shift && state.cltSelected.lastIndex !== null && state.cltSelected.lastConsultantId === cid){
    const c = state.cltConsultants.find(x=>x.id===cid);
    const a = Math.min(state.cltSelected.lastIndex, idx);
    const b = Math.max(state.cltSelected.lastIndex, idx);
    for(let i=a;i<=b;i++){
      const s = c.schedule[i];
      if(s && s.status === "L") state.cltSelected.slotKeys.add(s.key);
    }
  } else if(ctrl){
    if(state.cltSelected.slotKeys.has(key)) state.cltSelected.slotKeys.delete(key);
    else state.cltSelected.slotKeys.add(key);
    state.cltSelected.lastIndex = idx;
    state.cltSelected.lastConsultantId = cid;
  } else {
    if(state.cltSelected.slotKeys.has(key)){
      state.cltSelected.slotKeys.delete(key);
      state.cltSelected.lastIndex = null;
      if(state.cltSelected.slotKeys.size === 0) state.cltSelected.lastConsultantId = null;
    } else {
      state.cltSelected.slotKeys.clear();
      state.cltSelected.slotKeys.add(key);
      state.cltSelected.lastIndex = idx;
      state.cltSelected.lastConsultantId = cid;
    }
  }

  renderCltFila();
}

function onSlotClickCltLb(e, slot, consultant){
  const cid = consultant?.id;
  const key = slot?.key;
  const idx = Number(slot?.index);
  if(!cid || !key) return;
  const ctrl = e.ctrlKey || e.metaKey;
  const shift = e.shiftKey;

  if(shift && state.cltSelectedLb.lastIndex !== null && state.cltSelectedLb.lastConsultantId === cid){
    const c = state.cltConsultants.find(x=>x.id===cid);
    const a = Math.min(state.cltSelectedLb.lastIndex, idx);
    const b = Math.max(state.cltSelectedLb.lastIndex, idx);
    for(let i=a;i<=b;i++){
      const s = c.schedule[i];
      if(s && s.status === "DB") state.cltSelectedLb.slotKeys.add(s.key);
    }
  } else if(ctrl){
    if(state.cltSelectedLb.slotKeys.has(key)) state.cltSelectedLb.slotKeys.delete(key);
    else state.cltSelectedLb.slotKeys.add(key);
    state.cltSelectedLb.lastIndex = idx;
    state.cltSelectedLb.lastConsultantId = cid;
  } else {
    if(state.cltSelectedLb.slotKeys.has(key)){
      state.cltSelectedLb.slotKeys.delete(key);
      state.cltSelectedLb.lastIndex = null;
      if(state.cltSelectedLb.slotKeys.size === 0) state.cltSelectedLb.lastConsultantId = null;
    } else {
      state.cltSelectedLb.slotKeys.clear();
      state.cltSelectedLb.slotKeys.add(key);
      state.cltSelectedLb.lastIndex = idx;
      state.cltSelectedLb.lastConsultantId = cid;
    }
  }

  renderCltFila();
}

function updateSelectionKpisClt(){
  const n = state.cltSelected.slotKeys.size;
  const el = $$("cltSelCount");
  if(el) el.textContent = n;
  const btnR = $$("btnReservarClt");
  const btnL = $$("btnLimparSelClt");
  if(btnR){
    btnR.disabled = n === 0;
    btnR.style.display = (n >= 1) ? "" : "none";
  }
  if(btnL) btnL.disabled = n === 0;
}

function updateSelectionKpisCltLb(){
  const n = state.cltSelectedLb.slotKeys.size;
  const el = $$("cltLbCount");
  if(el) el.textContent = n;
  const btnR = $$("btnRemoveLbClt");
  const btnC = $$("btnClearLbClt");
  if(btnR) btnR.disabled = n === 0;
  if(btnC) btnC.disabled = n === 0;
}

function renderCltFila(){
  const di = $$("cltDtIni").value;
  const df = $$("cltDtFim").value;
  const head = $$("theadRowClt");
  const tbody = $$("tbodyClt");
  if(!head || !tbody) return;

  $$("cltKJanela").textContent = (di && df) ? `${fmtDate(di)} → ${fmtDate(df)}` : "—";
  const selectedIds = new Set();
  state.cltSelected.slotKeys.forEach(k => {
    const cid = String(k).split("|")[0];
    if(cid) selectedIds.add(cid);
  });
  if(selectedIds.size === 0){
    $$("cltKCons").textContent = "—";
  } else if(selectedIds.size === 1){
    const only = Array.from(selectedIds)[0];
    $$("cltKCons").textContent = state.cltConsultants.find(x=>x.id===only)?.name ?? "—";
  } else {
    $$("cltKCons").textContent = "Múltiplos";
  }
  const pill = $$("cltPillCount");
  if(pill) pill.textContent = String(state.cltConsultants.length);

  if(!di || !df){
    head.innerHTML = `<th style="min-width:240px">Recurso Sankhya</th>`;
    tbody.innerHTML = "";
    updateSelectionKpisClt();
    updateSelectionKpisCltLb();
    return;
  }

  const days = buildDaysRange(di, df);
  head.innerHTML = `<th style="min-width:240px">Recurso Sankhya</th>`;
  days.forEach(d=>{
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    head.innerHTML += `<th>${dd}/${mm}</th>`;
  });

  tbody.innerHTML = "";
  state.cltConsultants.forEach(c=>{
    const tr = document.createElement("tr");
    const tdName = document.createElement("td");
    tdName.innerHTML = `
      <div class="meta">
        <div><b>${c.name}</b> <span class="tag">RECURSO SANKHYA</span></div>
        <div class="sub">Parceiro: <b>Delivery Center</b></div>
        <div class="sub">Senioridade: <b>${c.seniority}</b> • Ociosidade: <b>${c.idlePct}%</b></div>
      </div>
    `;
    tr.appendChild(tdName);

    const map = new Map();
    c.schedule.forEach(s=>{ map.set(`${s.day}|${s.period}`, s); });

    days.forEach(d=>{
      const day = dayKey(d);
      const td = document.createElement("td");
      const cell = document.createElement("div");
      cell.className = "agCell";

      ["Manhã","Tarde"].forEach(per=>{
        const slot = map.get(`${day}|${per}`);
        if(!slot){
          const ghost = document.createElement("div");
          ghost.className = "aChip";
          ghost.innerHTML = `<span class="muted">${per}</span><small class="muted">—</small>`;
          cell.appendChild(ghost);
          return;
        }
        const isReserved = slot.status !== "L";
        const isSelected = state.cltSelected.slotKeys.has(slot.key);
        const isSelectedLb = state.cltSelectedLb.slotKeys.has(slot.key);

        const chip = document.createElement("div");
        const statusClass = slot.status === "DB" ? "DB" : (slot.status === "R" ? "R" : "L");
        chip.className = `aChip ${statusClass} ${(isSelected || isSelectedLb) ? "sel" : ""}`;
        chip.title = slot.label + (isReserved ? " (Reservado)" : " (Livre)");
        chip.dataset.consultantId = c.id;
        chip.dataset.slotKey = slot.key;
        chip.dataset.index = slot.index;
        chip.innerHTML = `<span>${per}</span><small>${slot.status}</small>`;
        if(slot.status === "DB"){
          chip.addEventListener("click", (e)=>{
            if(e.ctrlKey || e.metaKey || e.shiftKey || state.cltSelectedLb.slotKeys.size > 0){
              onSlotClickCltLb(e, slot, c);
            } else {
              openCltManageModal(slot, c);
            }
          });
        } else if(!isReserved){
          chip.addEventListener("click", onSlotClickClt);
        }
        cell.appendChild(chip);
      });

      td.appendChild(cell);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  updateSelectionKpisClt();
  updateSelectionKpisCltLb();
}

function updatePriorityHint(){
  const hint = $$("priorityHint");
  if(!hint) return;
  if(!state.priorityChecked){
    hint.style.display = "none";
    return;
  }
  const di = $$("inDtIni")?.value;
  const df = $$("inDtFim")?.value;
  const packNeed = $$("inPack")?.value.trim() || "";
  const has = hasPriorityAvailability(di, df, packNeed);
  hint.style.display = has ? "block" : "none";
}

// ======= bloqueio com toast (melhoria #2)
function applyThirdSelection(cid, key, idx, ctrl=false, shift=false){
  if(state.selected.consultantId && state.selected.consultantId !== cid){
    const currentName = state.consultants.find(x=>x.id===state.selected.consultantId)?.name ?? "consultor atual";
    const targetName = state.consultants.find(x=>x.id===cid)?.name ?? "outro consultor";
    toast(
      "Seleção bloqueada",
      `Você já selecionou slots do consultor "${currentName}". Para escolher "${targetName}", clique em "Limpar Seleção" primeiro.`,
      "warn",
      3000
    );
    return;
  }

  state.selected.consultantId = cid;

  if(shift && state.selected.lastIndex !== null){
    const c = state.consultants.find(x=>x.id===cid);
    const a = Math.min(state.selected.lastIndex, idx);
    const b = Math.max(state.selected.lastIndex, idx);
    for(let i=a;i<=b;i++){
      const s = c.schedule[i];
      if(s && (s.status === "L" || s.status === "DB")) state.selected.slotKeys.add(s.key);
    }
  } else if(ctrl){
    if(state.selected.slotKeys.has(key)) state.selected.slotKeys.delete(key);
    else state.selected.slotKeys.add(key);
    state.selected.lastIndex = idx;
  } else {
    if(state.selected.slotKeys.has(key)){
      state.selected.slotKeys.delete(key);
      state.selected.lastIndex = null;
      if(state.selected.slotKeys.size === 0) state.selected.consultantId = null;
    } else {
      state.selected.slotKeys.clear();
      state.selected.slotKeys.add(key);
      state.selected.lastIndex = idx;
    }
  }
}

function onSlotClick(e){
  const el = e.currentTarget;
  const cid = el.dataset.consultantId;
  const key = el.dataset.slotKey;
  const idx = Number(el.dataset.index);
  applyThirdSelection(cid, key, idx, e.ctrlKey || e.metaKey, e.shiftKey);

  renderFila();
}

function openModal(){
  const v = validateDemandaInputs();
  if(!v.ok){ toast("Campos obrigatórios", v.msg, "warn", 3200); return; }
  if(state.selected.slotKeys.size === 0){ toast("Sem seleção", "Selecione ao menos 1 slot livre para reservar.", "warn", 2600); return; }

  const cid = state.selected.consultantId;
  const c = state.consultants.find(x=>x.id===cid);
  const slots = c.schedule.filter(s => state.selected.slotKeys.has(s.key));

  const prioridadeDisponivel = getPriorityTypes(
    $$("inDtIni")?.value || "",
    $$("inDtFim")?.value || "",
    $$("inPack")?.value.trim() || ""
  );
  const demanda = {
    id: crypto.randomUUID(),
    codCliente: $$("inCodCliente").value.trim(),
    nomeCliente: $$("inNomeCliente").value.trim(),
    filial: $$("inFilial").value.trim(),
    analista: $$("inAnalista").value.trim(),
    telefoneContato: $$("inTelefoneContato").value.trim(),
    emailContato: $$("inEmailContato").value.trim(),
    linkReuniao: $$("inLinkReuniao").value.trim(),
    gerenteRel: $$("inGerRel").value.trim(),
    gerenteCS: $$("inGerCS").value.trim(),
    origem: $$("inOrigem").value.trim(),
    osNumero: $$("inOS").value.trim(),
    pack: $$("inPack").value.trim(),
    detalhe: $$("inDetalhe").value.trim(),
    dtIni: $$("inDtIni").value,
    dtFim: $$("inDtFim").value,
    createdAt: new Date().toISOString()
  };

  state.modalContext = { demanda, consultant: c, slots };

  const osTxt = demanda.osNumero ? ` • OS: ${demanda.osNumero}` : "";
  $$("mDemanda").textContent = `Código ${demanda.codCliente} • ${demanda.nomeCliente}${osTxt} • ${fmtDate(demanda.dtIni)} → ${fmtDate(demanda.dtFim)}`;
  $$("mCliente").textContent = demanda.nomeCliente;
  $$("mPack").textContent = demanda.pack;
  $$("mOrigem").textContent = demanda.origem;

  $$("mConsultor").textContent = c.name;
  $$("mParceiro").textContent = c.partnerName;
  $$("mSenior").textContent = c.seniority;

  $$("mSlots").innerHTML = slots.map(s => `• <b>${fmtDate(s.day)}</b> – ${s.period}`).join("<br/>");

  $$("modalBackdrop").style.display = "flex";
}
function closeModal(){
  $$("modalBackdrop").style.display = "none";
  $$("mObs").value = "";
  state.modalContext = null;
}
function confirmReserva(){
  const ctx = state.modalContext;
  if(!ctx) return;

  const obs = $$("mObs").value.trim();

  const c = state.consultants.find(x=>x.id===ctx.consultant.id);
  ctx.slots.forEach(s=>{
    const slot = c.schedule.find(x=>x.key===s.key);
    if(slot) slot.status = "R";
  });

  state.reservations.push({
    id: crypto.randomUUID(),
    svr: nextSvr(),
    demanda: ctx.demanda,
    consultant: { id:c.id, name:c.name, seniority:c.seniority, partnerName:c.partnerName, type:c.type, profShort: c.profShort || null },
    slots: ctx.slots.map(s=>({ day:s.day, period:s.period, label:s.label })),
    obs,
    partnerOrder: getPartnerOrderByName(c.partnerName),
    expectedOrder: getCurrentExpectedOrder(),
    status: "PENDENTE",
    validatedAt: null,
    validatorNote: "",
    towerChanges: 0,
    lastTowerChange: null,
    sentToTower: false,
    pdfConfirmed: false
  });

  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  state.selected.consultantId = null;
  closeModal();
  renderFila();
  renderResumo();
  renderValidation();

  saveState();
  showTab("resumo");
  toast("Reserva criada", "Reserva enviada para Validação da Torre.", "info", 2600);
}

function renderClientes(){
  const tbody = $$("tbodyClientes");
  tbody.innerHTML = "";
  state.clients.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.code ?? ""}</td>
      <td><b>${c.name}</b></td>
      <td>${c.filial ?? ""}</td>
      <td>${c.analista ?? ""}</td>
      <td>${c.gerenteRel ?? ""}</td>
      <td>${c.gerenteCS ?? ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderHomologados(){
  const tbody = $$("tbodyHomologados");
  tbody.innerHTML = "";
  $$("kOrdem").textContent = state.lastOrderCount || 0;
  const editMode = state.editModeHomologados;
  state.homologados
    .slice()
    .sort((a,b)=>{
      const ar = a.orderRank ?? Infinity;
      const br = b.orderRank ?? Infinity;
      if(ar !== br) return ar - br; // menor para maior
      return (a.name || "").localeCompare(b.name || "");
    })
    .forEach(p=>{
      const tr = document.createElement("tr");
      const resCell = editMode
        ? `<input type="number" min="0" class="h-edit" data-field="resources" data-id="${p.id}" value="${p.resources}" style="width:80px" />`
        : `${p.resources}`;
      const monCell = editMode
        ? `<input type="number" min="0" class="h-edit" data-field="months" data-id="${p.id}" value="${p.months}" style="width:80px" />`
        : `${p.months}`;
      const rates = buildPartnerRateMap(p.valorHoraByProf, Number(p.valorHora) || 0);
      const vhCell = editMode
        ? `
          <div style="display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:6px">
            <input type="text" class="h-edit" data-field="valorProf" data-prof="Executor" data-id="${p.id}" value="${rates.Executor ? formatBRL(rates.Executor) : ""}" placeholder="Executor" />
            <input type="text" class="h-edit" data-field="valorProf" data-prof="Autônomo" data-id="${p.id}" value="${rates["Autônomo"] ? formatBRL(rates["Autônomo"]) : ""}" placeholder="Autônomo" />
            <input type="text" class="h-edit" data-field="valorProf" data-prof="Proficiente" data-id="${p.id}" value="${rates.Proficiente ? formatBRL(rates.Proficiente) : ""}" placeholder="Proficiente" />
            <input type="text" class="h-edit" data-field="valorProf" data-prof="Referencia" data-id="${p.id}" value="${rates.Referencia ? formatBRL(rates.Referencia) : ""}" placeholder="Referencia" />
          </div>`
        : `${partnerRateSummary(rates)}`;
      const iniCell = editMode
        ? `<input type="date" class="h-edit" data-field="inicio" data-id="${p.id}" value="${p.inicio || ""}" />`
        : `${p.inicio ? fmtDateSafe(p.inicio) : ""}`;
      const canEdit = isTerceiroHomologado(p);
      tr.innerHTML = `
        <td>
          <input type="number" min="1" class="order-input" data-order-id="${p.id}" value="${p.orderRank ?? ""}" style="width:64px" />
        </td>
        <td>${p.code ?? ""}</td>
        <td><b>${p.name}</b></td>
        <td>${resCell}</td>
        <td>${monCell}</td>
        <td>${vhCell}</td>
        <td>${iniCell}</td>
        <td>
          <div class="actions tight" style="margin-top:0">
            ${canEdit ? `<button class="btn-sm" data-edit="${p.id}">Editar</button>` : ``}
            <button class="btn-sm danger" data-del="${p.id}">Remover</button>
          </div>
        </td>
      `;
    const editBtn = tr.querySelector("[data-edit]");
    if(editBtn){
      editBtn.addEventListener("click", ()=>{
        loadHomologadoForm(p);
      });
    }
    tr.querySelector("[data-del]").addEventListener("click", ()=>{
      state.homologados = state.homologados.filter(x=>x.id!==p.id);
      state.lastOrderCount = Math.max(0, state.homologados.filter(x=>x.orderRank !== null).length);
      $$("kOrdem").textContent = state.lastOrderCount;
      if(state.editing.homologadoId === p.id){
        state.editing.homologadoId = null;
        $$("btnAddHomologado").textContent = "Adicionar Parceiro";
      }
      saveState();
      renderHomologados();
      // se quiser: reordenar fila atual pelo novo score
      if(state.consultants.length){
        const di = $$("inDtIni").value, df = $$("inDtFim").value;
        state.consultants = generateConsultants(di, df);
        state.selected.slotKeys.clear();
        state.selected.lastIndex = null;
        state.selected.consultantId = null;
        renderFila();
      }
    });
    const orderInput = tr.querySelector(".order-input");
    if(orderInput){
      orderInput.addEventListener("change", () => {
        const val = Number(orderInput.value);
        const target = state.homologados.find(x=>x.id===p.id);
        if(!target) return;
        const nextRank = Number.isFinite(val) && val > 0 ? val : null;
        if(nextRank !== null){
          const conflict = state.homologados.find(x => x.id !== p.id && x.orderRank === nextRank);
          if(conflict){
            toast("Ordem duplicada", `A ordem ${nextRank} já está em uso por "${conflict.name}".`, "warn", 2800);
            orderInput.value = target.orderRank ?? "";
            return;
          }
        }
        target.orderRank = nextRank;
        state.lastOrderCount = state.homologados.filter(x=>x.orderRank !== null).length;
        $$("kOrdem").textContent = state.lastOrderCount;
        saveState();
      });
    }
    if(editMode){
      tr.querySelectorAll(".h-edit").forEach(input=>{
        input.addEventListener("input", () => {
          const id = input.dataset.id;
          const field = input.dataset.field;
          const target = state.homologados.find(x=>x.id===id);
          if(!target) return;
          if(field === "resources" || field === "months"){
            const val = Number(input.value);
            target[field] = isNaN(val) ? 0 : val;
          } else if(field === "valorProf"){
            const prof = normalizeProfShortLabel(input.dataset.prof);
            if(!PROF_LABELS.includes(prof)) return;
            target.valorHoraByProf = buildPartnerRateMap(target.valorHoraByProf, Number(target.valorHora) || 0);
            const val = parseBRL(input.value);
            if(val === null){
              target.valorHoraByProf[prof] = 0;
              input.value = "";
            } else {
              target.valorHoraByProf[prof] = val;
              input.value = formatBRL(val);
            }
          } else if(field === "inicio"){
            target.inicio = input.value || "";
          }
          state.homologadosDirty = true;
          const btnSave = $$("btnSaveHomologados");
          if(btnSave) btnSave.style.display = "";
        });
      });
    }
    tbody.appendChild(tr);
  });
}

function findHomologadoByCode(code){
  if(!code) return null;
  const norm = code.replace(/\s+/g, "").toLowerCase();
  return state.homologados.find(h => {
    const c = (h.code || "").replace(/\s+/g, "").toLowerCase();
    return c && c === norm;
  }) || null;
}

function isTerceiroHomologado(partner){
  if(!partner) return false;
  const codeNorm = String(partner.code || "").replace(/\s+/g, "").toLowerCase();
  const nameNorm = String(partner.name || "").trim().toLowerCase();
  const match = state.terceiros.some(t => {
    const tCode = String(t.codigo || "").replace(/\s+/g, "").toLowerCase();
    const tName = String(t.empresa || "").trim().toLowerCase();
    if(codeNorm && tCode && codeNorm === tCode) return true;
    if(nameNorm && tName && nameNorm === tName) return true;
    return false;
  });
  if(match) return true;
  if(nameNorm.includes("delivery center")) return false;
  if(nameNorm === "clt") return false;
  return true;
}

function loadHomologadoForm(existing){
  if(!existing) return;
  const rates = buildPartnerRateMap(existing.valorHoraByProf, Number(existing.valorHora) || 0);
  $$("hCodigo").value = existing.code || "";
  $$("hNome").value = existing.name || "";
  $$("hRecursos").value = existing.resources ?? 0;
  $$("hTempo").value = existing.months ?? 0;
  $$("hValorHoraExecutor").value = rates.Executor ? formatBRL(rates.Executor) : "";
  $$("hValorHoraAutonomo").value = rates["Autônomo"] ? formatBRL(rates["Autônomo"]) : "";
  $$("hValorHoraProficiente").value = rates.Proficiente ? formatBRL(rates.Proficiente) : "";
  $$("hValorHoraReferencia").value = rates.Referencia ? formatBRL(rates.Referencia) : "";
  $$("hInicio").value = existing.inicio || "";
  state.editing.homologadoId = existing.id;
  $$("btnAddHomologado").textContent = "Salvar alterações";
  const hint = $$("homologadoHint");
  if(hint) hint.style.display = "";
}

function generateOrdemFila(){
  const list = state.homologados.slice().sort((a,b)=>{
    for(const rule of state.orderRules){
      const va = a[rule.field] ?? 0;
      const vb = b[rule.field] ?? 0;
      if(vb !== va){
        return rule.dir === "desc" ? (vb - va) : (va - vb);
      }
    }
    return (a.name || "").localeCompare(b.name || "");
  });
  list.forEach((p, idx)=>{
    const target = state.homologados.find(x=>x.id===p.id);
    if(target) target.orderRank = idx + 1;
  });
  state.lastOrderCount = list.length;
  saveState();
  renderHomologados();
  toast("Ordem gerada", "Fila ordenada pela regra configurada.", "info", 2400);
}

function confirmRecalcOrdem(){
  if(state.lastOrderCount === 0) return true;
  return confirm("A ordem será recalculada com base na regra configurada. Deseja continuar?");
}

function openOrderModal(){
  renderOrderModal();
  $$("orderBackdrop").style.display = "flex";
}
function closeOrderModal(){
  $$("orderBackdrop").style.display = "none";
}

function renderOrderModal(){
  const summary = $$("orderSummary");
  const rulesBox = $$("orderRules");
  if(!summary || !rulesBox) return;

  const labels = {
    resources: "Maior nº de recursos",
    months: "Maior tempo (meses)"
  };

  summary.innerHTML = state.orderRules
    .map((r, i)=> `<div><b>${i+1}º</b> ${labels[r.field] || r.field} (${r.dir === "desc" ? "desc" : "asc"})</div>`)
    .join("");

  rulesBox.innerHTML = "";
  state.orderRules.forEach((r, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.style.marginTop = "8px";
    row.innerHTML = `
      <div>
        <label>Regra ${idx+1}</label>
        <select data-rule-field>
          <option value="resources" ${r.field==="resources"?"selected":""}>Maior nº de recursos</option>
          <option value="months" ${r.field==="months"?"selected":""}>Maior tempo (meses)</option>
        </select>
      </div>
      <div>
        <label>Direção</label>
        <select data-rule-dir>
          <option value="desc" ${r.dir==="desc"?"selected":""}>Descendente</option>
          <option value="asc" ${r.dir==="asc"?"selected":""}>Ascendente</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="danger btn-sm" data-rule-del>Remover</button>
      </div>
    `;
    row.querySelector("[data-rule-del]").addEventListener("click", ()=>{
      state.orderRules.splice(idx, 1);
      if(state.orderRules.length === 0){
        state.orderRules.push({ field: "resources", dir: "desc" });
      }
      renderOrderModal();
    });
    rulesBox.appendChild(row);
  });
}

function openSwapModal(reservationId){
  const r = state.reservations.find(x=>x.id===reservationId);
  if(!r) return;
  state.swapContext = r;
  state.swapPartnerIndex = 0;
  $$("swapInfo").textContent = `Demanda: ${r.demanda?.nomeCliente || ""} • Consultor atual: ${r.consultant?.name || ""}`;
  $$("swapConsultor").value = r.consultant?.name || "";
  $$("swapConsultorId").value = r.consultant?.id || "";
  $$("swapData").value = r.slots?.[0]?.day || "";
  $$("swapPeriodo").value = r.slots?.[0]?.period || "Manhã";
  $$("swapObs").value = "";
  renderSwapOptions();
  $$("swapBackdrop").style.display = "flex";
}
function closeSwapModal(){
  $$("swapBackdrop").style.display = "none";
  state.swapContext = null;
}

function openInfoModal(msg){
  const box = $$("infoBackdrop");
  const el = $$("infoMessage");
  if(el) el.textContent = msg;
  if(box) box.style.display = "flex";
}
function closeInfoModal(){
  const box = $$("infoBackdrop");
  if(box) box.style.display = "none";
  const codeEl = $$("inCodCliente");
  if(codeEl) codeEl.value = "";
  if(state.pendingReserveAfterInfo){
    state.pendingReserveAfterInfo = false;
    openSelectedModalMPV();
  }
}

let terceiroModalId = null;
let terceiroModalType = "terceiros";
let terceiroPackMap = {};
let terceiroPackOrder = [];
let cltManageSlot = null;

function getNivelOptionsHtml(selected){
  const levels = [
    "Não Atua - Não possui conhecimento ou experiência prática.",
    "Executor - Executa tarefas mais simples e rotineiras, como levantamento inicial de dados e auxilio em treinamento, seguindo processos definidos. Requer supervisão.",
    "Autônomo - Lida com tarefas mais complexas, como analises detalhadas de processos de negocios, configuração do sistema e suporte a testes. Consegue propor soluções para problemas dentro da sua área de atuação.",
    "Proficiente - Possui dominio tecnico em uma área muito particular do sistema, atuando como referencia naquele assunto especifico. Foca mais na configuração, parametrização e solução de problemas tecnicos pontuais dentro da sua especialidade, seguindo as diretrizes do projeto.",
    "Referencia - Alem de ser especialista em alguma área, atua de forma autonoma e estrategica, comunica-se com clareza e precisao tanto com as equipes tecnicas, quanto com os niveis diretivos dos clientes. Possui maturidade e experiencia para resolver problemas de alta complexidade e lidar com cenarios de mudança organizacional durante a implantação."
  ];
  const opts = ['<option value="">Selecione</option>']
    .concat(levels.map(l => `<option${l===selected ? " selected":""}>${escapeHtml(l)}</option>`));
  return opts.join("");
}

function syncTerceiroPackSelect(){
  const packSelect = $$("tPackModal");
  if(!packSelect) return;
  const selected = new Set(terceiroPackOrder);
  Array.from(packSelect.options).forEach(opt => {
    const val = opt.value || opt.textContent;
    opt.selected = selected.has(val);
  });
}

function shortNivelLabel(nivel){
  if(!nivel) return "—";
  const parts = nivel.split(" - ");
  return parts[0].trim() || nivel;
}

function getProfShortListFromResource(resource, packFilter=""){
  if(!resource) return [];
  const levels = Array.isArray(resource.packLevels) ? resource.packLevels : [];
  if(packFilter){
    const lvl = levels.find(p => p.pack === packFilter)?.nivel || "";
    const short = shortNivelLabel(lvl);
    return short && short !== "—" ? [short] : [];
  }
  return levels
    .map(p => shortNivelLabel(p.nivel))
    .filter(x => x && x !== "—");
}

function getPartnerRateByProf(partnerName, profShort){
  const prof = normalizeProfShortLabel(profShort);
  if(!partnerName || !prof) return 0;
  const partner = state.homologados.find(h => String(h.name || "").trim().toLowerCase() === String(partnerName || "").trim().toLowerCase());
  if(!partner) return 0;
  const rates = buildPartnerRateMap(partner.valorHoraByProf, Number(partner.valorHora) || 0);
  const value = Number(rates[prof]) || 0;
  return value > 0 ? value : 0;
}

function getValorHoraLabel(c){
  const packNeed = $$("inPack")?.value.trim() || "";
  let nivel = "";
  if(c.type === "CLT-DB"){
    const res = state.clt.find(x=>x.id===c.id);
    if(res && packNeed){
      nivel = (res.packLevels || []).find(p => p.pack === packNeed)?.nivel || "";
    }
  } else if(c.type === "TERCEIRO-PRESENCIAL"){
    const res = state.terceiros.find(x=>x.id===c.id);
    if(res && packNeed){
      nivel = (res.packLevels || []).find(p => p.pack === packNeed)?.nivel || "";
    }
  } else if(c.profShort){
    const key = Object.keys(state.valorHora || {}).find(k => shortNivelLabel(k) === c.profShort);
    if(key) nivel = key;
  }
  if(nivel){
    const val = state.valorHora?.[nivel];
    if(Number.isFinite(val) && val > 0) return formatBRL(val);
  }
  return "—";
}

function getValorHoraValueFor(packNeed, c){
  const packFilter = String(packNeed || "").trim();
  let nivel = "";
  if(c.type === "CLT-DB"){
    const res = state.clt.find(x=>x.id===c.id);
    if(res && packFilter){
      nivel = (res.packLevels || []).find(p => p.pack === packFilter)?.nivel || "";
    }
  } else if(c.type === "TERCEIRO-PRESENCIAL"){
    const res = state.terceiros.find(x=>x.id===c.id);
    if(res && packFilter){
      nivel = (res.packLevels || []).find(p => p.pack === packFilter)?.nivel || "";
    }
  } else if(c.profShort){
    const key = Object.keys(state.valorHora || {}).find(k => shortNivelLabel(k) === c.profShort);
    if(key) nivel = key;
  }
  if(nivel){
    const val = state.valorHora?.[nivel];
    return Number.isFinite(val) ? val : 0;
  }
  return 0;
}

function getValorHoraValue(c){
  const packNeed = $$("inPack")?.value.trim() || "";
  return getValorHoraValueFor(packNeed, c);
}

function getReservationStartDate(r){
  if(!r || !Array.isArray(r.slots) || r.slots.length === 0) return null;
  let min = null;
  r.slots.forEach(s=>{
    if(!s.day) return;
    let hh = 9;
    const per = String(s.period || "").toLowerCase();
    if(per.includes("manhã") || per.includes("manha")) hh = 8;
    if(per.includes("tarde")) hh = 13;
    const d = new Date(`${s.day}T${String(hh).padStart(2,"0")}:00:00`);
    if(isNaN(d)) return;
    if(!min || d < min) min = d;
  });
  return min;
}

function releaseReservationSlots(r){
  if(!r) return;
  const c = state.consultants.find(x=>x.id===r.consultant?.id);
  if(c && Array.isArray(c.schedule)){
    r.slots.forEach(s=>{
      const slot = c.schedule.find(x=>x.day===s.day && x.period===s.period);
      if(slot) slot.status = "L";
    });
  }
  if(r.consultant?.type && String(r.consultant.type).startsWith("CLT")){
    r.slots.forEach(s=>{
      const key = `${r.consultant.id}|${s.day}|${s.period}`;
      if(state.cltAgenda && key in state.cltAgenda) state.cltAgenda[key] = "L";
    });
  }
}

function renderTerceiroSelecionados(order, existingMap){
  const wrap = $$("terceiroSelecionados");
  if(!wrap) return;
  if(!order.length){
    wrap.innerHTML = `<div class="muted small">Nenhum pack selecionado.</div>`;
    return;
  }
  wrap.innerHTML = order.map(pack => {
    const nivel = existingMap[pack] || "";
    return `
      <div class="rowItem">
        <div style="max-width:260px"><b>${escapeHtml(pack)}</b></div>
        <div class="small muted">${escapeHtml(shortNivelLabel(nivel))}</div>
        <button class="btn-sm danger" data-pack-remove="${escapeHtml(pack)}">Remover</button>
      </div>
    `;
  }).join("");
  wrap.querySelectorAll("[data-pack-remove]").forEach(btn => {
    btn.addEventListener("click", () => {
      const pack = btn.getAttribute("data-pack-remove") || "";
      if(!pack) return;
      const currentMap = { ...existingMap };
      delete currentMap[pack];
      terceiroPackOrder = terceiroPackOrder.filter(p => p !== pack);
      terceiroPackMap = currentMap;
      syncTerceiroPackSelect();
      renderTerceiroSelecionados(terceiroPackOrder, terceiroPackMap);
    });
  });
}

function openTerceiroModal(id, type="terceiros"){
  const list = type === "clt" ? state.clt : state.terceiros;
  const t = list.find(x => x.id === id);
  if(!t) return;
  terceiroModalId = id;
  terceiroModalType = type;
  const info = $$("terceiroInfo");
  if(info){
    const parceiro = type === "clt" ? "CLT" : (t.empresa || t.codigo || "Parceiro");
    const nome = t.nome || "Recurso";
    info.textContent = `${nome} • ${parceiro}`;
  }
  const nivelSelect = $$("tNivelModal");
  if(nivelSelect){
    nivelSelect.innerHTML = getNivelOptionsHtml("");
    nivelSelect.value = "";
  }
  const packSelect = $$("tPackModal");
  if(packSelect){
    const inPack = $$("inPack");
    packSelect.innerHTML = inPack ? inPack.innerHTML : '<option value="">Selecione</option>';
    const packLevels = Array.isArray(t.packLevels) ? t.packLevels : [];
    terceiroPackMap = {};
    terceiroPackOrder = [];
    packLevels.forEach(p => {
      if(!p.pack) return;
      terceiroPackMap[p.pack] = p.nivel || "";
      terceiroPackOrder.push(p.pack);
    });
    syncTerceiroPackSelect();
    renderTerceiroSelecionados(terceiroPackOrder, terceiroPackMap);
    packSelect.onchange = () => {
      const curSelected = Array.from(packSelect.selectedOptions).map(o => o.value || o.textContent).filter(Boolean);
      const currentMap = { ...terceiroPackMap };
      const selectedSet = new Set(curSelected);
      const added = curSelected.filter(p => !terceiroPackOrder.includes(p));
      const removed = terceiroPackOrder.filter(p => !selectedSet.has(p));
      const level = (nivelSelect?.value || "").trim();
      if(added.length && !level){
        toast("Nível obrigatório", "Selecione o nível antes de escolher o pack.", "warn", 2600);
        added.forEach(p => selectedSet.delete(p));
        terceiroPackOrder = terceiroPackOrder.filter(p => selectedSet.has(p));
        terceiroPackMap = currentMap;
        syncTerceiroPackSelect();
        renderTerceiroSelecionados(terceiroPackOrder, terceiroPackMap);
        return;
      }
      added.forEach(p => { currentMap[p] = level || currentMap[p] || ""; });
      removed.forEach(p => { delete currentMap[p]; });
      terceiroPackOrder = curSelected.filter(p => selectedSet.has(p));
      terceiroPackMap = currentMap;
      syncTerceiroPackSelect();
      renderTerceiroSelecionados(terceiroPackOrder, terceiroPackMap);
    };
  }
  const box = $$("terceiroBackdrop");
  if(box) box.style.display = "flex";
}

function closeTerceiroModal(){
  const box = $$("terceiroBackdrop");
  if(box) box.style.display = "none";
  terceiroModalId = null;
  terceiroModalType = "terceiros";
}

function renderSwapOptions(){
  const wrap = $$("swapOptions");
  const date = $$("swapData")?.value;
  if(!wrap) return;
  wrap.innerHTML = "";
  if(!date){
    wrap.innerHTML = `<div class="muted small">Selecione uma data para ver opções.</div>`;
    return;
  }
  const ordered = getOrderedHomologados();
  if(!ordered.length){
    wrap.innerHTML = `<div class="muted small">Gere a ordem da fila para listar opções.</div>`;
    const ord = $$("swapOrderInfo");
    if(ord) ord.textContent = "—";
    return;
  }
  const idx = Math.min(state.swapPartnerIndex, ordered.length - 1);
  const partner = ordered[idx];
  const ord = $$("swapOrderInfo");
  if(ord) ord.textContent = partner.orderRank ?? "—";
  const list = generateConsultants($$("inDtIni").value, $$("inDtFim").value, partner);
  let any = false;
  list.forEach(c=>{
    const slot = c.schedule?.find(s=>s.day===date && s.status==="L");
    if(!slot) return;
    any = true;
    const card = document.createElement("div");
    card.className = "swap-option";
    card.innerHTML = `
      <div class="t1">${c.name} <span class="pill">${c.type}</span></div>
      <div class="t2">Senioridade: <b>${c.seniority}</b> • Ociosidade: <b>${c.idlePct}%</b></div>
      <div class="t2">Parceiro: <b>${c.partnerName}</b></div>
      <div class="t2">Proficiência do recurso: <b>${getKnowledgeLabel(c)}</b> • Período: <b>${slot.period}</b></div>
    `;
    card.addEventListener("click", ()=>{
      $$("swapConsultor").value = c.name;
      $$("swapConsultorId").value = c.id;
      $$("swapPeriodo").value = slot.period;
    });
    wrap.appendChild(card);
  });
  if(!any){
    wrap.innerHTML = `<div class="muted small">Nenhuma disponibilidade encontrada para esta data (parceiro ${partner.name}).</div>`;
  }
}

function buildResumoRowsForReservation(r){
  const solicitacao = r.demanda?.origem || "—";
  const pack = r.demanda?.pack || "—";
  const detalhe = r.demanda?.detalhe || "—";
  const consultor = r.consultant?.name || "—";
  const consultorType = String(r.consultant?.type || "");
  const parceiroHom = consultorType.startsWith("CLT")
    ? "Recurso Sankhya"
    : (r.consultant?.partnerName || "—");
  const svr = r.svr || "SVR-—";
  const rows = [];
  const byDay = new Map();
  (r.slots || []).forEach(s=>{
    const key = s.day || "—";
    const list = byDay.get(key) || [];
    list.push(s.period || "—");
    byDay.set(key, list);
  });
  byDay.forEach((periods, dayKeyRaw)=>{
    const norm = periods.map(p => String(p || "").toLowerCase());
    const hasManha = norm.some(p => p.includes("manhã") || p.includes("manha"));
    const hasTarde = norm.some(p => p.includes("tarde"));
    let periodo = "—";
    if(hasManha && hasTarde){
      periodo = "Dia todo";
    } else {
      const uniq = Array.from(new Set(periods.map(p => p || "—")));
      periodo = uniq.join(" / ");
    }
    const d = dayKeyRaw !== "—" ? fmtDate(dayKeyRaw) : "—";
    rows.push({
      svr,
      solicitacao,
      pack,
      detalhe,
      consultor,
      parceiroHom,
      ini: d,
      fim: d,
      periodo,
      mod: (r.modalidade || "—")
    });
  });
  return rows;
}

function printResumoForReservation(r){
  const rows = buildResumoRowsForReservation(r);
  const w = window.open("", "_blank");
  if(!w) return;
  const style = `
    <style>
      body{font-family:Arial, sans-serif; color:#111; padding:20px}
      h2{margin:0 0 12px 0}
      .info{margin:6px 0 12px 0; font-size:12px}
      .info table{width:100%; border-collapse:collapse}
      .info th,.info td{border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top}
      .info th{background:#f3f4f6; width:24%}
      h3{margin:16px 0 8px 0}
      table{width:100%; border-collapse:collapse; font-size:12px}
      th,td{border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top}
      th{background:#f3f4f6}
      .muted{color:#6b7280}
    </style>
  `;
  const info = {
    parceiro: r.demanda?.nomeCliente || "—",
    solicitante: r.demanda?.analista || "—",
    telefoneContato: r.demanda?.telefoneContato || "—",
    emailContato: r.demanda?.emailContato || "—",
    dataSolic: r.demanda?.createdAt ? fmtDateSafe(r.demanda.createdAt) : "—",
    gerenteRel: r.demanda?.gerenteRel || "—",
    gerenteCS: r.demanda?.gerenteCS || "—"
  };
  const isRemoto = String(r.modalidade || "").toLowerCase() === "remoto";
  const linkReuniaoRaw = String(r.demanda?.linkReuniao || "").trim();
  const linkReuniaoSafe = escapeHtml(linkReuniaoRaw);
  const linkReuniaoCell = isRemoto
    ? (linkReuniaoRaw ? `<a href="${linkReuniaoSafe}" target="_blank" rel="noopener noreferrer">${linkReuniaoSafe}</a>` : "—")
    : "—";
  const slotsByDay = new Map();
  (r.slots || []).forEach(s=>{
    const key = s.day || "—";
    const list = slotsByDay.get(key) || [];
    list.push(s.period || "—");
    slotsByDay.set(key, list);
  });
  const baseConsultant = state.consultants.find(x=>x.id===r.consultant?.id) || r.consultant || null;
  const totalHoras = (r.slots?.length || 0) * 4;
  const vh = baseConsultant ? getValorHoraValueFor(r.demanda?.pack || "", baseConsultant) : 0;
  const totalValor = vh > 0 ? (totalHoras * vh) : 0;
  const consultorType = baseConsultant?.type || r.consultant?.type || "";
  const consultorParceiro = consultorType && String(consultorType).startsWith("CLT")
    ? "Delivery Center"
    : (baseConsultant?.partnerName || r.consultant?.partnerName || "—");
  const consultorInfo = {
    nome: baseConsultant?.name || r.consultant?.name || "—",
    parceiro: consultorParceiro,
    email: baseConsultant?.email || "—",
    telefone: baseConsultant?.telefone || "—"
  };
  const agendasRows = Array.from(slotsByDay.entries()).map(([dayKeyRaw, periods])=>{
    const norm = periods.map(p => String(p || "").toLowerCase());
    const hasManha = norm.some(p => p.includes("manhã") || p.includes("manha"));
    const hasTarde = norm.some(p => p.includes("tarde"));
    let periodo = "—";
    if(hasManha && hasTarde){
      periodo = "Dia todo";
    } else {
      const uniq = Array.from(new Set(periods.map(p => p || "—")));
      periodo = uniq.join(" / ");
    }
    const d = dayKeyRaw !== "—" ? fmtDate(dayKeyRaw) : "—";
    return `<tr><td>${d}</td><td>${escapeHtml(periodo)}</td></tr>`;
  }).join("");
  const head = `
    <h2>Resumo da Solicitação ${escapeHtml(r.svr || "SVR-—")}</h2>
    <div class="info">
      <table>
        <tbody>
          <tr>
            <th>Nome Parceiro</th>
            <td>${escapeHtml(info.parceiro)}</td>
            <th>Nome do Solicitante</th>
            <td>${escapeHtml(info.solicitante)}</td>
          </tr>
          <tr>
            <th>Data Solicitação</th>
            <td>${escapeHtml(info.dataSolic)}</td>
            <th>Telefone contato solicitante</th>
            <td>${escapeHtml(info.telefoneContato)}</td>
          </tr>
          <tr>
            <th>Nome Gerente de Relacionamento</th>
            <td>${escapeHtml(info.gerenteRel)}</td>
            <th>Email de contato</th>
            <td>${escapeHtml(info.emailContato)}</td>
          </tr>
          <tr>
            <th>Nome do Sucesso Cliente</th>
            <td>${escapeHtml(info.gerenteCS)}</td>
            <th>Link da reunião</th>
            <td>${isRemoto ? linkReuniaoCell : "—"}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <h3>Dados do Consultor</h3>
    <table>
      <tbody>
        <tr>
          <th>Nome</th>
          <td>${escapeHtml(consultorInfo.nome)}</td>
          <th>Parceiro</th>
          <td>${escapeHtml(consultorInfo.parceiro)}</td>
        </tr>
        <tr>
          <th>E-mail</th>
          <td>${escapeHtml(consultorInfo.email)}</td>
          <th>Telefone</th>
          <td>${escapeHtml(consultorInfo.telefone)}</td>
        </tr>
      </tbody>
    </table>
    <h3>Agendas Reservadas</h3>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Período</th>
        </tr>
      </thead>
      <tbody>
        ${agendasRows || `<tr><td colspan="2" class="muted">—</td></tr>`}
      </tbody>
    </table>
    <div class="muted" style="margin-top:6px">
      Horas: <b>${totalHoras || 0}h</b> • Valor hora: <b>${vh ? formatBRL(vh) : "—"}</b> • Total: <b>${totalValor ? formatBRL(totalValor) : "—"}</b>
    </div>
    <table>
      <thead>
        <tr>
          <th>SVR</th>
          <th>Solicitação</th>
          <th>Pack</th>
          <th>Detalhamento</th>
          <th>Consultor</th>
          <th>Parceiro</th>
          <th>Data início</th>
          <th>Data fim</th>
          <th>Período</th>
          <th>Remoto/Presencial</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(x=>`
          <tr>
            <td>${escapeHtml(x.svr)}</td>
            <td>${escapeHtml(x.solicitacao)}</td>
            <td>${escapeHtml(x.pack)}</td>
            <td>${escapeHtml(x.detalhe)}</td>
            <td>${escapeHtml(x.consultor)}</td>
            <td>${escapeHtml(x.parceiroHom)}</td>
            <td>${x.ini}</td>
            <td>${x.fim}</td>
            <td>${escapeHtml(x.periodo)}</td>
            <td>${escapeHtml(x.mod)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
    ${
      String(r.modalidade || "").toLowerCase() === "presencial"
        ? `
          <div class="muted" style="margin-top:10px">
            <b>Observação (Presencial)</b><br/>
            Conforme contrato Prestação de Serviço: Para todo deslocamento, a CONTRATANTE deverá arcar com as respectivas despesas, inclusive
            as horas pelo tempo de deslocamento dos profissionais da CONTRATADA.
            <br/>a. Fica estipulado que para deslocamentos superiores a 300 Km (trezentos quilômetros), da sede da
            CONTRATADA, será utilizado transporte aéreo, mediante validação prévia com a
            CONTRATANTE.
            <br/>b. São consideradas despesas com viagem, todo o desembolso tido com hospedagem (que deverão
            ser suítes individuais, em hotéis com no mínimo 3 estrelas), traslado, alimentação/refeição,
            pedágios, estacionamento, etc.
            <br/>c. Quando a CONTRATADA antecipar esses desembolsos, prestará contas por meio de
            comprovantes (notas fiscais, recibos, tickets, etc).
            <br/>d. A CONTRATANTE deverá arcar com custo de KM para deslocamento de prepostos da
            CONTRATADA para refeições.
          </div>
        `
        : ""
    }
  `;
  w.document.write(`<!doctype html><html><head>${style}</head><body>${head}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
}
function resetClientes(){
  state.clients = DEFAULT_CLIENTS.map(c => ({
    id: crypto.randomUUID(),
    code: c.code,
    name: splitClientName(c.name).name || c.name,
    filial: splitClientName(c.name).filial || c.filial || "",
    analista: c.analista || "",
    gerenteRel: c.gerenteRel || "",
    gerenteCS: c.gerenteCS || ""
  }));
  state.editing.clienteId = null;
  $$("btnAddCliente").textContent = "Adicionar Cliente";
  saveState();
  renderClientes();
}

function resetHomologados(){
  state.homologados = DEFAULT_HOMOLOGADOS.map(h => ({
    id: crypto.randomUUID(),
    code: h.code || null,
    name: h.name,
    resources: h.resources || 0,
    months: h.months || 0,
    valorHora: Number(h.valorHora) || 0,
    valorHoraByProf: buildPartnerRateMap(h.valorHoraByProf, Number(h.valorHora) || 0),
    inicio: h.inicio || "",
    orderRank: null
  }));
  state.editing.homologadoId = null;
  $$("btnAddHomologado").textContent = "Adicionar Parceiro";
  state.lastOrderCount = 0;
  $$("kOrdem").textContent = "0";
  state.editModeHomologados = false;
  state.homologadosDirty = false;
  const btnSave = $$("btnSaveHomologados");
  if(btnSave) btnSave.style.display = "none";
  saveState();
  renderHomologados();
}

function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function findClientByCode(code){
  if(!code) return null;
  const norm = code.replace(/\s+/g, "").toLowerCase();
  const inState = state.clients.find(c => {
    const cc = (c.code || "").replace(/\s+/g, "").toLowerCase();
    if(cc && cc === norm) return true;
    const name = (c.name || "").replace(/\s+/g, "").toLowerCase();
    return name.startsWith(norm);
  });
  const inDefaults = DEFAULT_CLIENTS.find(c => {
    const cc = (c.code || "").replace(/\s+/g, "").toLowerCase();
    if(cc && cc === norm) return true;
    const name = (c.name || "").replace(/\s+/g, "").toLowerCase();
    return name.startsWith(norm);
  });
  if(inState){
    if(inDefaults && !inState.analista && inDefaults.analista){
      return { ...inState, analista: inDefaults.analista };
    }
    return inState;
  }
  return inDefaults || null;
}


function clearAllReservations(){
  // volta slots "R" para "L"
  state.consultants.forEach(c=>{
    c.schedule.forEach(s=>{
      if(s.status === "R") s.status = "L";
    });
  });
  state.reservations = [];
  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  state.selected.consultantId = null;
  saveState();
  renderFila();
  renderAgenda();
  renderResumo();
  renderValidation();
  toast("Reservas limpas", "Todas as reservas foram removidas.", "info", 2400);
}

function renderResumo(){
  const tbody = $$("tbodyResumo");
  const empty = $$("resumoEmpty");
  if(!tbody) return;

  tbody.innerHTML = "";

  const listToSend = state.reservations.filter(r => r.sentToTower !== true);
  const totalReq = listToSend.length;
  const totalTurnos = listToSend.reduce((s,r)=> s + (r.slots?.length || 0), 0);

  const kTurnos = $$("kResTurnos");
  const kReq = $$("kResReq");
  if(kTurnos) kTurnos.textContent = String(totalTurnos);
  if(kReq) kReq.textContent = String(totalReq);

  if(totalReq === 0){
    if(empty) empty.style.display = "block";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted">—</td>`;
    tbody.appendChild(tr);
    return;
  }
  if(empty) empty.style.display = "none";

  // 1 linha por DIA reservado (se Manhã + Tarde => "Dia todo")
  const rows = [];
  listToSend.forEach(r=>{
      const parceiroInf = r.demanda?.nomeCliente || "—";
      const solicitacao = r.demanda?.origem || "—";
      const osNumero = r.demanda?.osNumero || "—";
      const pack = r.demanda?.pack || "—";
      const detalhe = r.demanda?.detalhe || "—";
      const consultor = r.consultant?.name || "—";
      const parceiroHom = r.consultant?.partnerName || "—";
      const byDay = new Map();
      (r.slots || []).forEach(s=>{
        const key = s.day || "—";
        const list = byDay.get(key) || [];
        list.push(s.period || "—");
        byDay.set(key, list);
      });
      const baseConsultant = state.consultants.find(x=>x.id===r.consultant?.id) || r.consultant || null;
      const valorHora = baseConsultant ? getValorHoraValue(baseConsultant) : 0;
      byDay.forEach((periods, dayKeyRaw) => {
        const norm = periods.map(p => String(p || "").toLowerCase());
        const hasManha = norm.some(p => p.includes("manhã") || p.includes("manha"));
        const hasTarde = norm.some(p => p.includes("tarde"));
        let periodo = "—";
        if(hasManha && hasTarde){
          periodo = "Dia todo";
        } else {
          const uniq = Array.from(new Set(periods.map(p => p || "—")));
          periodo = uniq.join(" / ");
        }
        const horas = periods.length * 4;
        const total = valorHora > 0 ? (horas * valorHora) : 0;
        const d = dayKeyRaw !== "—" ? fmtDate(dayKeyRaw) : "—";
        rows.push({
          svr: r.svr || "SVR-—",
          parceiroInf,
          solicitacao,
          osNumero,
          pack,
          detalhe,
          consultor,
          parceiroHom,
          ini: d,
          fim: d,
          periodo,
          mod: (r.modalidade || "—"),
          horas,
          valorHora,
          total
        });
      });
  });

  rows
    .sort((a,b)=> a.ini.localeCompare(b.ini))
    .forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(x.svr)}</td>
        <td>${escapeHtml(x.parceiroInf)}</td>
        <td>${escapeHtml(x.solicitacao)}</td>
        <td>${escapeHtml(x.osNumero)}</td>
        <td><b>${escapeHtml(x.pack)}</b></td>
        <td>${escapeHtml(x.detalhe)}</td>
        <td>${escapeHtml(x.consultor)}</td>
        <td>${escapeHtml(x.parceiroHom)}</td>
        <td>${x.ini}</td>
        <td>${x.fim}</td>
        <td>${escapeHtml(x.periodo)}</td>
        <td>${x.mod}</td>
        <td>${x.horas ? `${x.horas}h` : "—"}</td>
        <td>${x.valorHora ? formatBRL(x.valorHora) : "—"}</td>
        <td>${x.total ? formatBRL(x.total) : "—"}</td>
      `;
      tbody.appendChild(tr);
    });
}

function getAllProficiencias(){
  const set = new Set();
  const addNivel = (n) => {
    const key = String(n || "").trim();
    if(key) set.add(key);
  };
  state.terceiros.forEach(t => {
    (t.packLevels || []).forEach(p => addNivel(p.nivel));
  });
  state.clt.forEach(c => {
    (c.packLevels || []).forEach(p => addNivel(p.nivel));
  });
  return Array.from(set).sort((a,b)=> a.localeCompare(b));
}

function renderValorHora(){
  const tbody = $$("tbodyValorHora");
  const empty = $$("valorHoraEmpty");
  const count = $$("kValorHoraCount");
  if(!tbody) return;

  tbody.innerHTML = "";
  const profs = getAllProficiencias();
  if(count) count.textContent = String(profs.length);

  if(profs.length === 0){
    if(empty) empty.style.display = "block";
    return;
  }
  if(empty) empty.style.display = "none";

  profs.forEach(nivel => {
    const tr = document.createElement("tr");
    const tdP = document.createElement("td");
    tdP.textContent = nivel;
    const tdV = document.createElement("td");
    const input = document.createElement("input");
    input.setAttribute("inputmode", "numeric");
    input.placeholder = "R$ 0,00";
    input.dataset.money = "valor-hora";
    input.dataset.pack = nivel;
    const val = state.valorHora?.[nivel];
    if(Number.isFinite(val) && val > 0){
      input.value = formatBRL(val);
    }
    tdV.appendChild(input);
    tr.appendChild(tdP);
    tr.appendChild(tdV);
    tbody.appendChild(tr);
  });
}

function saveValorHoraVendida(){
  const rows = Array.from(document.querySelectorAll("#tbodyValorHora input[data-money='valor-hora']"));
  rows.forEach(input => {
    const key = input.dataset.pack;
    if(!key) return;
    const value = parseBRL(input.value);
    if(value === null){
      delete state.valorHora[key];
      input.value = "";
      return;
    }
    state.valorHora[key] = value;
    input.value = formatBRL(value);
  });
  saveState();
  toast("Valores salvos", "Valor hora vendida atualizado com sucesso.", "info", 2200);
}

function renderValidation(){
  const tbody = $$("tbodyValidacao");
  tbody.innerHTML = "";

  const list = state.reservations.filter(r=>r.sentToTower === true);
  const pend = list.filter(r=>r.status==="PENDENTE").length;
  const ap = list.filter(r=>r.status==="APROVADA").length;
  const rep = list.filter(r=>r.status==="REPROVADA").length;
  $$("kPend").textContent = pend;
  $$("kAp").textContent = ap;
  $$("kRep").textContent = rep;
  const totalValidadas = ap + rep;
  $$("kTaxa").textContent = totalValidadas ? `${Math.round((ap / totalValidadas) * 100)}%` : "—";

  const tempos = list
    .filter(r => r.status !== "PENDENTE" && r.validatedAt && r.demanda?.createdAt)
    .map(r => {
      const a = new Date(r.demanda.createdAt);
      const b = new Date(r.validatedAt);
      return isNaN(a) || isNaN(b) ? null : (b - a) / 36e5;
    })
    .filter(x => x !== null && x >= 0);

  const avgHoras = tempos.length ? (tempos.reduce((s,v)=>s+v,0) / tempos.length) : null;
  $$("kTempo").textContent = avgHoras === null ? "—" : `${avgHoras.toFixed(1)}h`;

  if(list.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">Nenhuma reserva enviada para validação ainda.</td>`;
    tbody.appendChild(tr);
    return;
  }

  const vquery = ($$("validBuscaSvr")?.value || "").trim().toLowerCase();
  const vstatus = ($$("validStatus")?.value || "ALL").trim().toUpperCase();
  list
    .slice()
    .sort((a,b)=> new Date(b.demanda.createdAt) - new Date(a.demanda.createdAt))
    .filter(r => !vquery || String(r.svr || "").toLowerCase().includes(vquery))
    .filter(r => vstatus === "ALL" || String(r.status || "").trim().toUpperCase() === vstatus)
    .forEach(r=>{
      const tr = document.createElement("tr");
      const partnerOrder = Number.isFinite(r.partnerOrder) ? r.partnerOrder : getPartnerOrderByName(r.consultant?.partnerName);
      const expectedOrder = Number.isFinite(r.expectedOrder) ? r.expectedOrder : getCurrentExpectedOrder();
      const outOfSeq = Number.isFinite(partnerOrder) && Number.isFinite(expectedOrder) && partnerOrder !== expectedOrder;
      const origemTag = (r.demanda?.origem || "").trim().toLowerCase() === "contato direto"
        ? ` <span class="tag-origem">Contato direto</span>`
        : "";
      const demandaTxt = `
        <div class="meta">
          <div><b>${r.demanda.nomeCliente}</b> <span class="tag">${statusLabel(r.status)}</span> <span class="tag">${r.svr || "SVR-—"}</span></div>
          <div class="sub">Código: <b>${r.demanda.codCliente}</b> • Origem: <b>${r.demanda.origem}</b>${origemTag}${r.demanda.osNumero ? ` • OS: <b>${r.demanda.osNumero}</b>` : ""}</div>
          <div class="sub">Pack: <b>${r.demanda.pack}</b></div>
          <div class="sub">Período da consulta: <b>${fmtDateSafe(r.demanda.dtIni)} → ${fmtDateSafe(r.demanda.dtFim)}</b></div>
          <div class="sub">Detalhamento: <b>${escapeHtml(r.demanda.detalhe || "—")}</b></div>
          ${outOfSeq ? `<div class="sub warn-text">Fora da sequência da fila</div>` : ""}
        </div>
      `;
      const prioridadeList = normalizePriorityAvail(r.prioridadeDisponivel);
      const prioridadeMsgs = [];
      if(prioridadeList.includes("CLT_DB")) prioridadeMsgs.push("Há Agendas Disponível do CLT DB");
      if(prioridadeList.includes("TERCEIRO_PRESENCIAL")) prioridadeMsgs.push("Há Agenda disponível Terceiro Presencial");
      const prioridadeLine = prioridadeMsgs.length
        ? prioridadeMsgs.map(t => `<div class="sub" style="color:#f59e0b;font-weight:800;margin-top:6px">${t}</div>`).join("")
        : "";
      const consTxt = `
        <div class="meta">
          <div>
            <b>${r.consultant.name}</b>
            <span class="tag">${r.consultant.type}</span>
            ${
              (String(r.modalidade || "").toLowerCase() === "presencial")
                ? `<span class="tag" style="background:#f59e0b;color:#111">Presencial</span>`
                : `<span class="tag">Remoto</span>`
            }
          </div>
          <div class="sub">Senioridade: <b>${r.consultant.seniority}</b></div>
          <div class="sub">Proficiência: <b>${r.consultant.profShort || "—"}</b></div>
          <div class="sub">Parceiro: <b>${r.consultant.partnerName}</b></div>
          ${prioridadeLine}
        </div>
      `;
      const slotsByDay = new Map();
      (r.slots || []).forEach(s=>{
        const key = s.day || "—";
        const list = slotsByDay.get(key) || [];
        list.push(s.period || "—");
        slotsByDay.set(key, list);
      });
      const slotsLines = Array.from(slotsByDay.entries()).map(([dayKeyRaw, periods])=>{
        const norm = periods.map(p => String(p || "").toLowerCase());
        const hasManha = norm.some(p => p.includes("manhã") || p.includes("manha"));
        const hasTarde = norm.some(p => p.includes("tarde"));
        let periodo = "—";
        if(hasManha && hasTarde){
          periodo = "Dia todo";
        } else {
          const uniq = Array.from(new Set(periods.map(p => p || "—")));
          periodo = uniq.join(" / ");
        }
        const d = dayKeyRaw !== "—" ? fmtDate(dayKeyRaw) : "—";
        return `• <b>${d}</b> – ${periodo}`;
      });
      const baseConsultant = state.consultants.find(x=>x.id===r.consultant?.id) || r.consultant || null;
      const totalHoras = (r.slots?.length || 0) * 4;
      const vh = baseConsultant ? getValorHoraValueFor(r.demanda?.pack || "", baseConsultant) : 0;
      const totalValor = vh > 0 ? (totalHoras * vh) : 0;
      const slotsTxt = `
        <div class="small">
          ${slotsLines.join("<br/>")}
        </div>
        <div class="small muted" style="margin-top:6px">
          Horas: <b>${totalHoras || 0}h</b> • Valor hora: <b>${vh ? formatBRL(vh) : "—"}</b> • Total: <b>${totalValor ? formatBRL(totalValor) : "—"}</b>
        </div>
        ${r.obs ? `<div class="small muted" style="margin-top:8px">Obs: ${escapeHtml(r.obs)}</div>` : ""}
      `;

      const controls = document.createElement("div");
      controls.className = "meta";

      const note = document.createElement("textarea");
      note.placeholder = "Observação do validador (opcional)";
      note.value = r.validatorNote || "";
      note.style.minHeight = "70px";
      note.dataset.noteId = r.id;

      const btnRow = document.createElement("div");
      btnRow.className = "actions";
      btnRow.style.marginTop = "8px";

      const btnA = document.createElement("button");
      btnA.className = "primary";
      btnA.textContent = "Aprovar";
      btnA.disabled = r.status !== "PENDENTE" || (r.towerChanges || 0) > 0;

      const btnR = document.createElement("button");
      btnR.className = "danger";
      btnR.textContent = "Reprovar";
      btnR.disabled = r.status !== "PENDENTE" || (r.towerChanges || 0) > 0;

      const btnT = document.createElement("button");
      btnT.textContent = "Trocar";
      btnT.disabled = r.status !== "PENDENTE";

      const statusLine = document.createElement("div");
      statusLine.className = "small muted";
      statusLine.innerHTML = r.validatedAt ? `Validado em: <b>${fmtDate(r.validatedAt)}</b>` : `Aguardando validação`;

      btnA.addEventListener("click", ()=>{
        if((r.towerChanges || 0) > 0) return;
        r.status = "APROVADA";
        r.validatedAt = new Date().toISOString();
        r.validatorNote = note.value.trim();
        saveState();
        renderValidation();
      });
      btnR.addEventListener("click", ()=>{
        if((r.towerChanges || 0) > 0) return;
        if(!note.value.trim()){
          toast("Observação obrigatória", "Informe a observação do validador para reprovar.", "warn", 2800);
          note.focus();
          return;
        }
        r.status = "REPROVADA";
        r.validatedAt = new Date().toISOString();
        r.validatorNote = note.value.trim();
        saveState();
        renderValidation();
      });
      btnT.addEventListener("click", ()=> openSwapModal(r.id));

      btnRow.appendChild(btnA);
      btnRow.appendChild(btnR);
      btnRow.appendChild(btnT);

      controls.appendChild(note);
      controls.appendChild(btnRow);
      controls.appendChild(statusLine);

      const td1 = document.createElement("td"); td1.innerHTML = demandaTxt;
      const td2 = document.createElement("td"); td2.innerHTML = consTxt;
      const td3 = document.createElement("td"); td3.innerHTML = slotsTxt;
      const td4 = document.createElement("td"); td4.appendChild(controls);

      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
      tbody.appendChild(tr);
    });
}

function renderAcompanhamento(){
  const tbody = $$("tbodyAcompanhamento");
  if(!tbody) return;
  tbody.innerHTML = "";

  const pend = state.reservations.filter(r=>r.status==="PENDENTE").length;
  const ap = state.reservations.filter(r=>r.status==="APROVADA").length;
  const alt = state.reservations.filter(r=>(r.towerChanges || 0) > 0).length;
  $$("kAcompPend").textContent = pend;
  $$("kAcompAp").textContent = ap;
  $$("kAcompAlt").textContent = alt;

  if(state.reservations.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" class="muted">Nenhuma solicitação registrada.</td>`;
    tbody.appendChild(tr);
    return;
  }

  const query = ($$("acompBuscaSvr")?.value || "").trim().toLowerCase();
  const qStatus = ($$("acompStatus")?.value || "ALL").trim().toUpperCase();
  state.reservations
    .slice()
    .sort((a,b)=> new Date(b.demanda.createdAt) - new Date(a.demanda.createdAt))
    .filter(r => r.sentToTower === true)
    .filter(r => !query || String(r.svr || "").toLowerCase().includes(query))
    .filter(r => qStatus === "ALL" || String(r.status || "").trim().toUpperCase() === qStatus)
    .forEach(r=>{
      const tr = document.createElement("tr");
      const det = r.demanda?.detalhe || "";
      const solicitacao = `${r.demanda?.nomeCliente || "—"} • ${r.demanda?.pack || "—"}${det ? ` • ${det}` : ""}`;
      const statusTxt = statusLabel(r.status);
      const statusUp = String(r.status || "").trim().toUpperCase();
      const isAprovada = statusUp === "APROVADA";
      const isReprovada = statusUp === "REPROVADA";
      const isPendente = statusUp === "PENDENTE";
      const hasTroca = (r.towerChanges || 0) > 0;
      const statusOverrideRaw = (isPendente && hasTroca) ? "Aguardando Aprovação Analista Base" : statusTxt;
      const statusOverride = (statusUp === "CANCELADA_FATURADA")
        ? `<span style="color:#ef4444;font-weight:900">${statusOverrideRaw}</span>`
        : statusOverrideRaw;
      const msgTxt = isAprovada ? "Parabéns Agenda Confirma!" : (isReprovada ? "Caso dúvida acionar Líder da torre" : "");
      const altTxt = (r.towerChanges || 0) > 0 ? `Sim (${r.towerChanges})` : "Não";
      const swapInfo = r.pendingSwap
        ? `Troca sugerida: ${r.pendingSwap.from?.consultant?.name || "—"} (${fmtDate(r.pendingSwap.from?.slots?.[0]?.day)} • ${r.pendingSwap.from?.slots?.[0]?.period}) → ${r.pendingSwap.to?.consultant?.name || "—"} (${fmtDate(r.pendingSwap.to?.slots?.[0]?.day)} • ${r.pendingSwap.to?.slots?.[0]?.period})`
        : "";
      const hist = Array.isArray(r.swapHistory) ? r.swapHistory : [];
      const histHtml = hist.length
        ? `<div class="small muted" style="margin-top:6px">Histórico: ${hist.slice(-3).map(h=>`• ${h.from?.consultant?.name || "—"} → ${h.to?.consultant?.name || "—"} (${fmtDate(h.to?.slots?.[0]?.day)} • ${h.to?.slots?.[0]?.period})`).join(" ")}</div>`
        : "";
      const baseConsultant = state.consultants.find(x=>x.id===r.consultant?.id) || r.consultant || null;
      const totalHoras = (r.slots?.length || 0) * 4;
      const vh = baseConsultant ? getValorHoraValueFor(r.demanda?.pack || "", baseConsultant) : 0;
      const totalValor = vh > 0 ? (totalHoras * vh) : 0;
      const custosLine = `Horas: <b>${totalHoras || 0}h</b> • Valor hora: <b>${vh ? formatBRL(vh) : "—"}</b> • Total: <b>${totalValor ? formatBRL(totalValor) : "—"}</b>`;
      const pdfCell = isAprovada
        ? `<label style="display:flex;align-items:center;gap:6px"><input type="checkbox" data-pdf-id="${r.id}" ${r.pdfConfirmed ? "checked" : ""}/> PDF</label>`
        : "—";
      const cancelBtn = (r.status !== "CANCELADA" && r.status !== "CANCELADA_FATURADA")
        ? `<button class="btn-sm danger" data-cancel-req-id="${r.id}">Solicitar cancelamento</button>`
        : "";
      const actionCell = (isPendente && hasTroca)
        ? `<div class="actions tight" style="margin:0">
             <button class="btn-sm" data-aceitar-id="${r.id}">Aceitar</button>
             <button class="btn-sm danger" data-cancelar-id="${r.id}">Cancelar</button>
             ${cancelBtn}
           </div>`
        : (cancelBtn ? `<div class="actions tight" style="margin:0">${cancelBtn}</div>` : "—");
      const slotsByDay = new Map();
      (r.slots || []).forEach(s=>{
        const key = s.day || "—";
        const list = slotsByDay.get(key) || [];
        list.push(s.period || "—");
        slotsByDay.set(key, list);
      });
      const slotsLines = Array.from(slotsByDay.entries()).map(([dayKeyRaw, periods])=>{
        const norm = periods.map(p => String(p || "").toLowerCase());
        const hasManha = norm.some(p => p.includes("manhã") || p.includes("manha"));
        const hasTarde = norm.some(p => p.includes("tarde"));
        let periodo = "—";
        if(hasManha && hasTarde){
          periodo = "Dia todo";
        } else {
          const uniq = Array.from(new Set(periods.map(p => p || "—")));
          periodo = uniq.join(" / ");
        }
        const d = dayKeyRaw !== "—" ? fmtDate(dayKeyRaw) : "—";
        return `${d} • ${periodo}`;
      });
      const dataPeriodo = slotsLines.length ? slotsLines.join("<br/>") : "—";
      tr.innerHTML = `
        <td>${escapeHtml(r.svr || "SVR-—")}</td>
        <td>${escapeHtml(solicitacao)}</td>
        <td>${escapeHtml(r.consultant?.name || "—")}</td>
        <td>${dataPeriodo}</td>
        <td>${statusOverride}${msgTxt ? `<div class="small" style="color:${isReprovada ? "var(--orange)" : "var(--green)"}; font-weight:800; margin-top:4px">${msgTxt}</div>` : ""}</td>
        <td>${altTxt}</td>
        <td>${escapeHtml(r.validatorNote || "—")}${swapInfo ? `<div class="small muted" style="margin-top:6px">${escapeHtml(swapInfo)}</div>` : ""}<div class="small muted" style="margin-top:6px">${custosLine}</div>${histHtml}</td>
        <td>${actionCell}</td>
        <td>${pdfCell}</td>
      `;
      const btnAceitar = tr.querySelector('[data-aceitar-id]');
      if(btnAceitar){
        btnAceitar.addEventListener("click", ()=>{
          const target = state.reservations.find(x=>x.id===r.id);
          if(!target) return;
          if(target.pendingSwap) applyPendingSwap(target);
          target.status = "APROVADA";
          target.validatedAt = new Date().toISOString();
          target.towerChanges = 0;
          target.lastTowerChange = null;
          saveState();
          renderAcompanhamento();
          renderValidation();
        });
      }
      const btnCancelar = tr.querySelector('[data-cancelar-id]');
      if(btnCancelar){
        btnCancelar.addEventListener("click", ()=>{
          const target = state.reservations.find(x=>x.id===r.id);
          if(!target) return;
          if(target.pendingSwap){
            target.pendingSwap = null;
            target.towerChanges = 0;
            target.lastTowerChange = null;
            target.status = "PENDENTE";
            target.validatedAt = null;
          } else {
            target.status = "CANCELADA";
            target.validatedAt = new Date().toISOString();
          }
          saveState();
          renderAcompanhamento();
          renderValidation();
        });
      }
      const cb = tr.querySelector('[data-pdf-id]');
      if(cb){
        cb.addEventListener("change", () => {
          if(!cb.checked){
            const target = state.reservations.find(x=>x.id===r.id);
            if(!target) return;
            target.pdfConfirmed = false;
            saveState();
            renderAcompanhamento();
            return;
          }
          const target = state.reservations.find(x=>x.id===r.id);
          if(!target) return;
          target.pdfConfirmed = true;
          saveState();
          renderAcompanhamento();
          printResumoForReservation(target);
        });
      }
      const btnCancelReq = tr.querySelector('[data-cancel-req-id]');
      if(btnCancelReq){
        btnCancelReq.addEventListener("click", ()=>{
          openCancelModal(r);
        });
      }
      tbody.appendChild(tr);
    });
}

loadState();
updateOsVisibility();
setTodayIfEmpty();

const codigoEl = $$("cCodigo");
const nomeEl = $$("cNome");
if(codigoEl && nomeEl){
  codigoEl.addEventListener("input", () => {
    const code = codigoEl.value.trim();
    if(!code) return;
    const match = findClientByCode(code);
    if(match){
      nomeEl.value = match.name;
      const filialEl = $$("cFilial");
      if(filialEl && match.filial) filialEl.value = match.filial;
      const analistaEl = $$("cAnalista");
      if(analistaEl && match.analista) analistaEl.value = match.analista;
      const gerRelEl = $$("cGerRel");
      if(gerRelEl && match.gerenteRel) gerRelEl.value = match.gerenteRel;
      const gerCsEl = $$("cGerCS");
      if(gerCsEl && match.gerenteCS) gerCsEl.value = match.gerenteCS;
    }
  });
}

function renderTerceiros(){
  const list = $$("terceirosList");
  const countEl = $$("terceirosCount");
  if(!list) return;
  list.innerHTML = "";
  if(countEl) countEl.textContent = String(state.terceiros.length || 0);
  if(state.terceiros.length === 0){
    list.innerHTML = `<div class="hint">Sem registros</div>`;
    return;
  }
  state.terceiros.forEach(t => {
    const card = document.createElement("div");
    card.className = "terceiro-card";
    const parceiro = escapeHtml(String(t.empresa || t.codigo || "—"));
    const nome = escapeHtml(String(t.nome || "—"));
    const funcao = escapeHtml(String(t.funcao || "—"));
    const senior = escapeHtml(String(t.senioridade || "—"));
    const modalidade = escapeHtml(String(t.modalidade || "—"));
    const disponivel = t.disponivel ? fmtDateSafe(t.disponivel) : "—";
    const presencial = t.presencial ? "Presencial" : "Remoto";
    const filial = t.presencial ? escapeHtml(String(t.filialSlim || "—")) : "—";
    const presencialMsg = t.presencial
      ? `<div class="small" style="color:#f59e0b; font-weight:800; margin-top:6px">Presencial • ${filial}</div>`
      : "";
    const packLevels = Array.isArray(t.packLevels) ? t.packLevels : [];
    const packsHtml = packLevels.length
      ? packLevels.map(p => `<span class="pack-pill"><b>${escapeHtml(p.pack || "—")}</b> • ${escapeHtml(shortNivelLabel(p.nivel))}</span>`).join("")
      : `<span class="muted">Sem packs definidos</span>`;
    card.innerHTML = `
      <div class="terceiro-top">
        <div>
          <div class="terceiro-name">${nome}</div>
          <div class="terceiro-sub">${parceiro}</div>
        </div>
        <div class="terceiro-actions">
          <button class="btn-sm" data-define="${t.id}">Definir Proficiencia do Recurso</button>
          <button class="btn-sm danger" data-del="${t.id}">Remover</button>
        </div>
      </div>
      <div class="terceiro-meta">
        <span class="meta-pill">Função: <b>${funcao}</b></span>
        <span class="meta-pill">Senioridade: <b>${senior}</b></span>
        <span class="meta-pill">Modalidade: <b>${modalidade}</b></span>
        <span class="meta-pill">Disponível: <b>${disponivel}</b></span>
        <span class="meta-pill">Atuação: <b>${presencial}</b></span>
      </div>
      ${presencialMsg}
      <div class="pack-list">${packsHtml}</div>
    `;
    card.querySelector("[data-define]").addEventListener("click", ()=> openTerceiroModal(t.id, "terceiros"));
    card.querySelector("[data-del]").addEventListener("click", ()=>{
      if(!confirm("Remover este recurso?")) return;
      state.terceiros = state.terceiros.filter(x => x.id !== t.id);
      saveState();
      renderTerceiros();
    });
    list.appendChild(card);
  });
}

function renderClt(){
  const list = $$("cltList");
  const countEl = $$("cltCount");
  if(!list) return;
  list.innerHTML = "";
  if(countEl) countEl.textContent = String(state.clt.length || 0);
  if(state.clt.length === 0){
    list.innerHTML = `<div class="hint">Sem registros</div>`;
    return;
  }
  state.clt.forEach(c => {
    const card = document.createElement("div");
    card.className = "terceiro-card";
    const nome = escapeHtml(String(c.nome || "—"));
    const cargo = escapeHtml(String(c.cargo || "—"));
    const senior = escapeHtml(String(c.senioridade || "—"));
    const gestor = escapeHtml(String(c.gestor || "—"));
    const email = escapeHtml(String(c.email || "—"));
    const telefone = escapeHtml(String(c.telefone || "—"));
    const disponivel = c.disponivel ? fmtDateSafe(c.disponivel) : "—";
    const packLevels = Array.isArray(c.packLevels) ? c.packLevels : [];
    const packsHtml = packLevels.length
      ? packLevels.map(p => `<span class="pack-pill"><b>${escapeHtml(p.pack || "—")}</b> • ${escapeHtml(shortNivelLabel(p.nivel))}</span>`).join("")
      : `<span class="muted">Sem packs definidos</span>`;
    card.innerHTML = `
      <div class="terceiro-top">
        <div>
          <div class="terceiro-name">${nome}</div>
          <div class="terceiro-sub">RECURSO SANKHYA • ${cargo}</div>
        </div>
        <div class="terceiro-actions">
          <button class="btn-sm" data-define="${c.id}">Definir proficiencia Recurso</button>
          <button class="btn-sm danger" data-del="${c.id}">Remover</button>
        </div>
      </div>
      <div class="terceiro-meta">
        <span class="meta-pill">Senioridade: <b>${senior}</b></span>
        <span class="meta-pill">Gestor: <b>${gestor}</b></span>
        <span class="meta-pill">Disponível: <b>${disponivel}</b></span>
      </div>
      <div class="terceiro-meta">
        <span class="meta-pill">E-mail: <b>${email}</b></span>
        <span class="meta-pill">Telefone: <b>${telefone}</b></span>
      </div>
      <div class="pack-list">${packsHtml}</div>
    `;
    card.querySelector("[data-define]").addEventListener("click", ()=> openTerceiroModal(c.id, "clt"));
    card.querySelector("[data-del]").addEventListener("click", ()=>{
      if(!confirm("Remover este Recurso Sankhya?")) return;
      state.clt = state.clt.filter(x => x.id !== c.id);
      saveState();
      renderClt();
    });
    list.appendChild(card);
  });
}

const demCodEl = $$("inCodCliente");
const demNomeEl = $$("inNomeCliente");
if(demCodEl && demNomeEl){
  demCodEl.addEventListener("input", () => {
    const code = demCodEl.value.trim();
    const hasOrder = state.homologados.some(h => Number.isFinite(h.orderRank));
    if(code && !hasOrder){
      openInfoModal("Para iniciar os teste desta MVP deve primeiro entrar na Aba Parceiro Homologados e clicar em Gerar Ordem da Fila. Após a ordem ser gerado voltar na Aba Localizar Recursos e colocar código do parceiro.");
    }
    if(!code){
      demNomeEl.value = "";
      const filialEl = $$("inFilial");
      if(filialEl) filialEl.value = "";
      const analistaEl = $$("inAnalista");
      if(analistaEl) analistaEl.value = "";
      return;
    }
    const match = findClientByCode(code);
    if(match){
      demNomeEl.value = match.name;
      const filialEl = $$("inFilial");
      if(filialEl && match.filial) filialEl.value = match.filial;
      const analistaEl = $$("inAnalista");
      if(analistaEl && match.analista) analistaEl.value = match.analista;
      const gerRelEl = $$("inGerRel");
      if(gerRelEl && match.gerenteRel) gerRelEl.value = match.gerenteRel;
      const gerCsEl = $$("inGerCS");
      if(gerCsEl && match.gerenteCS) gerCsEl.value = match.gerenteCS;
    }
  });
}

const origemEl = $$("inOrigem");
if(origemEl){
  origemEl.addEventListener("change", updateOsVisibility);
}

const iniEl = $$("inDtIni");
if(iniEl){
  iniEl.addEventListener("change", setFimFromInicio);
}

const osInputEl = $$("inOS");
if(osInputEl){
  osInputEl.addEventListener("input", () => {
    osInputEl.value = osInputEl.value.replace(/\D+/g, "");
  });
}

const swapDataEl = $$("swapData");
if(swapDataEl){
  swapDataEl.addEventListener("change", renderSwapOptions);
}
const btnSwapNext = $$("btnSwapNext");
if(btnSwapNext){
  btnSwapNext.addEventListener("click", ()=>{
    const ordered = getOrderedHomologados();
    if(!ordered.length){
      toast("Ordem não gerada", "Gere a ordem da fila para listar opções.", "warn", 2600);
      return;
    }
    state.swapPartnerIndex = (state.swapPartnerIndex + 1) % ordered.length;
    renderSwapOptions();
  });
}

const hCodeEl = $$("hCodigo");
if(hCodeEl){
  hCodeEl.addEventListener("input", () => {
    const code = hCodeEl.value.trim();
    const hint = $$("homologadoHint");
    if(!code){
      state.editing.homologadoId = null;
      if(hint) hint.style.display = "none";
      $$("btnAddHomologado").textContent = "Adicionar Parceiro";
      return;
    }
    const existing = findHomologadoByCode(code);
    if(existing){
      loadHomologadoForm(existing);
      state.lastHomologadoWarn = "";
    } else {
      state.editing.homologadoId = null;
      $$("btnAddHomologado").textContent = "Adicionar Parceiro";
      $$("hValorHoraExecutor").value = "";
      $$("hValorHoraAutonomo").value = "";
      $$("hValorHoraProficiente").value = "";
      $$("hValorHoraReferencia").value = "";
      if(hint) hint.style.display = "none";
      if(code && state.lastHomologadoWarn !== code){
        state.lastHomologadoWarn = code;
        toast(
          "Parceiro não encontrado",
          "Para iniciar o teste da MVP da Solicitação de Viabilidade de Recurso, inicie o teste clicando na Aba Parceiros Homologados e Gerar Ordem da Fila.",
          "warn",
          5200
        );
      }
    }
  });
}

const validBusca = $$("validBuscaSvr");
if(validBusca){
  validBusca.addEventListener("input", renderValidation);
}
const validStatus = $$("validStatus");
if(validStatus){
  validStatus.addEventListener("change", renderValidation);
}

let pendingCancelId = null;
function openCancelModal(res){
  pendingCancelId = res?.id || null;
  const box = $$("cancelBackdrop");
  const msg = $$("cancelMsg");
  const warn = $$("cancelWarn");
  if(!box || !msg || !warn) return;
  const start = getReservationStartDate(res);
  if(start){
    const limite = new Date(start.getTime() - (48 * 60 * 60 * 1000));
    msg.textContent = `Deseja confirmar o cancelamento? Início da agenda: ${fmtDateSafe(start)}.`;
    if(new Date() > limite){
      warn.style.display = "block";
    } else {
      warn.style.display = "none";
    }
  } else {
    msg.textContent = "Deseja confirmar o cancelamento?";
    warn.style.display = "none";
  }
  box.style.display = "flex";
}
function closeCancelModal(){
  const box = $$("cancelBackdrop");
  if(box) box.style.display = "none";
  pendingCancelId = null;
}
function confirmCancel(){
  if(!pendingCancelId) return closeCancelModal();
  const target = state.reservations.find(x=>x.id===pendingCancelId);
  if(!target) return closeCancelModal();
  const start = getReservationStartDate(target);
  const limite = start ? new Date(start.getTime() - (48 * 60 * 60 * 1000)) : null;
  const now = new Date();
  const dentroPrazo = !limite || now <= limite;
  if(dentroPrazo){
    target.status = "CANCELADA";
    releaseReservationSlots(target);
  } else {
    target.status = "CANCELADA_FATURADA";
  }
  target.validatedAt = new Date().toISOString();
  saveState();
  renderAcompanhamento();
  renderValidation();
  closeCancelModal();
}

$$("btnCloseCancel")?.addEventListener("click", closeCancelModal);
$$("btnCancelNo")?.addEventListener("click", closeCancelModal);
$$("btnCancelYes")?.addEventListener("click", confirmCancel);


[
  "inCodCliente",
  "inNomeCliente",
  "inFilial",
  "inAnalista",
  "inTelefoneContato",
  "inEmailContato",
  "inLinkReuniao",
  "inOrigem",
  "inPack",
  "inDetalhe",
  "inOS",
  "inDtIni",
  "inDtFim",
  "inFiltroTipo",
  "inFiltroSenioridade"
].forEach(id => {
  const el = $$(id);
  if(!el) return;
  const evt = (el.tagName === "SELECT" || el.type === "date") ? "change" : "input";
  el.addEventListener(evt, () => {
    state.priorityChecked = false;
    updatePriorityHint();
    saveState();
  });
});

$$("btnGerarFila").addEventListener("click", ()=>{
  const v = validateDemandaInputs();
  if(!v.ok){ toast("Campos obrigatórios", v.msg, "warn", 3200); return; }
  const filtroTipo = $$("inFiltroTipo")?.value || "TERCEIRO";
  const isBpFilter = filtroTipo === "BP";
  const ordered = getOrderedHomologados();
  if(isBpFilter){
    state.currentPartnerIndex = 0;
    state.consultants = generateConsultants($$("inDtIni").value, $$("inDtFim").value);
  } else if(ordered.length){
    state.currentPartnerIndex = 0;
    const firstPartner = ordered[0];
    state.consultants = generateConsultants($$("inDtIni").value, $$("inDtFim").value, firstPartner);
  } else {
    toast("Ordem não definida", "Gere a ordem da fila dos homologados para aplicar a prioridade.", "warn", 2800);
    state.consultants = generateConsultants($$("inDtIni").value, $$("inDtFim").value);
  }

  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  state.selected.consultantId = null;

  renderFila();
  state.priorityChecked = true;
  updatePriorityHint();
  saveState();
  if(isBpFilter && state.consultants.length === 0){
    toast("Sem BP cadastrado", "Cadastre recursos com empresa BP para exibir resultados.", "warn", 2600);
    return;
  }
  toast("Fila atualizada", isBpFilter ? "Todos os recursos BP cadastrados foram carregados." : "Consultores do primeiro parceiro na fila.", "info", 2200);
});

function proceedNextPartner(partner){
  state.consultants = generateConsultants($$("inDtIni").value, $$("inDtFim").value, partner);
  state.selected.consultantId = null;
  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  renderFila();
  updatePriorityHint();
  toast("Próximo da fila", `Parceiro: ${partner.name}`, "info", 2200);
}

$$("btnProximoFila").addEventListener("click", ()=>{
  const filtroTipo = $$("inFiltroTipo")?.value || "TERCEIRO";
  if(filtroTipo === "BP"){
    state.consultants = generateConsultants($$("inDtIni").value, $$("inDtFim").value);
    state.selected.consultantId = null;
    state.selected.slotKeys.clear();
    state.selected.lastIndex = null;
    renderFila();
    updatePriorityHint();
    toast("Sugestões BP", "Nova rodada aleatória de recursos e agendas BP.", "info", 2200);
    return;
  }
  const ordered = getOrderedHomologados();
  if(!ordered.length){
    toast("Ordem não definida", "Gere a ordem da fila dos homologados para aplicar a prioridade.", "warn", 2800);
    return;
  }
  const nextIdx = (state.currentPartnerIndex + 1) % ordered.length;
  const partner = ordered[nextIdx];
  state.currentPartnerIndex = nextIdx;
  proceedNextPartner(partner);
});

$$("btnLimpar").addEventListener("click", ()=>{
  ["inCodCliente","inNomeCliente","inFilial","inAnalista","inTelefoneContato","inEmailContato","inLinkReuniao","inGerRel","inGerCS","inPack","inDetalhe"].forEach(id=> $$(id).value="");
  $$("inOrigem").value="";
  $$("inOS").value="";
  $$("inDtIni").value="";
  $$("inDtFim").value="";
  $$("inFiltroTipo").value="TERCEIRO";
  $$("inFiltroSenioridade").value="ALL";
  state.consultants = [];
  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  state.selected.consultantId = null;
  state.priorityChecked = false;
  updateOsVisibility();
  renderFila();
  saveState();
  updatePriorityHint();
});

$$("btnLimparSel").addEventListener("click", ()=>{
  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  state.selected.consultantId = null;
  renderFila();
});

$$("btnReservar").addEventListener("click", ()=>{
  const cid = state.selected.consultantId;
  const c = state.consultants.find(x=>x.id===cid);
  const di = $$("inDtIni")?.value;
  const df = $$("inDtFim")?.value;
  const packNeed = $$("inPack")?.value.trim() || "";
  openSelectedModalMPV();
});

$$("btnCloseModal").addEventListener("click", closeModal);
$$("btnCancelarModal").addEventListener("click", closeModal);
$$("btnConfirmarReserva").addEventListener("click", confirmReserva);
$$("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $$("modalBackdrop")) closeModal(); });

// Resumo
$$("btnResumoIrValidacao")?.addEventListener("click", ()=>{
  // neste MVP, as reservas já entram como PENDENTE; navegar para validação
  if(state.reservations.length === 0){
    toast("Sem reservas", "Não há reservas para enviar.", "warn", 2200);
    return;
  }
  const msg = "Agendas selecionadas serão adquiridas por banco de horas conforme apresentado.\n\nDeseja enviar para validação da Torre?";
  if(!confirm(msg)) return;
  state.reservations.forEach(r => {
    r.sentToTower = true;
    if(r.consultant?.type === "CLT-DB"){
      r.status = "APROVADA";
      r.validatedAt = new Date().toISOString();
    }
  });
  saveState();
  document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
  document.querySelector('.tab[data-tab="validacao"]').classList.add("active");
  $$("tab-alocacao").classList.add("hidden");
  $$("tab-gestao").classList.add("hidden");
  $$("tab-terceiros").classList.add("hidden");
  $$("tab-clt").classList.add("hidden");
  $$("tab-clt-disponibilizar").classList.add("hidden");
  $$("tab-resumo").classList.add("hidden");
  $$("tab-acompanhamento").classList.add("hidden");
  $$("tab-validacao").classList.remove("hidden");
  renderValidation();
});
$$("btnResumoVoltar")?.addEventListener("click", ()=>{
  document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
  document.querySelector('.tab[data-tab="alocacao"]').classList.add("active");
  $$("tab-alocacao").classList.remove("hidden");
  $$("tab-gestao").classList.add("hidden");
  $$("tab-terceiros").classList.add("hidden");
  $$("tab-clt").classList.add("hidden");
  $$("tab-clt-disponibilizar").classList.add("hidden");
  $$("tab-resumo").classList.add("hidden");
  $$("tab-acompanhamento").classList.add("hidden");
  $$("tab-validacao").classList.add("hidden");
  renderFila();
  renderAgenda();
});
$$("btnResumoLimpar")?.addEventListener("click", ()=>{
  if(state.reservations.length === 0){ toast("Sem reservas", "Não há reservas para limpar.", "warn", 2200); return; }
  if(!confirm("Tem certeza que deseja limpar todas as reservas?")) return;
  clearAllReservations();
});

$$("btnAddCliente").addEventListener("click", ()=>{
  const code = $$("cCodigo").value.trim();
  let name = $$("cNome").value.trim();
  const filial = $$("cFilial").value.trim();
  const analista = $$("cAnalista").value.trim();
  const gerenteRel = $$("cGerRel").value.trim();
  const gerenteCS = $$("cGerCS").value.trim();
  let finalName = name;
  let finalFilial = filial;
  if(!filial){
    const parts = splitClientName(name);
    if(parts.filial){
      finalName = parts.name;
      finalFilial = parts.filial;
    }
  }
  if(!name && code){
    const match = findClientByCode(code);
    if(match){
      name = match.name;
      finalName = match.name;
      finalFilial = match.filial || finalFilial;
    }
  }
  if(!finalName){ toast("Campo obrigatório", "Informe o nome do cliente.", "warn", 2600); return; }
  if(state.editing.clienteId){
    const target = state.clients.find(x=>x.id===state.editing.clienteId);
    if(target){
      target.code = code || null;
      target.name = finalName;
      target.filial = finalFilial;
      target.analista = analista;
      target.gerenteRel = gerenteRel;
      target.gerenteCS = gerenteCS;
    }
    state.editing.clienteId = null;
    $$("btnAddCliente").textContent = "Adicionar Cliente";
  } else {
    state.clients.push({
      id: crypto.randomUUID(),
      code: code || null,
      name: finalName,
      filial: finalFilial,
      analista,
      gerenteRel,
      gerenteCS
    });
  }
  $$("cCodigo").value="";
  $$("cNome").value="";
  $$("cFilial").value="";
  $$("cAnalista").value="";
  $$("cGerRel").value="";
  $$("cGerCS").value="";
  saveState();
  renderClientes();
  toast("Cliente salvo", "Cadastro atualizado com sucesso.", "info", 2200);
});

$$("btnAddHomologado").addEventListener("click", ()=>{
  const code = $$("hCodigo").value.trim();
  const name = $$("hNome").value.trim();
  const resources = Number($$("hRecursos").value);
  const months = Number($$("hTempo").value);
  const valorHoraByProf = buildPartnerRateMap({
    Executor: parseBRL($$("hValorHoraExecutor").value) || 0,
    "Autônomo": parseBRL($$("hValorHoraAutonomo").value) || 0,
    Proficiente: parseBRL($$("hValorHoraProficiente").value) || 0,
    Referencia: parseBRL($$("hValorHoraReferencia").value) || 0
  });
  const inicio = $$("hInicio").value;
  if(!name){ toast("Campo obrigatório", "Informe o nome do parceiro homologado.", "warn", 2600); return; }
  const shouldRecalc = confirmRecalcOrdem();
  if(!shouldRecalc) return;
  if(state.editing.homologadoId){
    const target = state.homologados.find(x=>x.id===state.editing.homologadoId);
    if(target){
      target.code = code || null;
      target.name = name;
      target.resources = isNaN(resources)?0:resources;
      target.months = isNaN(months)?0:months;
      target.valorHora = 0;
      target.valorHoraByProf = valorHoraByProf;
      target.inicio = inicio || "";
    }
    state.editing.homologadoId = null;
    $$("btnAddHomologado").textContent = "Adicionar Parceiro";
  } else {
    state.homologados.push({
      id: crypto.randomUUID(),
      code: code || null,
      name,
      resources: isNaN(resources)?0:resources,
      months: isNaN(months)?0:months,
      valorHora: 0,
      valorHoraByProf,
      inicio: inicio || ""
    });
  }
  $$("hCodigo").value="";
  $$("hNome").value="";
  $$("hValorHoraExecutor").value="";
  $$("hValorHoraAutonomo").value="";
  $$("hValorHoraProficiente").value="";
  $$("hValorHoraReferencia").value="";
  $$("hInicio").value="";
  saveState();
  if(state.lastOrderCount > 0) generateOrdemFila();
  else renderHomologados();
  toast("Parceiro homologado salvo", "Cadastro atualizado com sucesso.", "info", 2200);
});

$$("btnAddTerceiro")?.addEventListener("click", ()=>{
  const empresa = $$("tEmpresa").value.trim();
  const codigo = $$("tCodigo").value.trim();
  const nome = $$("tNome").value.trim();
  const funcao = $$("tFuncao").value.trim();
  const senioridade = $$("tSenioridade").value.trim();
  const modalidade = $$("tModalidade").value.trim();
  const email = $$("tEmail").value.trim();
  const telefone = $$("tTelefone").value.trim();
  const disponivel = $$("tDisponivel").value;
  const carga = Number($$("tCarga").value);
  const presencial = $$("tPresencial").checked;
  const filialSlim = $$("tFilialSlim").value.trim();
  const obs = $$("tObs").value.trim();

  if(!nome){
    toast("Campo obrigatório", "Informe o nome do recurso.", "warn", 2600);
    return;
  }
  if(presencial && !filialSlim){
    toast("Campo obrigatório", "Selecione a Filial SLIM para recurso presencial.", "warn", 2600);
    return;
  }

  const novo = {
    id: crypto.randomUUID(),
    empresa,
    codigo,
    nome,
    funcao,
    senioridade,
    modalidade,
    email,
    telefone,
    disponivel,
    carga: isNaN(carga) ? 0 : carga,
    presencial,
    filialSlim: presencial ? filialSlim : "",
    obs,
    packLevels: []
  };
  state.terceiros.push(novo);
  $$("tEmpresa").value = "";
  $$("tCodigo").value = "";
  $$("tNome").value = "";
  $$("tFuncao").value = "";
  $$("tSenioridade").value = "";
  $$("tModalidade").value = "";
  $$("tEmail").value = "";
  $$("tTelefone").value = "";
  $$("tDisponivel").value = "";
  $$("tCarga").value = "40";
  $$("tPresencial").checked = false;
  $$("tFilialSlim").value = "";
  $$("tFilialRow").classList.add("hidden");
  $$("tObs").value = "";
  saveState();
  renderTerceiros();
  openTerceiroModal(novo.id);
});

$$("btnResetTerceiro")?.addEventListener("click", ()=>{
  $$("tEmpresa").value = "";
  $$("tCodigo").value = "";
  $$("tNome").value = "";
  $$("tFuncao").value = "";
  $$("tSenioridade").value = "";
  $$("tModalidade").value = "";
  $$("tEmail").value = "";
  $$("tTelefone").value = "";
  $$("tDisponivel").value = "";
  $$("tCarga").value = "40";
  $$("tPresencial").checked = false;
  $$("tFilialSlim").value = "";
  $$("tFilialRow").classList.add("hidden");
  $$("tObs").value = "";
});

$$("btnAddClt")?.addEventListener("click", ()=>{
  const nome = $$("cltNome").value.trim();
  const cargo = $$("cltCargo").value.trim();
  const senioridade = $$("cltSenioridade").value.trim();
  const gestor = $$("cltGestor").value.trim();
  const email = $$("cltEmail").value.trim();
  const telefone = $$("cltTelefone").value.trim();
  const disponivel = $$("cltDisponivel").value;
  const obs = $$("cltObs").value.trim();

  if(!nome){
    toast("Campo obrigatório", "Informe o nome do recurso.", "warn", 2600);
    return;
  }

  state.clt.push({
    id: crypto.randomUUID(),
    nome,
    cargo,
    senioridade,
    gestor,
    email,
    telefone,
    disponivel,
    obs,
    packLevels: []
  });
  $$("cltNome").value = "";
  $$("cltCargo").value = "";
  $$("cltSenioridade").value = "";
  $$("cltGestor").value = "";
  $$("cltEmail").value = "";
  $$("cltTelefone").value = "";
  $$("cltDisponivel").value = "";
  $$("cltObs").value = "";
  saveState();
  renderClt();
  toast("Recurso Sankhya salvo", "Cadastro atualizado com sucesso.", "info", 2200);
});

$$("btnResetClt")?.addEventListener("click", ()=>{
  $$("cltNome").value = "";
  $$("cltCargo").value = "";
  $$("cltSenioridade").value = "";
  $$("cltGestor").value = "";
  $$("cltEmail").value = "";
  $$("cltTelefone").value = "";
  $$("cltDisponivel").value = "";
  $$("cltObs").value = "";
});

$$("btnCltBuscar")?.addEventListener("click", ()=>{
  const di = $$("cltDtIni").value;
  const df = $$("cltDtFim").value;
  if(!di || !df){
    toast("Datas obrigatórias", "Informe data inicial e final para gerar a agenda.", "warn", 2600);
    return;
  }
  const nome = $$("cltBuscaNome").value.trim();
  state.cltConsultants = generateCltConsultants(di, df, nome);
  state.cltSelected.slotKeys.clear();
  state.cltSelected.lastIndex = null;
  state.cltSelected.consultantId = null;
  state.cltSelected.lastConsultantId = null;
  state.cltSelectedLb.slotKeys.clear();
  state.cltSelectedLb.lastIndex = null;
  state.cltSelectedLb.consultantId = null;
  state.cltSelectedLb.lastConsultantId = null;
  renderCltFila();
});

$$("btnCltLimpar")?.addEventListener("click", ()=>{
  $$("cltBuscaNome").value = "";
  $$("cltDtIni").value = "";
  $$("cltDtFim").value = "";
  state.cltConsultants = [];
  state.cltSelected.slotKeys.clear();
  state.cltSelected.lastIndex = null;
  state.cltSelected.consultantId = null;
  state.cltSelected.lastConsultantId = null;
  state.cltSelectedLb.slotKeys.clear();
  state.cltSelectedLb.lastIndex = null;
  state.cltSelectedLb.consultantId = null;
  state.cltSelectedLb.lastConsultantId = null;
  renderCltFila();
});

$$("btnReservarClt")?.addEventListener("click", openCltReserveModal);
$$("btnLimparSelClt")?.addEventListener("click", ()=>{
  state.cltSelected.slotKeys.clear();
  state.cltSelected.lastIndex = null;
  state.cltSelected.consultantId = null;
  state.cltSelected.lastConsultantId = null;
  renderCltFila();
});
$$("btnRemoveLbClt")?.addEventListener("click", removeSelectedLbClt);
$$("btnClearLbClt")?.addEventListener("click", ()=>{
  state.cltSelectedLb.slotKeys.clear();
  state.cltSelectedLb.lastIndex = null;
  state.cltSelectedLb.consultantId = null;
  state.cltSelectedLb.lastConsultantId = null;
  renderCltFila();
});

$$("btnResetHomologados").addEventListener("click", resetHomologados);
$$("btnParamsOrdem").addEventListener("click", ()=>{
  openOrderModal();
});
$$("btnGerarOrdem").addEventListener("click", generateOrdemFila);

$$("btnEditHomologados").addEventListener("click", ()=>{
  state.editModeHomologados = true;
  state.homologadosDirty = false;
  const btnSave = $$("btnSaveHomologados");
  if(btnSave) btnSave.style.display = "none";
  renderHomologados();
});
$$("btnSaveHomologados").addEventListener("click", ()=>{
  state.editModeHomologados = false;
  state.homologadosDirty = false;
  $$("btnSaveHomologados").style.display = "none";
  saveState();
  if(state.lastOrderCount > 0) generateOrdemFila();
  else renderHomologados();
  toast("Alterações salvas", "Parceiros homologados atualizados.", "info", 2200);
});

$$("btnSaveValorHoraVendida")?.addEventListener("click", saveValorHoraVendida);

$$("btnClearLocal")?.addEventListener("click", ()=>{
  if(!confirm("Isso vai limpar todos os dados locais (reservas, cadastros e configurações). Deseja continuar?")) return;
  localStorage.clear();
  location.reload();
});

$$("btnCloseOrder").addEventListener("click", closeOrderModal);
$$("btnCancelOrder").addEventListener("click", closeOrderModal);
$$("btnSaveOrder").addEventListener("click", ()=>{
  const rulesBox = $$("orderRules");
  if(!rulesBox) return;
  const rows = Array.from(rulesBox.children);
  const next = rows.map(row => {
    const field = row.querySelector("[data-rule-field]")?.value || "resources";
    const dir = row.querySelector("[data-rule-dir]")?.value || "desc";
    return { field, dir };
  });
  state.orderRules = next.length ? next : [{ field: "resources", dir: "desc" }];
  saveState();
  closeOrderModal();
  toast("Parâmetros salvos", "Ordem atualizada com sucesso.", "info", 2200);
  if(state.lastOrderCount > 0) generateOrdemFila();
});
$$("orderBackdrop").addEventListener("click", (e)=>{ if(e.target === $$("orderBackdrop")) closeOrderModal(); });
$$("btnAddRule").addEventListener("click", ()=>{
  state.orderRules.push({ field: "resources", dir: "desc" });
  renderOrderModal();
});

$$("btnCloseSwap").addEventListener("click", closeSwapModal);
$$("btnCancelarSwap").addEventListener("click", closeSwapModal);
$$("btnSalvarSwap").addEventListener("click", ()=>{
  const ctx = state.swapContext;
  if(!ctx) return;
  const swapObs = $$("swapObs")?.value.trim();
  if(!swapObs){
    toast("Troca não salva", "Campo observação da troca é de preenchimento obrigatório.", "warn", 2800);
    $$("swapObs")?.focus();
    return;
  }
  const novoConsultor = $$("swapConsultor").value.trim();
  const novoConsultorId = $$("swapConsultorId").value.trim();
  const novaData = $$("swapData").value;
  const novoPeriodo = $$("swapPeriodo").value;
  if(!novoConsultor || !novaData || !novoPeriodo){
    toast("Campos obrigatórios", "Informe consultor, data e período.", "warn", 2600);
    return;
  }
  const newConsultant = state.consultants.find(x=>x.id===novoConsultorId) || state.consultants.find(x=>x.name===novoConsultor);
  const toConsultant = newConsultant
    ? { id:newConsultant.id, name:newConsultant.name, seniority:newConsultant.seniority, partnerName:newConsultant.partnerName, type:newConsultant.type }
    : { id:novoConsultorId || null, name:novoConsultor, seniority:ctx.consultant?.seniority || "", partnerName:ctx.consultant?.partnerName || "", type:ctx.consultant?.type || "" };

  const swapEntry = {
    from: {
      consultant: { ...ctx.consultant },
      slots: (ctx.slots || []).map(s => ({ day:s.day, period:s.period, label:s.label }))
    },
    to: {
      consultant: toConsultant,
      slots: [{ day: novaData, period: novoPeriodo, label: `${fmtDate(novaData)} • ${novoPeriodo}` }]
    },
    obs: swapObs,
    createdAt: new Date().toISOString()
  };
  ctx.pendingSwap = { ...swapEntry };
  ctx.swapHistory = Array.isArray(ctx.swapHistory) ? ctx.swapHistory : [];
  ctx.swapHistory.push(swapEntry);

  ctx.towerChanges = (ctx.towerChanges || 0) + 1;
  ctx.lastTowerChange = new Date().toISOString();
  ctx.validatorNote = ctx.validatorNote ? `${ctx.validatorNote} | Troca: ${swapObs}` : `Troca: ${swapObs}`;
  ctx.status = "PENDENTE";
  ctx.validatedAt = null;
  saveState();
  closeSwapModal();
  renderValidation();
  renderAcompanhamento();
  toast("Troca sugerida", "Proposta enviada para aprovação da Base.", "info", 2200);
});
$$("swapBackdrop").addEventListener("click", (e)=>{ if(e.target === $$("swapBackdrop")) closeSwapModal(); });

$$("btnOkInfo").addEventListener("click", closeInfoModal);
$$("btnCloseInfo").addEventListener("click", closeInfoModal);
$$("infoBackdrop").addEventListener("click", (e)=>{ if(e.target === $$("infoBackdrop")) closeInfoModal(); });

$$("btnCloseTerceiro")?.addEventListener("click", closeTerceiroModal);
$$("btnCancelarTerceiro")?.addEventListener("click", closeTerceiroModal);
$$("btnSalvarTerceiro")?.addEventListener("click", ()=>{
  if(!terceiroModalId) return;
  const list = terceiroModalType === "clt" ? state.clt : state.terceiros;
  const target = list.find(x => x.id === terceiroModalId);
  if(!target) return;
  const packSelect = $$("tPackModal");
  const currentMap = { ...terceiroPackMap };
  const selectedPacks = terceiroPackOrder.slice();
  if(selectedPacks.length === 0){
    toast("Campo obrigatório", "Selecione ao menos um pack certificado.", "warn", 2600);
    packSelect?.focus();
    return;
  }
  const levels = {};
  let hasMissing = false;
  selectedPacks.forEach(pack => {
    const val = (currentMap[pack] || "").trim();
    if(!val) hasMissing = true;
    levels[pack] = val;
  });
  if(hasMissing){
    toast("Campo obrigatório", "Defina o nível de execução para todos os packs selecionados.", "warn", 2600);
    return;
  }
  target.packLevels = selectedPacks.map(pack => ({ pack, nivel: levels[pack] }));
  saveState();
  if(terceiroModalType === "clt") renderClt();
  else renderTerceiros();
  closeTerceiroModal();
});
$$("terceiroBackdrop")?.addEventListener("click", (e)=>{ if(e.target === $$("terceiroBackdrop")) closeTerceiroModal(); });
$$("btnCloseCltReserve")?.addEventListener("click", closeCltReserveModal);
$$("btnCancelCltReserve")?.addEventListener("click", closeCltReserveModal);
$$("btnConfirmCltReserve")?.addEventListener("click", confirmCltReserve);
$$("cltReserveBackdrop")?.addEventListener("click", (e)=>{ if(e.target === $$("cltReserveBackdrop")) closeCltReserveModal(); });
$$("btnCloseCltManage")?.addEventListener("click", closeCltManageModal);
$$("btnKeepCltManage")?.addEventListener("click", closeCltManageModal);
$$("btnRemoveCltManage")?.addEventListener("click", removeCltManage);
$$("cltManageBackdrop")?.addEventListener("click", (e)=>{ if(e.target === $$("cltManageBackdrop")) closeCltManageModal(); });

function getCltSelectionGroups(){
  const groups = [];
  state.cltConsultants.forEach(c => {
    const slots = c.schedule.filter(s => state.cltSelected.slotKeys.has(s.key));
    if(slots.length){
      groups.push({ consultant: c, slots });
    }
  });
  return groups;
}

function openCltReserveModal(){
  if(state.cltSelected.slotKeys.size === 0){
    toast("Sem seleção", "Selecione ao menos 1 slot livre para disponibilizar.", "warn", 2600);
    return;
  }
  const groups = getCltSelectionGroups();
  if(groups.length === 0) return;
  const info = $$("cltReserveInfo");
  if(info){
    info.textContent = groups.length === 1
      ? `${groups[0].consultant.name} • ${groups[0].consultant.seniority}`
      : `${groups.length} recursos selecionados`;
  }
  const slotBox = $$("cltReserveSlots");
  if(slotBox){
    slotBox.innerHTML = groups.map(g => {
      const items = g.slots.map(s => `• <b>${fmtDate(s.day)}</b> – ${s.period}`).join("<br/>");
      return `<div style="margin-bottom:8px"><b>${escapeHtml(g.consultant.name)}</b><div class="small">${items}</div></div>`;
    }).join("");
  }
  const box = $$("cltReserveBackdrop");
  if(box) box.style.display = "flex";
}

function closeCltReserveModal(){
  const box = $$("cltReserveBackdrop");
  if(box) box.style.display = "none";
}

function openCltManageModal(slot, consultant){
  cltManageSlot = { slot, consultant };
  const info = $$("cltManageInfo");
  if(info){
    info.textContent = `${consultant?.name || "Recurso"} • ${fmtDate(slot.day)} • ${slot.period}`;
  }
  const box = $$("cltManageBackdrop");
  if(box) box.style.display = "flex";
}

function closeCltManageModal(){
  const box = $$("cltManageBackdrop");
  if(box) box.style.display = "none";
  cltManageSlot = null;
}

function removeCltManage(){
  if(!cltManageSlot) return;
  const { slot, consultant } = cltManageSlot;
  const c = state.cltConsultants.find(x=>x.id===consultant?.id);
  if(!c) return;
  const target = c.schedule.find(x=>x.key===slot.key);
  if(target){
    target.status = "L";
    state.cltAgenda[target.key] = "L";
  }
  saveState();
  closeCltManageModal();
  renderCltFila();
  toast("Liberação removida", "Slot voltou para Livre.", "info", 2200);
}

function applyPendingSwap(res){
  const ps = res.pendingSwap;
  if(!ps) return;

  const oldC = state.consultants.find(x=>x.id===res.consultant?.id) || state.consultants.find(x=>x.name===res.consultant?.name);
  if(oldC){
    (res.slots || []).forEach(s=>{
      const slot = oldC.schedule?.find(x=>x.day===s.day && x.period===s.period);
      if(slot) slot.status = "L";
    });
  }

  const newC = state.consultants.find(x=>x.id===ps.to.consultant?.id) || state.consultants.find(x=>x.name===ps.to.consultant?.name);
  if(newC){
    const newSlot = newC.schedule?.find(x=>x.day===ps.to.slots?.[0]?.day && x.period===ps.to.slots?.[0]?.period);
    if(newSlot) newSlot.status = "R";
  }

  res.consultant = { ...ps.to.consultant };
  res.slots = (ps.to.slots || []).map(s => ({ day:s.day, period:s.period, label:s.label }));
  res.pendingSwap = null;
}

function removeSelectedLbClt(){
  if(state.cltSelectedLb.slotKeys.size === 0) return;
  state.cltConsultants.forEach(c=>{
    c.schedule.forEach(s=>{
      if(state.cltSelectedLb.slotKeys.has(s.key) && s.status === "DB"){
        s.status = "L";
        state.cltAgenda[s.key] = "L";
      }
    });
  });
  state.cltSelectedLb.slotKeys.clear();
  state.cltSelectedLb.lastIndex = null;
  state.cltSelectedLb.consultantId = null;
  state.cltSelectedLb.lastConsultantId = null;
  saveState();
  renderCltFila();
  toast("Disponibilização removida", "Slots DB voltaram para Livre.", "info", 2200);
}

function hasPriorityAvailability(dtIni, dtFim, packFilter=""){
  return getPriorityTypes(dtIni, dtFim, packFilter).length > 0;
}

function getTerceiroPresencialDisponivel(packFilter=""){
  return state.terceiros.filter(t => {
    if(!t.presencial) return false;
    if(packFilter){
      const packs = Array.isArray(t.packLevels) ? t.packLevels.map(p => p.pack) : [];
      if(!packs.includes(packFilter)) return false;
    }
    const tf = normalizeFilial(t.filialSlim || "");
    if(tf && $$("inFilial")?.value){
      const ff = normalizeFilial($$("inFilial")?.value || "");
      if(ff && !tf.includes(ff)) return false;
    }
    return true;
  });
}

function getPriorityTypes(dtIni, dtFim, packFilter=""){
  const types = [];
  if(getCltDbConsultants(dtIni, dtFim, packFilter).length > 0){
    types.push("CLT_DB");
  }
  if(getTerceiroPresencialDisponivel(packFilter).length > 0){
    types.push("TERCEIRO_PRESENCIAL");
  }
  return types;
}

function confirmCltReserve(){
  const groups = getCltSelectionGroups();
  if(groups.length === 0) return;
  let totalOk = 0;

  groups.forEach(g => {
    let ok = 0;
    g.slots.forEach(s=>{
      const slot = g.consultant.schedule.find(x=>x.key===s.key);
      if(!slot || slot.status !== "L") return;
      slot.status = "DB";
      state.cltAgenda[slot.key] = "DB";
      ok++;
      totalOk++;
    });
    if(ok > 0){
        const demanda = {
        codCliente: $$("inCodCliente")?.value.trim() || "",
        nomeCliente: $$("inNomeCliente")?.value.trim() || "CLT Base",
        filial: $$("inFilial")?.value.trim() || "",
        analista: $$("inAnalista")?.value.trim() || "",
        telefoneContato: $$("inTelefoneContato")?.value.trim() || "",
        emailContato: $$("inEmailContato")?.value.trim() || "",
        linkReuniao: $$("inLinkReuniao")?.value.trim() || "",
        gerenteRel: $$("inGerRel")?.value.trim() || "",
        gerenteCS: $$("inGerCS")?.value.trim() || "",
        origem: "CLT",
        pack: $$("inPack")?.value.trim() || "",
        detalhe: $$("inDetalhe")?.value.trim() || "",
        osNumero: $$("inOS")?.value.trim() || "",
        dtIni: $$("cltDtIni")?.value || "",
        dtFim: $$("cltDtFim")?.value || "",
        createdAt: new Date().toISOString()
      };
      state.reservations.push({
        id: crypto.randomUUID(),
        svr: nextSvr(),
        demanda,
        modalidade: "",
      consultant: { id:g.consultant.id, name:g.consultant.name, seniority:g.consultant.seniority, partnerName:"CLT", type:"CLT", profShort: g.consultant.profShort || null },
        slots: g.slots.map(x=>({ day:x.day, period:x.period, label:x.label })),
        obs: "",
        partnerOrder: null,
        expectedOrder: getCurrentExpectedOrder(),
        status: "PENDENTE",
        validatedAt: null,
        validatorNote: "",
        towerChanges: 0,
        lastTowerChange: null,
        sentToTower: false,
        pdfConfirmed: false
      });
    }
  });

  state.cltSelected.slotKeys.clear();
  state.cltSelected.lastIndex = null;
  state.cltSelected.consultantId = null;
  state.cltSelected.lastConsultantId = null;
  state.cltSelectedLb.slotKeys.clear();
  state.cltSelectedLb.lastIndex = null;
  state.cltSelectedLb.consultantId = null;
  state.cltSelectedLb.lastConsultantId = null;
  saveState();
  closeCltReserveModal();
  renderCltFila();
  renderResumo();
  renderValidation();
  showTab("resumo");
  if(totalOk > 0) toast("Disponibilizado", "Agendas CLT disponibilizadas para Base.", "info", 2600);
}

renderFila();
renderClientes();
renderHomologados();
renderTerceiros();
renderClt();
setCltDatesDefault();
renderCltFila();
updatePriorityHint();
renderValidation();
renderAcompanhamento();

const acompBusca = $$("acompBuscaSvr");
if(acompBusca){
  acompBusca.addEventListener("input", renderAcompanhamento);
}
const acompStatus = $$("acompStatus");
if(acompStatus){
  acompStatus.addEventListener("change", renderAcompanhamento);
}

const tPresencial = $$("tPresencial");
if(tPresencial){
  tPresencial.addEventListener("change", () => {
    const row = $$("tFilialRow");
    if(!row) return;
    row.classList.toggle("hidden", !tPresencial.checked);
    if(!tPresencial.checked){
      const sel = $$("tFilialSlim");
      if(sel) sel.value = "";
    }
  });
}

// ======= MPV Modal (Reservar agenda) + seleção múltipla =======

function ensureModalidadeUIMPV(){
  const wrap = document.getElementById("modalidadeWrapMPV");
  if(!wrap || wrap.querySelector('input[name="modalidadeAgendaMPV"]')) return;
  wrap.innerHTML = `
    <label><strong>Modalidade da Agenda <span style="color:red">*</span></strong></label>
    <div class="modalidadeRow">
      <label class="modalidadeOption"><input type="radio" name="modalidadeAgendaMPV" value="Remoto" checked> <span>Remoto</span></label>
      <label class="modalidadeOption"><input type="radio" name="modalidadeAgendaMPV" value="Presencial"> <span>Presencial</span></label>
    </div>
  `;
  const radios = wrap.querySelectorAll('input[name="modalidadeAgendaMPV"]');
  radios.forEach(r => {
    r.addEventListener("change", () => {
      if(r.checked && r.value === "Presencial"){
        openContractModal(
          () => { presencialAcceptedMPV = true; },
          () => {
            presencialAcceptedMPV = false;
            const remoto = wrap.querySelector('input[name="modalidadeAgendaMPV"][value="Remoto"]');
            if(remoto) remoto.checked = true;
            const mb = document.getElementById("modalBack");
            if(mb) mb.classList.add("show");
          }
        );
      }
    });
  });
}

let contractModalCtx = null;
function openContractModal(onAccept, onBack){
  contractModalCtx = { onAccept, onBack };
  const mb = document.getElementById("modalBack");
  if(mb) mb.classList.remove("show");
  const back = document.getElementById("contractBackdrop");
  if(back) back.style.display = "flex";
}
function closeContractModal(){
  const back = document.getElementById("contractBackdrop");
  if(back) back.style.display = "none";
  contractModalCtx = null;
}

let modalCtxMPV = null;
let presencialAcceptedMPV = false;

function getSelectedSlotsForCurrentConsultant(){
  const cid = state.selected.consultantId;
  if(!cid) return { consultant:null, slots:[] };
  const c = state.consultants.find(x=>x.id===cid);
  if(!c) return { consultant:null, slots:[] };

  const keys = Array.from(state.selected.slotKeys || []);
  // garante ordem pela posição (index) na agenda
  const slots = keys.map(k=>{
    const s = c.schedule.find(x=>x.key===k);
    return s ? { key:s.key, day:s.day, period:s.period, label:s.label, index:s.index } : null;
  }).filter(Boolean).sort((a,b)=>(a.index??0)-(b.index??0));

  return { consultant:c, slots };
}

function openSelectedModalMPV(){
  const sel = getSelectedSlotsForCurrentConsultant();
  if(!sel.consultant || sel.slots.length < 1){
    toast("Seleção vazia", "Selecione pelo menos 1 período antes de reservar.", "warn", 2600);
    return;
  }
  // Regra do botão: só abre por multi (>=2), mas caso você chame manualmente com 1, também funciona
  const first = sel.slots[0];
  openModalMPV({
    consultant: sel.consultant,
    slots: sel.slots,
    first
  });
}

function openModalMPV(ctx){
  modalCtxMPV = ctx;
  presencialAcceptedMPV = false;
  ensureModalidadeUIMPV();

  const back = document.getElementById("modalBack");
  if(!back) return;

  document.getElementById("mConsultorMPV").textContent = ctx.consultant.name;
  const next = `SVR-${String((state.svrSeq || 0) + 1).padStart(5, "0")}`;
  const svrEl = document.getElementById("mSvrMPV");
  if(svrEl) svrEl.textContent = next;

  const isMulti = (ctx.slots && ctx.slots.length >= 2);
  const daysSet = new Set((ctx.slots || []).map(s => s.day).filter(Boolean));
  const sameDay = daysSet.size === 1;
  const periodsNorm = (ctx.slots || []).map(s => String(s.period || "").toLowerCase());
  const hasManha = periodsNorm.some(p => p.includes("manhã") || p.includes("manha"));
  const hasTarde = periodsNorm.some(p => p.includes("tarde"));
  const isDiaTodo = sameDay && hasManha && hasTarde;

  document.getElementById("mDataMPV").textContent = isMulti
    ? (sameDay ? fmtDate(ctx.first?.day) : `Múltiplos dias (${ctx.slots.length})`)
    : (ctx.first?.day ? fmtDate(ctx.first.day) : "—");
  document.getElementById("mTurnoMPV").textContent = isMulti
    ? (isDiaTodo ? "Dia todo" : "Períodos selecionados")
    : (ctx.first?.period || "—");

  // Lista de períodos selecionados (multi)
  const selLbl = document.getElementById("mSelectedLabelMPV");
  const selBox = document.getElementById("mSelectedMPV");
  if(selLbl && selBox){
    if(isMulti){
      const byDay = new Map();
      (ctx.slots || []).forEach(s=>{
        const key = s.day || "—";
        const list = byDay.get(key) || [];
        list.push(s.period || "—");
        byDay.set(key, list);
      });
      const rows = Array.from(byDay.entries()).map(([dayKeyRaw, periods])=>{
        const norm = periods.map(p => String(p || "").toLowerCase());
        const hasManha = norm.some(p => p.includes("manhã") || p.includes("manha"));
        const hasTarde = norm.some(p => p.includes("tarde"));
        let periodo = "—";
        if(hasManha && hasTarde){
          periodo = "Dia todo";
        } else {
          const uniq = Array.from(new Set(periods.map(p => p || "—")));
          periodo = uniq.join(" / ");
        }
        const d = dayKeyRaw !== "—" ? fmtDate(dayKeyRaw) : "—";
        return `<div class="rowItem"><div><b>${d}</b></div><div class="muted">${escapeHtml(periodo)}</div></div>`;
      });
      selLbl.style.display = "";
      selBox.style.display = "";
      selBox.innerHTML = rows.join("");
    } else {
      selLbl.style.display = "none";
      selBox.style.display = "none";
      selBox.innerHTML = "";
    }
  }

  // Pack (do formulário)
  const packSel = document.getElementById("mPackMPV");
  const packVal = ($$("inPack")?.value || "").trim();
  if(packSel){
    packSel.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = packVal || "";
    opt.textContent = packVal || "—";
    packSel.appendChild(opt);
  }

  // Botões (multi: esconde "dia todo")
  const btnDay = document.getElementById("btnReserveDayMPV");
  if(btnDay) btnDay.style.display = isMulti ? "none" : "";

  // Totais (cada meio período = 4h)
  const hours = (ctx.slots?.length || 0) * 4;
  const valorHora = getValorHoraValue(ctx.consultant);
  const total = valorHora > 0 ? (hours * valorHora) : 0;
  const horasEl = document.getElementById("mHorasMPV");
  const vhEl = document.getElementById("mValorHoraMPV");
  const vtEl = document.getElementById("mValorTotalMPV");
  if(horasEl) horasEl.textContent = hours ? `${hours}h` : "—";
  if(vhEl) vhEl.textContent = valorHora > 0 ? formatBRL(valorHora) : "—";
  if(vtEl) vtEl.textContent = total > 0 ? formatBRL(total) : "—";

  back.classList.add("show");
}

function closeModalMPV(){
  modalCtxMPV = null;
  const back = document.getElementById("modalBack");
  if(back) back.classList.remove("show");
}

function reserveSlotsMPV(slots, modalidade){
  const sel = getSelectedSlotsForCurrentConsultant();
  const c = sel.consultant;
  if(!c) return {ok:0, skipR:0};

  let ok = 0, skipR = 0;
  slots.forEach(s=>{
    const slot = c.schedule.find(x=>x.key===s.key);
    if(!slot) return;
    if(slot.status === "R"){ skipR++; return; }
    if(slot.status !== "L" && slot.status !== "DB"){ return; }
    slot.status = "R";
    ok++;
  });

  // cria 1 reserva contendo N slots, com Modalidade
  const demanda = {
    codCliente: $$("inCodCliente")?.value.trim() || "",
    nomeCliente: $$("inNomeCliente")?.value.trim() || "",
    filial: $$("inFilial")?.value.trim() || "",
    analista: $$("inAnalista")?.value.trim() || "",
    telefoneContato: $$("inTelefoneContato")?.value.trim() || "",
    emailContato: $$("inEmailContato")?.value.trim() || "",
    linkReuniao: $$("inLinkReuniao")?.value.trim() || "",
    gerenteRel: $$("inGerRel")?.value.trim() || "",
    gerenteCS: $$("inGerCS")?.value.trim() || "",
    origem: $$("inOrigem")?.value || "",
    pack: $$("inPack")?.value.trim() || "",
    detalhe: $$("inDetalhe")?.value.trim() || "",
    osNumero: $$("inOS")?.value.trim() || "",
    dtIni: $$("inDtIni")?.value || "",
    dtFim: $$("inDtFim")?.value || "",
    createdAt: new Date().toISOString()
  };
  const prioridadeDisponivel = getPriorityTypes(demanda.dtIni, demanda.dtFim, demanda.pack);

  if(ok > 0){
    state.reservations.push({
      id: crypto.randomUUID(),
      svr: nextSvr(),
      demanda,
      modalidade,
      consultant: { id:c.id, name:c.name, seniority:c.seniority, partnerName:c.partnerName, type:c.type, profShort: c.profShort || null },
      slots: slots.map(x=>({ day:x.day, period:x.period, label:x.label })),
      obs: "",
      prioridadeDisponivel,
      partnerOrder: getPartnerOrderByName(c.partnerName),
      expectedOrder: getCurrentExpectedOrder(),
      status: "PENDENTE",
      validatedAt: null,
      validatorNote: "",
      towerChanges: 0,
      lastTowerChange: null,
      sentToTower: false,
      pdfConfirmed: false
    });
  }

  return {ok, skipR};
}

// Confirmar (Reservar)
document.addEventListener("click", (e)=>{
  const id = e.target?.id;
  if(id !== "btnReserveHalfMPV" && id !== "btnReserveDayMPV") return;
  if(!modalCtxMPV) return;

  const modalidadeEl = document.querySelector('input[name="modalidadeAgendaMPV"]:checked');
  const modalidade = modalidadeEl ? modalidadeEl.value : "";
  if(!modalidade){
    alert("⚠️ Selecione se a agenda é Remota ou Presencial.");
    return;
  }
  if(id === "btnReserveHalfMPV" && modalidade === "Presencial"){
    const daysSet = new Set((modalCtxMPV.slots || []).map(s => s.day).filter(Boolean));
    const sameDay = daysSet.size === 1;
    const periodsNorm = (modalCtxMPV.slots || []).map(s => String(s.period || "").toLowerCase());
    const hasManha = periodsNorm.some(p => p.includes("manhã") || p.includes("manha"));
    const hasTarde = periodsNorm.some(p => p.includes("tarde"));
    const isDiaTodo = sameDay && hasManha && hasTarde;
    if(!isDiaTodo){
      alert("Agenda presencial é somente o dia todo, não é possível para meio período.");
      return;
    }
  }
  if(modalidade === "Presencial" && !presencialAcceptedMPV){
    openContractModal(
      () => { presencialAcceptedMPV = true; },
      () => {
        presencialAcceptedMPV = false;
        const wrap = document.getElementById("modalidadeWrapMPV");
        const remoto = wrap?.querySelector('input[name="modalidadeAgendaMPV"][value="Remoto"]');
        if(remoto) remoto.checked = true;
      }
    );
    return;
  }

  // Slots alvo
  const isMulti = (modalCtxMPV.slots && modalCtxMPV.slots.length >= 2);

  if(id === "btnReserveDayMPV" && !isMulti){
    // dia todo: manhã + tarde do mesmo dia
    const day = modalCtxMPV.first?.day;
    const sel = getSelectedSlotsForCurrentConsultant();
    const c = sel.consultant;
    const daySlots = c ? c.schedule.filter(s=>s.day===day && (s.period==="Manhã" || s.period==="Tarde")).map(s=>({key:s.key, day:s.day, period:s.period, label:s.label, index:s.index})) : [];
    const res = reserveSlotsMPV(daySlots, modalidade);
    closeModalMPV();

    // limpa seleção
    state.selected.slotKeys.clear();
    state.selected.lastIndex = null;
    state.selected.consultantId = null;

    renderFila();
    renderAgenda();
    renderResumo();
    renderValidation();
    saveState();
    showTab("resumo");

    alert(`Reserva concluída: ${res.ok} reservado(s), ${res.skipR} ignorado(s) (já reservados).`);
    return;
  }

  // Reservar (1 ou N)
  const res = reserveSlotsMPV(modalCtxMPV.slots, modalidade);
  closeModalMPV();

  state.selected.slotKeys.clear();
  state.selected.lastIndex = null;
  state.selected.consultantId = null;

  renderFila();
  renderAgenda();
  renderResumo();
  renderValidation();
  saveState();
  showTab("resumo");

  alert(`Reserva concluída: ${res.ok} reservado(s), ${res.skipR} ignorado(s) (já reservados).`);
});

// Fechar modal
document.addEventListener("click", (e)=>{
  const id = e.target?.id;
  if(id === "btnCloseModalMPV" || id === "btnCloseModalMPV2"){
    closeModalMPV();
  }
});
document.addEventListener("click", (e)=>{
  const back = document.getElementById("modalBack");
  if(back && e.target === back) closeModalMPV();
});
document.addEventListener("click", (e)=>{
  const id = e.target?.id;
  if(id === "btnContractAccept"){
    contractModalCtx?.onAccept?.();
    closeContractModal();
    const mb = document.getElementById("modalBack");
    if(mb) mb.classList.add("show");
  }
  if(id === "btnContractBack"){
    contractModalCtx?.onBack?.();
    closeContractModal();
    const mb = document.getElementById("modalBack");
    if(mb) mb.classList.add("show");
  }
});
document.addEventListener("click", (e)=>{
  const back = document.getElementById("contractBackdrop");
  if(back && e.target === back){
    contractModalCtx?.onBack?.();
    closeContractModal();
  }
});

</script>

<!-- ===== Modal MPV: Reservar agenda (seleção única/múltipla) ===== -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="head">
      <b>Reservar agenda</b>
      <button class="ghost" id="btnCloseModalMPV" style="width:auto">✕</button>
    </div>
    <div class="body">
      <div class="muted">SVR</div>
      <div style="font-weight:1000" id="mSvrMPV">—</div>

      <div class="muted" style="margin-top:8px">Consultor</div>
      <div style="font-weight:1000" id="mConsultorMPV">—</div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="muted">Data</div>
          <div style="font-weight:900" id="mDataMPV">—</div>
        </div>
        <div style="flex:1">
          <div class="muted">Turno</div>
          <div style="font-weight:900" id="mTurnoMPV">—</div>
          <div class="muted" style="margin-top:8px; display:none" id="mSelectedLabelMPV">Períodos selecionados</div>
          <div style="display:none" id="mSelectedMPV" class="card"></div>
        </div>
      </div>

      <label>Pack da reserva</label>
      <select id="mPackMPV"></select>

      <div id="modalidadeWrapMPV"></div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="muted">Horas reservadas</div>
          <div style="font-weight:900" id="mHorasMPV">—</div>
        </div>
        <div style="flex:1">
          <div class="muted">Valor hora</div>
          <div style="font-weight:900" id="mValorHoraMPV">—</div>
        </div>
        <div style="flex:1">
          <div class="muted">Valor total</div>
          <div style="font-weight:900" id="mValorTotalMPV">—</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnReserveHalfMPV">Reservar</button>
        <button class="secondary" id="btnReserveDayMPV">Reservar dia todo</button>
      </div>

      <p class="muted" style="margin-top:10px">
        Regra: só reserva se o slot estiver <b>L</b>. Se estiver <b>R</b>, não permite.
      </p>
    </div>
    <div class="foot">
      <button class="ghost" id="btnCloseModalMPV2">Fechar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="contractBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="hd">
      <strong>Condições de Presencial</strong>
    </div>
    <div class="bd">
      <div class="small">
        Conforme contrato Prestação de Serviço: Para todo deslocamento, a CONTRATANTE deverá arcar com as respectivas despesas, inclusive
        as horas pelo tempo de deslocamento dos profissionais da CONTRATADA.
        <br/>a. Fica estipulado que para deslocamentos superiores a 300 Km (trezentos quilômetros), da sede da
        CONTRATADA, será utilizado transporte aéreo, mediante validação prévia com a
        CONTRATANTE.
        <br/>b. São consideradas despesas com viagem, todo o desembolso tido com hospedagem (que deverão
        ser suítes individuais, em hotéis com no mínimo 3 estrelas), traslado, alimentação/refeição,
        pedágios, estacionamento, etc.
        <br/>c. Quando a CONTRATADA antecipar esses desembolsos, prestará contas por meio de
        comprovantes (notas fiscais, recibos, tickets, etc).
        <br/>d. A CONTRATANTE deverá arcar com custo de KM para deslocamento de prepostos da
        CONTRATADA para refeições.
      </div>
    </div>
    <div class="ft">
      <button class="secondary" id="btnContractBack">Voltar</button>
      <button class="primary" id="btnContractAccept">Li e concordo</button>
    </div>
  </div>
</div>

</body>
</html>



