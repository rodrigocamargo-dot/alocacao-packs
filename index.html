<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prot√≥tipo Naveg√°vel - Aloca√ß√£o por Packs</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --line:#1f2937; --accent:#22c55e; --info:#0ea5e9;
      --input:#0f172a; --radius:16px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(11,15,23,.92); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background:linear-gradient(135deg, rgba(34,197,94,.85), rgba(14,165,233,.85));
      box-shadow:0 8px 30px rgba(0,0,0,.35);
    }
    .title{display:flex; flex-direction:column; line-height:1.1}
    .title b{font-size:14px}
    .title span{font-size:12px;color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .tab{
      border:1px solid var(--line);
      background:rgba(17,24,39,.55);
      padding:8px 10px; border-radius:999px;
      font-weight:800; font-size:12px; cursor:pointer; user-select:none;
      color:var(--muted);
    }
    .tab.active{
      background:rgba(34,197,94,.18);
      color:var(--text);
      border-color:rgba(34,197,94,.35);
    }

    .wrap{padding:14px; display:grid; gap:14px}
    .page{display:none}
    .page.active{display:block}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1.8fr; /* esquerda pedido, direita agenda */
      gap:14px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 12px 40px rgba(0,0,0,.18);
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:13px; letter-spacing:.2px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .content{padding:12px 14px}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input,select,button,textarea{
      width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line);
      background:var(--input); color:var(--text); outline:none;
    }
    select[multiple]{padding:8px}
    textarea{min-height:84px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    button{cursor:pointer; font-weight:900}
    button.primary{
      background:linear-gradient(90deg,#16a34a,#22c55e);
      border:none; color:#061a0e;
    }
    button.secondary{
      background:rgba(14,165,233,.18);
      border:1px solid rgba(14,165,233,.35);
      color:#bae6fd;
    }
    button.ghost{
      background:transparent;
      border:1px dashed var(--line);
      color:var(--muted);
    }
    .muted{color:var(--muted);font-size:12px}
    .pill{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      background:rgba(15,23,42,.6);
    }
    .pill.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12); color:#a7f3d0}
    .pill.info{border-color:rgba(14,165,233,.40); background:rgba(14,165,233,.12); color:#bae6fd}

    .steps{display:grid; gap:8px; margin-top:10px}
    .step{
      border:1px dashed var(--line); border-radius:14px; padding:10px;
      display:flex; justify-content:space-between; gap:8px; align-items:center;
    }
    .step b{font-size:13px}
    .badge{
      font-size:11px; padding:4px 10px; border-radius:999px;
      background:rgba(16,185,129,.18);
      border:1px solid rgba(16,185,129,.45);
      color:#ecfdf3;
      font-weight:1000;
    }

    .grid{
      margin-top:12px;
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:auto;
      max-height:520px;
      display:block;
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:10px; text-align:center; white-space:nowrap;
      background:rgba(17,24,39,.35);
    }
    thead th{
      position:sticky; top:0; z-index:3;
      background:#0f172a;
      font-size:12px; color:var(--muted);
    }
    th:first-child, td:first-child{
      position:sticky; left:0; z-index:4;
      background:#0f172a; text-align:left; min-width:280px;
    }
    td:last-child, th:last-child{border-right:none}
    tr:last-child td{border-bottom:none}

    .name{font-weight:1000; font-size:13px}
    .sub{font-size:11px; color:var(--muted)}
    .slot{display:grid; gap:6px}
    .chip{
      padding:6px 8px; border-radius:12px; font-weight:1000; font-size:12px;
      border:1px solid transparent; user-select:none;
      display:flex; justify-content:space-between; gap:6px; align-items:center;
    }
    
    .chip small{font-weight:900; opacity:.95}
    .chip:hover{filter:brightness(1.08)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .legend span{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dotL{background:rgba(34,197,94,.85)}
    .dotR{background:rgba(245,158,11,.9)}

    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:14px;
      z-index:100;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 80px rgba(0,0,0,.45);
    }
    .modal .head{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .modal .head b{font-size:13px}
    .modal .body{padding:12px 14px; display:grid; gap:10px}
    .modal .foot{padding:12px 14px; border-top:1px solid var(--line); display:flex; gap:10px}
    .btnRow{display:flex; gap:10px}
    .btnRow button{flex:1}

    .hr{height:1px;background:var(--line); margin:8px 0}

    .kpi{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
    .kpi .box{
      border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(15,23,42,.6)
    }
    .kpi .box b{font-size:18px}
    .kpi .box span{display:block; font-size:12px; color:var(--muted); margin-top:4px}
    .list{margin-top:10px; display:grid; gap:8px}
    .item{
      border:1px solid var(--line); border-radius:16px; padding:10px 12px;
      background:rgba(15,23,42,.55);
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .item b{font-size:13px}
    .item div{font-size:12px; color:var(--muted); margin-top:4px}
    .item .tag{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(14,165,233,.35);
      background:rgba(14,165,233,.12);
      color:#bae6fd; font-weight:900;
      white-space:nowrap;
    }

    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter:grayscale(.2);
    }
    .isDisabled{
      opacity:.55;
      filter:grayscale(.2);
    }

@media (max-width: 1100px){
      .grid2{grid-template-columns:1fr}
      th:first-child, td:first-child{min-width:240px}
    }
  
    /* ===== Etapa 4 ‚Äì Modal Trocar Consultor (melhoria de usabilidade) ===== */
    .modalBackdrop{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; padding:18px; z-index:50;}
    .modal{width:min(1100px, 100%); background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.55); overflow:hidden;}
    .modalHeader{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:14px 16px; border-bottom:1px solid var(--line);}
    .modalHeader h3{margin:0; font-size:16px}
    .modalHeader .muted{margin:2px 0 0}
    .modalBody{padding:14px 16px;}
    .modalGrid{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;}
    @media (max-width: 980px){ .modalGrid{grid-template-columns:1fr;} }
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px}
    .toolbar input, .toolbar select{height:40px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); font-size:12px}
    .chip.good{border-color:rgba(34,197,94,.35)}
    .chip.warn{border-color:rgba(245,158,11,.45)}
    .chip.bad{border-color:rgba(239,68,68,.45)}
    .candList{display:grid; gap:8px; max-height:52vh; overflow:auto; padding-right:4px}
    .cand{display:flex; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02)}
    .cand:hover{border-color:rgba(14,165,233,.45)}
    .cand.selected{border-color:rgba(34,197,94,.55); box-shadow:0 0 0 2px rgba(34,197,94,.15) inset}
    .cand.better{border-color:rgba(34,197,94,.55); box-shadow:0 0 0 2px rgba(34,197,94,.12) inset}
    .cand h4{margin:0 0 4px; font-size:14px}
    .cand .meta{display:flex; flex-wrap:wrap; gap:6px}
    .cand .right{display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:160px}
    .kpi{font-size:12px; color:var(--muted); text-align:right}
    .kpi b{color:var(--text)}
    .miniCard{border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(255,255,255,.02)}
    .miniCard h4{margin:0 0 8px; font-size:14px}
    .compareRow{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 540px){ .compareRow{grid-template-columns:1fr;} }
    .compareBetter{
      border:1px solid rgba(34,197,94,.55);
      background:rgba(34,197,94,.12);
      border-radius:12px;
      padding:8px;
      box-shadow:0 0 0 2px rgba(34,197,94,.12) inset;
    }
    .quickReasons{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .quickReasons button{width:auto; padding:7px 10px}
    .modalFooter{display:flex; justify-content:space-between; gap:10px; padding:12px 16px; border-top:1px solid var(--line);}
    .modalFooter .left{display:flex; gap:8px; flex-wrap:wrap}
    .badge{display:inline-flex; align-items:center; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:var(--muted)}
    .badge.ok{border-color:rgba(34,197,94,.35); color:rgba(34,197,94,.95)}
    .badge.att{border-color:rgba(245,158,11,.45); color:rgba(245,158,11,.95)}
    .badge.off{border-color:rgba(239,68,68,.45); color:rgba(239,68,68,.95)}
    #swapBadgeSlot,
    #swapBadgeRule{
      background:rgba(14,165,233,.18);
      border-color:rgba(14,165,233,.45);
      color:#e0f2fe;
      text-shadow:0 1px 0 rgba(0,0,0,.35);
    }

  

    /* Agenda: cores por status */
    .chip.L, .L{
      background: rgba(34,197,94,.25);
      border-color: rgba(34,197,94,.80);
      color: #f0fdf4;
      cursor: pointer;
    }

    /* Melhora contraste em itens verdes */
    .pill.ok,
    .badge.ok,
    .chip.good,
    .chip.L,
    .L{
      color:#f0fdf4;
      text-shadow:0 1px 0 rgba(0,0,0,.35);
    }
    .chip.R, .R{
      background: rgba(245,158,11,.28);
      border-color: rgba(245,158,11,.90);
      color: #fff7ed;
      cursor: not-allowed;
      opacity: .92;
    }

.chip.sel{
      outline:2px solid rgba(14,165,233,.9);
      box-shadow:0 0 0 3px rgba(14,165,233,.25);
    }
    .multiBar{
      display:none;
      position:sticky;
      top:56px;
      z-index:20;
      margin:10px 0;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.92);
      backdrop-filter: blur(10px);
      border-radius:14px;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .multiBar.show{display:flex}
    .multiBar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .modalidadeRow{display:flex; gap:16px; margin-top:6px; align-items:center; flex-wrap:wrap}
    .modalidadeOption{display:flex; align-items:center; gap:8px; cursor:pointer}
    .modalidadeOption input{width:auto}

    #mSelected{padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:rgba(15,23,42,.55)}
    #mSelected .rowItem{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(148,163,184,.25)}
    #mSelected .rowItem:last-child{border-bottom:none}
    .multiBar *{pointer-events:auto}
</style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>Automa√ß√£o de Cronograma & Aloca√ß√£o</b>
        <span>Prot√≥tipo naveg√°vel (MVP) ‚Ä¢ M√∫ltiplos Packs ‚Ä¢ Interse√ß√£o de certifica√ß√£o ‚Ä¢ Agenda (L/R)</span>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" data-page="p1">1) Aloca√ß√£o do Projeto e Busca Recursos</div>
      <div class="tab" data-page="p2">2) Agenda & Reserva</div>
      <div class="tab" data-page="p3">3) Resumo</div>
      <div class="tab" data-page="p4">4) Em valida√ß√£o da Torre</div>
      <div class="tab" data-page="p5">5) Cronograma atualizado e validado pelo cliente</div>
    </div>
  </div>

  <div class="wrap">

    <!-- PAGE 1 -->
    <section class="page active" id="p1">
      <div class="grid2">
        <aside class="card">
          <h2>
            Dados Projeto e Packs Vendidos
            <span class="pill info" id="pillStatus">Preencha e avance</span>
          </h2>
          <div class="content">
            <label>FAP</label>
            <input id="fap" placeholder="Ex.: 123456" />

            <div class="row">
              <div>
                <label>Data in√≠cio</label>
                <input id="dtIni" type="date" />
              </div>
              <div>
                <label>Data fim</label>
                <input id="dtFim" type="date" />
              </div>
            </div>

            <label>Packs (selecione 1 ou mais)</label>
<div id="packsWrapper" style="display:none">
<details open style="background:rgba(15,23,42,.6); border:1px solid var(--line); border-radius:12px; padding:8px">
<summary style="cursor:pointer; font-weight:900; font-size:12px">Selecionar Packs</summary>
<div id="packsBox" style="display:grid; gap:8px; margin-top:8px">
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5309" style="width:auto" />
    <span>5309 Caixas e Bancos - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5283" style="width:auto" />
    <span>5283 Compras - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5285" style="width:auto" />
    <span>5285 Compras - Pack 3 / MD-e/DF-e</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5354" style="width:auto" />
    <span>5354 Conciliacao Bancaria Automatica OFX - Pack 2.1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5284" style="width:auto" />
    <span>5284 Cotacao - Pack 2</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5292" style="width:auto" />
    <span>5292 Estocagem - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5316" style="width:auto" />
    <span>5316 Fiscal - Pack 1 / Livro e SPED Fiscal</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5317" style="width:auto" />
    <span>5317 Fiscal - Pack 2 / SPED Contribuicoes</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5318" style="width:auto" />
    <span>5318 Fiscal - Pack 3 / EFD Reinf</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5313" style="width:auto" />
    <span>5313 Gerenciais - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5312" style="width:auto" />
    <span>5312 Gerenciais - Pack 2</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5302" style="width:auto" />
    <span>5302 Pagamentos - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5352" style="width:auto" />
    <span>5352 Pagamentos - Pack 2 / Centro de Resultado</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5291" style="width:auto" />
    <span>5291 Precificacao - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5304" style="width:auto" />
    <span>5304 Recebimentos - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5294" style="width:auto" />
    <span>5294 Vendas - Pack 1</span>
  </label>
  <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text); font-size:12px">
    <input type="checkbox" name="packs" value="5297" style="width:auto" />
    <span>5297 Vendas - Pack 4 / NFSe</span>
  </label>
</div>
</details>
</div>
<p class="muted" style="margin:6px 0 0">
  Dica: marque m√∫ltiplos packs para filtrar consultores que atendem <b>todos</b> (interse√ß√£o).
</p>

            <div id="stepsWrapper" style="display:none">
            <div class="steps" id="steps">
              <div class="muted">Selecione pelo menos 1 pack para carregar as etapas padr√£o.</div>
            </div>
            </div>

            <label>Observa√ß√µes (opcional)</label>
            <textarea id="obs" placeholder="Ex.: janela de go-live fixa, priorizar consultor ES, etc."></textarea>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Filtro de recurso</label>
                <select id="p1Vinculo">
                  <option value="REC">Recursos (CLT + Terceiro)</option>
                  <option value="ALL">Todos (CLT + Terceiro + BP)</option>
                  <option value="CLT">Somente CLT</option>
                  <option value="PJ">Somente Terceiro</option>
                  <option value="BP">Somente BP</option>
                </select>
              </div>
              <div>
                <label>Ordena√ß√£o</label>
                <select id="p1Sort">
                  <option value="SMART">Ordena√ß√£o inteligente (preferir CLT e disponibilidade)</option>
                  <option value="AVAIL">Maior disponibilidade no per√≠odo</option>
                  <option value="NAME">Nome (A-Z)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="secondary" id="btnIrAgenda" disabled>Ir para Agenda</button>
              <button class="primary" id="btnBuscar" disabled>Buscar disponibilidade</button>
            </div>
          </div>
        </aside>

        <section class="card">
          <h2>Pr√©via do que ser√° gerado</h2>
          <div class="content">
            <div class="kpi">
              <div class="box">
                <b id="kpiFap">‚Äî</b>
                <span>FAP</span>
              </div>
              <div class="box">
                <b id="kpiPeriodo">‚Äî</b>
                <span>Per√≠odo</span>
              </div>
              <div class="box">
                <b id="kpiPacks">‚Äî</b>
                <span>Packs selecionados</span>
              </div>
            </div>

            <div class="kpi" style="margin-top:10px">
              <div class="box">
                <b id="kpiCliente">‚Äî</b>
                <span>Cliente</span>
              </div>
              <div class="box">
                <b id="kpiGP">‚Äî</b>
                <span>Gerente de Projeto</span>
              </div>
              <div class="box">
                <b id="kpiFilial">‚Äî</b>
                <span>Filial Slim</span>
              </div>
            </div>

            <div class="hr"></div>

            <div id="metodologiaPreview" class="hidden">
              <div class="muted metodologia-title">Etapas (padr√£o metodologia):</div>
              <div class="list" id="previewSteps"></div>
            </div>

            <div class="hr"></div>

            <button class="ghost" id="btnAvancar1" disabled>Avan√ßar para Agenda & Reserva ‚Üí</button>

            <p class="muted" style="margin-top:10px">
              Regra de elegibilidade: o consultor precisa estar certificado em <b>todos</b> os packs selecionados (interse√ß√£o).
            </p>
          </div>
<div id="p5ClientFinalMsg" class="pill ok" style="display:none; margin-top:12px; padding:16px; font-size:18px; line-height:1.4; text-align:center">
  <strong style="font-size:22px; display:block; margin-bottom:6px;">
    Processo finalizado ‚úÖ
  </strong>
  Enviado para Sankhya Experience, agendas Confirmadas e acompanhar assinatura de valida√ß√£o do cronograma.
</div>
        </section>
      </div>
    </section>

    <!-- PAGE 2 -->
    <section class="page" id="p2">
      <div class="grid2">
        <aside class="card">
          <h2>
            FAP Selecionada
            <span class="pill ok" id="pillReady">Pronto para reservar</span>
          </h2>
          <div class="content">
            <div class="muted">FAP</div>
            <div style="font-weight:1000; font-size:16px" id="p2Fap">‚Äî</div>
            <div class="muted" style="margin-top:10px">Cliente</div>
            <div style="font-weight:900" id="p2Cliente">‚Äî</div>

            <div class="muted" style="margin-top:10px">Gerente de Projeto</div>
            <div style="font-weight:900" id="p2GP">‚Äî</div>

            <div class="muted" style="margin-top:10px">Filial Slim</div>
            <div style="font-weight:900" id="p2Filial">‚Äî</div>


            <div class="row" style="margin-top:10px">
              <div>
                <div class="muted">In√≠cio</div>
                <div style="font-weight:900" id="p2Ini">‚Äî</div>
              </div>
              <div>
                <div class="muted">Fim</div>
                <div style="font-weight:900" id="p2Fim">‚Äî</div>
              </div>
            </div>

            <div style="margin-top:10px">
              <div class="muted">Packs</div>
              <div style="font-weight:900" id="p2Packs">‚Äî</div>
            </div>

            <div class="steps" id="p2Steps" style="margin-top:12px"></div>

            <div class="row" style="margin-top:12px">
              <button class="secondary" id="btnVoltarPedido">‚Üê Voltar</button>
              <button class="primary" id="btnIrResumo">Ir para Resumo ‚Üí</button>
            </div>

            <p class="muted" style="margin-top:10px">
              Clique em um slot <b>L</b> para reservar. Status poss√≠veis: <b>L</b> (livre) e <b>R</b> (reservada).
            </p>
          </div>
        </aside>

        <section class="card">
          <h2>
            Consultores eleg√≠veis e Agenda (Per√≠odo informado)
            <span class="pill" id="pillCount">0 consultores</span>
          </h2>
          <div class="multiBar" id="multiBar">
            <div class="left">
              <span class="pill info" id="multiCount">0 selecionados</span>
              <span class="muted" id="multiHint">Use Shift para selecionar um intervalo</span>
            </div>
            <div class="row" style="margin:0; gap:8px">
              <button class="primary" style="width:auto" type="button" id="btnReserveSelected" onclick="openSelectedModal()">Reservar selecionados</button>
              <button class="ghost" style="width:auto" type="button" id="btnClearSelected">Limpar</button>
            </div>
          </div>
        
          <div class="content">
            <div class="grid">
              <table id="agendaTable">
                <thead><tr id="theadRow"></tr></thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div class="legend">
              <span><i class="dot dotL"></i> L = Livre</span>
              <span><i class="dot dotR"></i> R = Reservada</span>
            </div>

            <p class="muted" style="margin-top:10px">
              Observa√ß√£o (MVP): ao reservar, o slot fica <b>R</b> para o consultor naquela data/turno (evita dupla reserva entre packs).
            </p>
          </div>
        </section>
      </div>
    </section>

    <!-- PAGE 3 -->
    <section class="page" id="p3">
      <div class="grid2">
        <aside class="card">
          <h2>Resumo do Cronograma</h2>
          <div class="content">
            <div class="kpi">
              <div class="box">
                <b id="kpi3Fap">‚Äî</b>
                <span>FAP</span>
              </div>
              <div class="box">
                <b id="kpi3Packs">‚Äî</b>
                <span>Packs selecionados</span>
              </div>
              <div class="box">
                <b id="kpi3Res">0</b>
                <span>Reservas (turnos)</span>
              </div>
            </div>
            <div class="kpi" style="margin-top:10px">
              <div class="box">
                <b id="kpi3Cliente">‚Äî</b>
                <span>Cliente</span>
              </div>
              <div class="box">
                <b id="kpi3GP">‚Äî</b>
                <span>Gerente de Projeto</span>
              </div>
              <div class="box">
                <b id="kpi3Filial">‚Äî</b>
                <span>Filial Slim</span>
              </div>
              <div class="box">
                <b id="kpi3Lider">‚Äî</b>
                <span>L√≠der da Torre</span>
              </div>
              <div class="box">
                <b id="kpi3GestorPMO">‚Äî</b>
                <span>Gestor PMO</span>
              </div>
            </div>


            <div class="hr"></div>

            <button class="primary" id="btnSendValidationFromResumo">Enviar para Valida√ß√£o do L√≠der da Torre</button>
            <button class="secondary" id="btnVoltarAgenda" style="margin-top:10px">‚Üê Voltar para Agenda</button>
            <button class="primary" id="btnLimpar" style="margin-top:10px">Limpar reservas</button>

            <div id="resumoExports" style="display:none; margin-top:10px">
              <div class="row">
                <button class="secondary" id="btnResumoPdf" type="button">Salvar PDF</button>
                <button class="secondary" id="btnResumoCsv" type="button">Exportar Excel (CSV)</button>
              </div>
            </div>

            <p class="muted" style="margin-top:10px">
              No resumo, cada item mostra <b>Pack</b> antes da <b>Etapa</b>.
            </p>
          </div>
        </aside>

        <section class="card">
          <h2>Lista de reservas</h2>
          <div class="content">
            <div class="grid">
              <table id="resumoTable">
                <thead>
                  <tr>
                    <th>Etapa</th>
                    <th>Pack</th>
                    <th>Consultor</th>
                    <th>Data in√≠cio</th>
                    <th>Data fim</th>
                    <th>Per√≠odo</th>
                    <th>Remoto/Presencial</th>
                  </tr>
                </thead>
                <tbody id="resumoBody"></tbody>
              </table>
            </div>
            <div id="resumoEmpty" class="muted" style="margin-top:10px; display:none">Nenhuma reserva registrada ainda.</div>
          </div>
        </section>
      </div>
    </section>


    <!-- PAGE 4 -->
    <section class="page" id="p4">
  <div id="p4Guard" class="card" style="margin-bottom:12px; display:none">
    <div class="content">
      <p class="muted">O cronograma ainda n√£o foi enviado para valida√ß√£o do L√≠der da Torre.</p>
      <p class="muted">Envie pela <b>Etapa 3 ‚Äì Resumo</b> para liberar esta etapa.</p>
    </div>
  </div>
  <div id="p4Content">
      <div class="grid2">
        <aside class="card">
          <h2>Em valida√ß√£o da Torre</h2>
          <div class="content">
            <p class="muted">
              Esta etapa ocorre <b>ap√≥s o resumo</b> e n√£o faz parte da metodologia do projeto.
              Aqui o cronograma consolidado √© submetido para valida√ß√£o do L√≠der da Torre.
            </p>

            <div class="kpi" style="margin-top:10px">
              <div class="box">
                <b id="p4Fap">‚Äî</b>
                <span>FAP</span>
              </div>
              <div class="box">
                <b id="p4Cliente">‚Äî</b>
                <span>Cliente</span>
              </div>
              <div class="box">
                <b id="p4GP">‚Äî</b>
                <span>Gerente de Projeto</span>
              </div>
              <div class="box">
                <b id="p4Filial">‚Äî</b>
                <span>Filial Slim</span>
              </div>
              <div class="box">
                <b id="p4Lider">‚Äî</b>
                <span>L√≠der da Torre</span>
              </div>
              <div class="box">
                <b id="p4GestorPMO">‚Äî</b>
                <span>Gestor PMO</span>
              </div>
            </div>

            <div class="hr"></div>
            <h3 style="margin:8px 0 6px">Alertas: escolha de TERCEIRO ou BP</h3>
            <div class="list" id="p4ThirdPartyAlerts"></div>

            <div id="p4ObsWrap" style="margin-top:10px; display:none">
              <h3 style="margin:8px 0 6px">Observa√ß√µes do Gerente de Projeto</h3>
              <div class="miniCard">
                <div class="muted" id="p4ObsText">‚Äî</div>
              </div>
            </div>

            <label>Respons√°vel pela Valida√ß√£o</label>
            <input placeholder="Nome do L√≠der da Torre" />

            <label>Coment√°rio para Valida√ß√£o</label>
            <textarea id="p4ValidationComment" placeholder="Ex.: Validar aloca√ß√£o, carga do consultor e datas de go-live"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="secondary" onclick="goto('p3')">Confira o resumo agendas</button>
              
            
              <button class="primary" id="btnEnviarValidacao">Enviar para Gerente de Projeto</button>
            </div>
          </div>
        </aside>

        
        <section class="card">
          <h2>Ajustes do L√≠der (simula√ß√£o)</h2>
          <div class="content">
            <p class="muted">
              Aqui o L√≠der pode ajustar reservas antes de aprovar. Cada ajuste fica registrado e aparecer√° na etapa 5.
            </p>

            <div class="list" id="leaderResList"></div>

            <p class="muted" style="margin-top:10px">
              A√ß√µes dispon√≠veis: <b>Cancelar</b> ou <b>Trocar consultor</b> (mant√©m data/turno/pack).
            </p>
          </div>
        </section>
    
      </div>
    </section>



    <!-- PAGE 5 -->
    <section class="page" id="p5">
      <div id="p5Guard" class="card" style="margin-bottom:12px; display:none">
  <div class="content">
    <p class="muted">O cronograma ainda n√£o foi enviado para valida√ß√£o do L√≠der da Torre.</p>
    <p class="muted">Envie pela <b>Etapa 3 ‚Äì Resumo</b> para liberar esta etapa.</p>
  </div>
</div>
<div id="p5Content">
<div class="grid2">
        <aside class="card">
          <h2>Cronograma atualizado e validado pelo cliente</h2>
          <div class="hr"></div>
          <h3 style="margin:8px 0 6px">Ajustes realizados pelo L√≠der</h3>
          <div class="list" id="leaderChangesHeader"></div>
          
          <h2>Em valida√ß√£o da Torre</h2>
          <div class="content">
            <p class="muted">
              Esta etapa ocorre <b>ap√≥s o resumo</b> e n√£o faz parte da metodologia do projeto.
              Aqui o cronograma consolidado √© submetido para valida√ß√£o do L√≠der da Torre.
            </p>

            <div class="hr"></div>
            <h3 style="margin:8px 0 6px">Alertas: escolha de TERCEIRO ou BP</h3>
            <div class="list" id="p4ThirdPartyAlerts"></div>

            <label>Respons√°vel pela Valida√ß√£o</label>
            <input placeholder="Nome do L√≠der da Torre" />

            <label>Coment√°rio para Valida√ß√£o</label>
            <textarea id="p5ValidationComment" placeholder="Ex.: Validar aloca√ß√£o, carga do consultor e datas de go-live" readonly></textarea>

            <div class="row" style="margin-top:12px">
              <button class="secondary" onclick="goto('p3')">Confira o resumo agendas</button>
              
            </div>
          </div>
        
        </aside>

        <section class="card">
          <h2>Altera√ß√µes do L√≠der na agenda</h2>
          <div class="content">
            <div class="kpi">
              <div class="box">
                <b id="kpi5Fap">‚Äî</b>
                <span>FAP</span>
              </div>
              <div class="box">
                <b id="kpi5Packs">‚Äî</b>
                <span>Packs selecionados</span>
              </div>
              <div class="box">
                <b id="kpi5Status">‚Äî</b>
                <span>Status</span>
              </div>
            </div>

            <div class="kpi" style="margin-top:10px">
              <div class="box">
                <b id="kpi5Cliente">‚Äî</b>
                <span>Cliente</span>
              </div>
              <div class="box">
                <b id="kpi5GP">‚Äî</b>
                <span>Gerente de Projeto</span>
              </div>
              <div class="box">
                <b id="kpi5Filial">‚Äî</b>
                <span>Filial Slim</span>
              </div>
            </div>

            <div class="hr"></div>

            <div class="list" id="leaderChangesList"></div>
<div class="hr"></div>
<div id="p5AcceptArea" style="display:none">
  <div class="row">
    <button class="primary" id="btnGpAccept">Aceite do Gerente de Projeto</button>
    <button class="secondary" id="btnGpReject">N√£o Aceito (solicitar ajustes ao L√≠der)</button>
  </div>
  <p class="muted" style="margin-top:8px">
    Aceite: conclui a aloca√ß√£o e o cronograma. N√£o Aceito: retorna para o L√≠der da Torre ajustar.
  </p>
</div>
<div id="p5FinalMsg" class="pill ok" style="display:none; margin-top:12px; padding:16px; font-size:18px; line-height:1.4; text-align:center">
  <strong style="font-size:22px; display:block; margin-bottom:6px;">
    Parab√©ns! üéâ
  </strong>
  A Aloca√ß√£o dos recursos para seu projeto foi conclu√≠do.<br/>
  <strong>Est√° pronto para Validar cronograma com Cliente.</strong>
</div>
<div id="p5ClientArea" style="display:none; margin-top:12px; text-align:center">
  <button class="primary" id="btnClientValidated">Validado com Cliente</button>
  <p class="muted" id="p5ClientNote" style="margin-top:8px">
    Ao confirmar, registraremos que todas as agendas foram confirmadas e que o cronograma foi enviado para o Sankhya Experience para valida√ß√£o final.
  </p>
</div>
<div id="p5ReprogramArea" style="display:none; margin-top:12px; text-align:center">
  <button class="secondary" id="btnReprogramStart">Reprogramar cronograma e agendas</button>
</div>
          </div>
        
  </div>
</section>
      </div>
    </section>


  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="head">
        <b>Reservar agenda</b>
        <button class="ghost" id="btnCloseModal" style="width:auto">‚úï</button>
      </div>
      <div class="body">
        <div class="muted">Consultor</div>
        <div style="font-weight:1000" id="mConsultor">‚Äî</div>

        <div class="row">
          <div>
            <div class="muted">Data</div>
            <div style="font-weight:900" id="mData">‚Äî</div>
          </div>
          <div>
            <div class="muted">Turno</div>
            <div style="font-weight:900" id="mTurno">‚Äî</div>
          <div class="muted" style="margin-top:8px; display:none" id="mSelectedLabel">Per√≠odos selecionados</div>
          <div style="display:none" id="mSelected" class="card" ></div>
          </div>
        </div>

        <label>Pack da reserva</label>
        <select id="mPack"></select>


        <label id="lblJustPJ" style="display:none">Justificativa (obrigat√≥ria ao escolher TERCEIRO ou BP)</label>
        <textarea id="mJustPJ" style="display:none" placeholder="Explique o motivo da escolha do consultor TERCEIRO ou BP (ex.: especializa√ß√£o, urg√™ncia, continuidade, indisponibilidade do CLT no slot necess√°rio, etc.)"></textarea>

        <label>Etapa (obrigat√≥ria)</label>
        <select id="mEtapa">
<option value="">Selecione...</option>
        </select>


        <label id="lblJustPJ" style="display:none">Justificativa (obrigat√≥ria ao escolher TERCEIRO ou BP)</label>
        <textarea id="mJustPJ" style="display:none" placeholder="Explique o motivo da escolha do consultor TERCEIRO ou BP (ex.: especializa√ß√£o, urg√™ncia, continuidade, indisponibilidade do CLT no slot necess√°rio, etc.)"></textarea>

        <div class="btnRow">
          <button class="secondary" id="btnReserveHalf">Reservar s√≥ este turno</button>
          <button class="primary" id="btnReserveDay">Reservar dia todo</button>
        </div>

        <button class="ghost" id="btnCancelReserve">Cancelar reserva (se existir)</button>

        <p class="muted">
          Regra: s√≥ reserva se o slot estiver <b>L</b>. Se estiver <b>R</b>, n√£o permite.
        </p>
      </div>
      <div class="foot">
        <button class="ghost" id="btnCloseModal2">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    let packs = {
      "5309": { nome: "5309 Caixas e Bancos - Pack 1" },
      "5283": { nome: "5283 Compras - Pack 1" },
      "5285": { nome: "5285 Compras - Pack 3 / MD-e/DF-e" },
      "5354": { nome: "5354 Conciliacao Bancaria Automatica OFX - Pack 2.1" },
      "5284": { nome: "5284 Cotacao - Pack 2" },
      "5292": { nome: "5292 Estocagem - Pack 1" },
      "5316": { nome: "5316 Fiscal - Pack 1 / Livro e SPED Fiscal" },
      "5317": { nome: "5317 Fiscal - Pack 2 / SPED Contribuicoes" },
      "5318": { nome: "5318 Fiscal - Pack 3 / EFD Reinf" },
      "5313": { nome: "5313 Gerenciais - Pack 1" },
      "5312": { nome: "5312 Gerenciais - Pack 2" },
      "5302": { nome: "5302 Pagamentos - Pack 1" },
      "5352": { nome: "5352 Pagamentos - Pack 2 / Centro de Resultado" },
      "5291": { nome: "5291 Precificacao - Pack 1" },
      "5304": { nome: "5304 Recebimentos - Pack 1" },
      "5294": { nome: "5294 Vendas - Pack 1" },
      "5297": { nome: "5297 Vendas - Pack 4 / NFSe" },
    };
    // Cat√°logo (MVP): dados do pedido por FAP
    // Em produ√ß√£o, isso viria do ERP/CRM (ex.: Sankhya) via API.
    let fapCatalog = {
      "1010": {
        cliente: "ITC INDUSTRIA DE TERCEIRIZACAO DE COSMETICOS",
        gp: "Isabel Vieira",
        filial: "Filial Belo Horizonte",
        lider: "Renata Pinheiro",
        gestorPMO: "Andreia Comaccio"
      },

      "100001": { cliente: "Politintas", gp: "Renata", filial: "Slim BH" },
      "100002": { cliente: "Atacadista de Fraldas", gp: "Andreia", filial: "Slim Uberl√¢ndia" },
      "100003": { cliente: "AGC", gp: "Carol", filial: "Slim ES" }
      ,
      "31200": {
        cliente: "Labor Engenharia e Tecnologia SA",
        gp: "Milca Delmonico",
        filial: "Slim BH",
        lider: "Adriano Goncalves",
        gestorPMO: "Kassius Lima"
      }
    };


    const etapasPadrao = ["Valida√ß√£o de Escopo","Simula√ß√£o","Go-live","Entrada em Produ√ß√£o"];

    let consultoresBase = [
      { codusu:"U001", nome:"MARCELO.AVELAR",  sub:"FILIAL DC SUDESTE", nivel:"Senior" },
      { codusu:"U002", nome:"BRUNA.BOLT",      sub:"TERCEIROS",          nivel:"Pleno"  },
      { codusu:"U003", nome:"DANILO.BOLT",     sub:"TERCEIROS",          nivel:"Junior" },
      { codusu:"U004", nome:"NAYRA.SILVA",     sub:"FILIAL ES",          nivel:"Pleno"  },
      { codusu:"U005", nome:"HERMES.LIMA",     sub:"FILIAL BH",          nivel:"Senior" },
      { codusu:"U006", nome:"MARCO.AURELIO",   sub:"BP",                 nivel:"Senior" },
      { codusu:"U007", nome:"MARINA.ROCHA",    sub:"DELIVERY CENTER",    nivel:"Junior" },
      { codusu:"U008", nome:"HENRIQUE.PINTO",  sub:"DELIVERY CENTER",    nivel:"Senior" },
      { codusu:"U009", nome:"ANDRES.PIPET",    sub:"DELIVERY CENTER",    nivel:"Pleno"  },
      { codusu:"U010", nome:"THIAGO.BOLT",     sub:"TERCEIROS",          nivel:"Senior" },
      { codusu:"U011", nome:"GUILHERME.BRION", sub:"TERCEIROS",          nivel:"Senior" },
    ];

    let cert = {
      "5309": ["U007","U008","U009","U010","U011","U006"],
      "5283": ["U007","U008","U009","U010","U011","U006"],
      "5285": [],
      "5354": [],
      "5284": ["U007","U008","U009","U010","U011"],
      "5292": ["U007","U008","U009","U010","U011"],
      "5316": ["U007","U010"],
      "5317": ["U007","U010"],
      "5318": ["U007"],
      "5313": ["U009"],
      "5312": ["U009"],
      "5302": ["U007","U008","U009","U010","U011"],
      "5352": [],
      "5291": ["U007","U008","U009","U010","U011"],
      "5304": ["U007","U008","U009","U010","U011"],
      "5294": ["U007","U008","U009","U010","U011"],
      "5297": ["U007"],
    };

    function baseStatusLR(seed, dayIndex, turno){
      const n = (seed*17 + dayIndex*7 + (turno==="M"?1:2)) % 9;
      return (n === 0 || n === 4) ? "R" : "L";
    }

    let reservas = [];
    // Seeds de teste: Marco Aurelio (BP) reservado em datas entre 01/01/2026 e 01/03/2026
    reservas.push(
      { fap:"TESTE", packId:"5283", codusu:"U006", dataISO:"2026-01-02", turno:"M", etapa:"Simulacao", modalidade:"Remoto", justPJ:"Teste BP" },
      { fap:"TESTE", packId:"5283", codusu:"U006", dataISO:"2026-01-10", turno:"T", etapa:"Simulacao", modalidade:"Remoto", justPJ:"Teste BP" },
      { fap:"TESTE", packId:"5283", codusu:"U006", dataISO:"2026-02-05", turno:"M", etapa:"Go-live", modalidade:"Presencial", justPJ:"Teste BP" },
      { fap:"TESTE", packId:"5283", codusu:"U006", dataISO:"2026-02-20", turno:"T", etapa:"Go-live", modalidade:"Presencial", justPJ:"Teste BP" },
      { fap:"TESTE", packId:"5283", codusu:"U006", dataISO:"2026-03-01", turno:"M", etapa:"Entrada em Producao", modalidade:"Remoto", justPJ:"Teste BP" }
    );
    let reprogramReasonsByFap = {}; // fap -> {reason, detail, whenISO}
    let resumoRowsCache = [];

    // Persist√É¬™ncia simples (localStorage)
    const STORAGE_KEY = "locacao-recursos-v1";

    function scheduleSave(){
      try{
        const payload = {
          state,
          reservas,
          validationStatusByFap,
          sentToValidation,
          acceptedChangesByFap,
          leaderChanges,
          reprogramReasonsByFap
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(e){
        console.warn("Falha ao salvar dados locais.", e);
      }
    }

    async function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        console.warn("Falha ao carregar dados locais.", e);
        return null;
      }
    }

    function applyData(data){
      if(!data || typeof data !== "object") return;
      if(data.state && typeof data.state === "object"){
        Object.assign(state, data.state);
      }
      if(Array.isArray(data.reservas)){
        reservas = data.reservas;
      }
      if(data.validationStatusByFap && typeof data.validationStatusByFap === "object"){
        validationStatusByFap = data.validationStatusByFap;
      }
      if(data.sentToValidation && typeof data.sentToValidation === "object"){
        sentToValidation = data.sentToValidation;
      }
      if(data.acceptedChangesByFap && typeof data.acceptedChangesByFap === "object"){
        acceptedChangesByFap = data.acceptedChangesByFap;
      }
      if(Array.isArray(data.leaderChanges)){
        leaderChanges = data.leaderChanges;
      }
      if(data.reprogramReasonsByFap && typeof data.reprogramReasonsByFap === "object"){
        reprogramReasonsByFap = data.reprogramReasonsByFap;
      }
    }

    function applyStateToUI(){
      const fapEl = document.getElementById("fap");
      if(fapEl) fapEl.value = state.fap || "";
      const dtIniEl = document.getElementById("dtIni");
      if(dtIniEl && state.dtIni) dtIniEl.value = state.dtIni;
      const dtFimEl = document.getElementById("dtFim");
      if(dtFimEl && state.dtFim) dtFimEl.value = state.dtFim;
      const obsEl = document.getElementById("obs");
      if(obsEl) obsEl.value = state.obs || "";
      const p4Comment = document.getElementById("p4ValidationComment");
      if(p4Comment) p4Comment.value = state.validationComment || "";

      const packSet = new Set((state.packIds || []).filter(Boolean));
      document.querySelectorAll('input[name="packs"]').forEach((cb) => {
        cb.checked = packSet.has(cb.value);
      });
    }

    function getReservaEtapaStatus(etapa){
      // Retorna: "none" | "partial" | "full"
      try{
        const packsSel = (state.packIds || []).filter(Boolean);
        if(packsSel.length === 0) return "none";

        const reserved = new Set(
          reservas
            .filter(r => r.fap===state.fap && (r.etapa||'')===etapa && (r.packId||''))
            .map(r => r.packId)
        );

        if(packsSel.length === 1){
          return reserved.has(packsSel[0]) ? "full" : "none";
        }

        let count = 0;
        packsSel.forEach(pid => { if(reserved.has(pid)) count++; });

        if(count === 0) return "none";
        if(count < packsSel.length) return "partial";
        return "full";
      }catch(e){
        return "none";
      }
    }

    function badgeReservaEtapaHTML(etapa){
      const st = getReservaEtapaStatus(etapa);
      if(st === "full"){
        return `<span class="badge" style="margin-left:8px; background:rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.45); color:#a7f3d0;">Agenda reservada</span>`;
      }
      if(st === "partial"){
        return `<span class="badge" style="margin-left:8px; background:rgba(245,158,11,.18); border:1px solid rgba(245,158,11,.55); color:#fde68a;">Agenda reservada parcial</span>`;
      }
      return ``;
    }

    // {fap, packId, codusu, dataISO, turno('M'|'T'), etapa, modalidade('Presencial'|'Remoto'), justPJ?}
    let leaderChanges = []; // {whenISO, fap, action, detail}
    let validationStatusByFap = {};
    let sentToValidation = {}; // fap -> true/false
    let acceptedChangesByFap = {}; // fap -> true/false (aceite do GP) // fap -> "Pendente" | "Enviado" | "Validado"

    let currentEligible = [];
    let currentDays = [];
    let selectedSlots = []; // [{codusu, nome, iso, turno, idx}]
    let selectedCodusu = null;
    let lastSelectedIdx = null;


    const state = { fap:"", dtIni:"", dtFim:"", packIds:[], obs:"", validationComment:"", cliente:"", gp:"", filial:"", lider:"", gestorPMO:"", searched:false };

    // Mostrar packs somente ap√≥s informar FAP
    function togglePacksVisibility(){
      const wrap = document.getElementById("packsWrapper");
      if(!wrap) return;

      const show = !!state.fap; // ‚úÖ igual comportamento da v5: s√≥ depende do FAP
      wrap.style.display = show ? "block" : "none";

      // Se limpou FAP, resetar packs/etapas
      if(!show){
        const checks = Array.from(document.querySelectorAll('input[name="packs"]'));
        checks.forEach(c => c.checked = false);
        state.packIds = [];
        state.searched = false;
        renderStepsP1();
        toggleStepsByPacks();
        updateActionButtons();
      }
    }

function toggleStepsByPacks(){
      const sw = document.getElementById("stepsWrapper");
      if(!sw) return;
      // Mostrar etapas da metodologia no lado esquerdo SOMENTE ap√≥s "Buscar disponibilidade"
      const hasPacks = (state.packIds && state.packIds.length);
      sw.style.display = (hasPacks && state.searched) ? "block" : "none";
    }

    function updateActionButtons(){
      const ok = validatePedido(false);
      const btnBuscar = document.getElementById("btnBuscar");
      const btnIrAgenda = document.getElementById("btnIrAgenda");
      const btnAvancar = document.getElementById("btnAvancar1");
      if(btnBuscar) btnBuscar.disabled = !ok;
      if(btnIrAgenda) btnIrAgenda.disabled = !ok;
      if(btnAvancar) btnAvancar.disabled = !ok;
    }


    const pad = n => String(n).padStart(2,"0");
    function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function fmtBR(iso){
      if(!iso) return "‚Äî";
      const [y,m,d]=iso.split("-");
      return `${d}/${m}/${y}`;
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }
    function buildDaysRange(iniISO, fimISO){
      const ini = new Date(iniISO + "T00:00:00");
      const fim = new Date(fimISO + "T00:00:00");
      const out = [];
      let cur = ini;
      while(cur <= fim){
        out.push(new Date(cur));
        cur = addDays(cur, 1);
      }
      return out;
    }
    
    function hasCltAvailabilityInPeriod(){
      // Se existir ao menos 1 consultor CLT eleg√≠vel com qualquer slot L no per√≠odo, retorna true
      const clts = currentEligible.filter(c => vinculoFromSub(c.sub) === "CLT");
      if(!clts.length) return false;
      if(!state.dtIni || !state.dtFim) return false;
      const days = buildDaysRange(state.dtIni, state.dtFim);
      for(const c of clts){
        const seed = c.seed || 1;
        for(let di=0; di<days.length; di++){
          const iso = toISODate(days[di]);
          const baseM = baseStatusLR(seed, di, "M");
          const baseT = baseStatusLR(seed, di, "T");
          const m = getSlotStatusLR(c.codusu, iso, "M", baseM);
          const t = getSlotStatusLR(c.codusu, iso, "T", baseT);
          if(m === "L" || t === "L") return true;
        }
      }
      return false;
    }

    function vinculoFromSub(sub){
      const s = (sub || "").toUpperCase();
      if(s.includes("BP")) return "BP";
      return s.includes("TERCEIR") ? "PJ" : "CLT";
    }

    function nowISO(){
      const d = new Date();
      return d.toISOString();
    }

    function logLeaderChange(action, detail){
      leaderChanges.push({ whenISO: nowISO(), fap: state.fap, action, detail });
    }


    function packsLabel(ids){
      if(!ids || !ids.length) return "‚Äî";
      return ids.map(pid => packs[pid]?.nome || pid).join(" ‚Ä¢ ");
    }

    // Navega√ß√£o
    const tabs = document.querySelectorAll(".tab");
    function goto(pageId){
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(pageId).classList.add("active");
      tabs.forEach(t => t.classList.toggle("active", t.dataset.page === pageId));
      if(pageId === "p2"){ syncP2(); renderAgenda();
      renderStepsP1(); }
      if(pageId === "p3"){ renderResumo(); }
      if(pageId === "p4"){ guardP4(); if(sentToValidation[state.fap]){ renderLeaderResList(); renderP4ThirdPartyAlerts(); } }
      if(pageId === "p5"){ guardP5(); if(sentToValidation[state.fap]){ renderValidated(); } }
      window.scrollTo({top:0, behavior:"smooth"});
    }
    tabs.forEach(t => t.addEventListener("click", () => goto(t.dataset.page)));

    // P√°gina 1
    const elFap = document.getElementById("fap");
    const elIni = document.getElementById("dtIni");
    const elFim = document.getElementById("dtFim");
    const elPackChecks = Array.from(document.querySelectorAll('input[name="packs"]'));
    const elObs = document.getElementById("obs");
    const elP4Comment = document.getElementById("p4ValidationComment");

    function applyFapSelection(fapVal){
      state.fap = fapVal;
      const info = fapCatalog[state.fap];
      state.cliente = info?.cliente || "";
      state.gp      = info?.gp || "";
      state.filial  = info?.filial || "";
      state.lider   = info?.lider || "";
      state.gestorPMO = info?.gestorPMO || "";
      state.searched = false;
      togglePacksVisibility();
      refreshPreview();
    }

    elFap.addEventListener("input", () => {
      const prevFap = state.fap || "";
      const fapVal = elFap.value.trim();
      if(!fapVal){
        applyFapSelection("");
        return;
      }

      const st = validationStatusByFap[fapVal] || "";
      if(st === "Cronograma atualizado e validado pelo cliente"){
        const ok = confirm("Este projeto j√° tem cronograma validado com Cliente. Deseja reprogramar o Cronogramas e Agendas?");
        if(!ok){
          elFap.value = prevFap;
          return;
        }
        openReprogramModal(fapVal, () => {
          applyFapSelection(fapVal);
        }, prevFap);
        return;
      }

      applyFapSelection(fapVal);
    });
    elIni.addEventListener("change", () => { state.dtIni = elIni.value; state.searched = false; togglePacksVisibility(); refreshPreview(); });
    elFim.addEventListener("change", () => { state.dtFim = elFim.value; state.searched = false; togglePacksVisibility(); refreshPreview(); });
    elObs.addEventListener("input", () => { state.obs = elObs.value; });
    if(elP4Comment){
      elP4Comment.addEventListener("input", () => { state.validationComment = elP4Comment.value; });
    }

    ["p1Vinculo","p1Sort"].forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("change", () => {
          if(id === "p1Vinculo"){
            const v = el.value;
            if(v === "ALL" || v === "BP"){
              alert("Atencao: esta opcao nao e a melhor pratica. De preferencia para CLT e Terceiros. As agendas reservadas BP passarao por validacao do Lider da Torre e vera possibilidade de negociar com BP.");
            }
          }
          renderAgenda();
        });
        el.addEventListener("input", renderAgenda);
      }
    });

    elPackChecks.forEach(cb => cb.addEventListener("change", () => {
      state.packIds = elPackChecks.filter(x => x.checked).map(x => x.value);
      state.searched = false;
      renderStepsP1();
      togglePacksVisibility();
      toggleStepsByPacks();
      updateActionButtons();
      refreshPreview();
    }));

function renderStepsP1(){
      const box = document.getElementById("steps");
      const preview = document.getElementById("previewSteps");
      box.innerHTML = "";
      preview.innerHTML = "";

      if(!state.packIds.length){
        box.innerHTML = `<div class="muted">Selecione pelo menos 1 pack para carregar as etapas padr√£o.</div>`;
        preview.innerHTML = `<div class="muted">‚Äî</div>`;
        return;
      }

      etapasPadrao.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "step";
        div.innerHTML = `<div><b>${i+1}. ${s}</b><div class="muted">Etapa padr√£o</div></div><span class="badge metodologia">Metodologia</span>${badgeReservaEtapaHTML(s)}`;
        box.appendChild(div);

        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `<div><b>${i+1}. ${s}</b><div>Planejamento autom√°tico por packs</div></div><span class="tag">Etapa</span>`;
        preview.appendChild(it);
      });
    }

    function refreshPreview(){
      document.getElementById("kpiFap").textContent = state.fap || "‚Äî";
      const per = (state.dtIni && state.dtFim) ? `${fmtBR(state.dtIni)} ‚Üí ${fmtBR(state.dtFim)}` : "‚Äî";
      document.getElementById("kpiPeriodo").textContent = per;
      document.getElementById("kpiPacks").textContent = packsLabel(state.packIds);
      const elCli = document.getElementById("kpiCliente"); if(elCli) elCli.textContent = state.cliente || "‚Äî";
      const elGP = document.getElementById("kpiGP"); if(elGP) elGP.textContent = state.gp || "‚Äî";
      const elFil = document.getElementById("kpiFilial"); if(elFil) elFil.textContent = state.filial || "‚Äî";

      const ok = !!(state.fap && state.dtIni && state.dtFim && state.packIds.length && state.dtFim >= state.dtIni);
      const pill = document.getElementById("pillStatus");
      pill.textContent = ok ? "Pronto para buscar" : "Preencha e avance";
      pill.className = "pill " + (ok ? "ok" : "info");

      toggleStepsByPacks();
      updateActionButtons();
    }

    document.getElementById("btnAvancar1").addEventListener("click", () => goto("p2"));
    document.getElementById("btnIrAgenda").addEventListener("click", () => goto("p2"));

    document.getElementById("btnBuscar").addEventListener("click", () => {
      const mp = document.getElementById("metodologiaPreview"); if(mp) mp.classList.remove("hidden");
      if(!validatePedido(true)) return;

      // Marca que o usu√°rio executou a busca (para liberar visualiza√ß√£o das etapas no lado esquerdo)
      state.searched = true;
      toggleStepsByPacks();

      computeEligible();
      goto("p2");
    });

    function validatePedido(showAlert){
      if(!state.fap || !state.dtIni || !state.dtFim || !state.packIds.length){
        if(showAlert) alert("Preencha FAP, datas e selecione pelo menos 1 Pack.");
        return false;
      }
      if(state.dtFim < state.dtIni){
        if(showAlert) alert("Data fim n√£o pode ser menor que data in√≠cio.");
        return false;
      }
      return true;
    }

    function computeEligible(){
      if(!state.packIds.length){
        currentEligible = [];
        return;
      }

      const lists = state.packIds.map(pid => new Set(cert[pid] || []));
      let inter = new Set(lists[0]);
      for(let i=1;i<lists.length;i++){
        inter = new Set([...inter].filter(x => lists[i].has(x)));
      }

      currentEligible = consultoresBase
        .filter(c => inter.has(c.codusu))
        .map((c, i) => ({...c, seed: i+1}));
    }

    // P√°gina 2
    function syncP2(){
      document.getElementById("p2Fap").textContent = state.fap || "‚Äî";
      document.getElementById("p2Ini").textContent = fmtBR(state.dtIni);
      document.getElementById("p2Fim").textContent = fmtBR(state.dtFim);
      document.getElementById("p2Packs").textContent = packsLabel(state.packIds);

      const cEl=document.getElementById("p2Cliente"); if(cEl) cEl.textContent = state.cliente || "‚Äî";
      const gEl=document.getElementById("p2GP"); if(gEl) gEl.textContent = state.gp || "‚Äî";
      const fEl=document.getElementById("p2Filial"); if(fEl) fEl.textContent = state.filial || "‚Äî";


      const box = document.getElementById("p2Steps");
      box.innerHTML = "";
      if(state.packIds.length){
        etapasPadrao.forEach((s, i) => {
          const div = document.createElement("div");
          div.className = "step";
          div.innerHTML = `<div><b>${i+1}. ${s}</b><div class="muted">Etapa padr√£o</div></div><span class="badge metodologia">Metodologia</span>${badgeReservaEtapaHTML(s)}`;
          box.appendChild(div);
        });
      }

      const mPack = document.getElementById("mPack");
      mPack.innerHTML = "";
      state.packIds.forEach(pid => {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = packs[pid]?.nome || pid;
        mPack.appendChild(opt);
      });

      const sel = document.getElementById("mEtapa");
      sel.innerHTML = `<option value="">Selecione...</option>`;
      etapasPadrao.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      });

      if(currentEligible.length === 0 && state.packIds.length){
        computeEligible();
      }
    }

    document.getElementById("btnVoltarPedido").addEventListener("click", () => goto("p1"));
    document.getElementById("btnIrResumo").addEventListener("click", () => goto("p3"));

    function getFilteredEligible(){
      const vincSel = document.getElementById("p1Vinculo")?.value || "REC";
      const sortSel = document.getElementById("p1Sort")?.value || "SMART";

      let list = currentEligible.map(c => {
        const v = (c.vinculo || vinculoFromSub(c.sub) || "").toUpperCase();
        const pct = periodAvailabilityPct(c.codusu);
        return { ...c, _v: v, _pct: pct };
      });

      if(vincSel !== "ALL"){
        if(vincSel === "REC"){
          list = list.filter(c => c._v === "CLT" || c._v === "PJ");
        }else{
          list = list.filter(c => c._v === vincSel);
        }
      }

      if(sortSel === "NAME"){
        list.sort((a,b) => (a.nome||"").localeCompare(b.nome||""));
      }else if(sortSel === "AVAIL"){
        list.sort((a,b) => (b._pct - a._pct) || (a.nome||"").localeCompare(b.nome||""));
      }else{
        list.sort((a,b) => {
          const aScore = (a._v==="CLT"? 1000:0) + Math.round(a._pct*100);
          const bScore = (b._v==="CLT"? 1000:0) + Math.round(b._pct*100);
          return (bScore - aScore) || (a.nome||"").localeCompare(b.nome||"");
        });
      }

      return list;
    }

    function renderAgenda(){
      if(!validatePedido(false)){
        document.getElementById("pillCount").textContent = `0 consultores`;
        document.getElementById("theadRow").innerHTML = `<th>NOME</th>`;
        document.getElementById("tbody").innerHTML = "";
        return;
      }

      currentDays = buildDaysRange(state.dtIni, state.dtFim);

      const head = document.getElementById("theadRow");
      head.innerHTML = `<th>NOME</th>`;
      currentDays.forEach(d => {
        const iso = toISODate(d);
        head.innerHTML += `<th>${iso.slice(8,10)}/${iso.slice(5,7)}</th>`;
      });

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      const list = getFilteredEligible();
      document.getElementById("pillCount").textContent = `${list.length} consultores`;

      list.forEach(c => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.innerHTML = `
          <div class="name">${c.nome}</div>
          <div class="sub">${c.sub}</div>
          <div class="sub">N√≠vel: <b style="color:#e5e7eb">${c.nivel}</b></div>
          <div class="sub">V√≠nculo: <b style="color:#e5e7eb">${c.vinculo}</b></div>
        `;
        tr.appendChild(tdName);

        currentDays.forEach((d, dayIndex) => {
          const iso = toISODate(d);
          const m = getSlotStatusLR(c.codusu, iso, "M", baseStatusLR(c.seed, dayIndex, "M"));
          const t = getSlotStatusLR(c.codusu, iso, "T", baseStatusLR(c.seed, dayIndex, "T"));

          const td = document.createElement("td");
          td.innerHTML = `
            <div class="slot">
              <div class="chip ${m}" data-codusu="${c.codusu}" data-nome="${c.nome}" data-iso="${iso}" data-turno="M" data-idx="${dayIndex*2}">
                <span>Manh√£</span><small>${m}</small>
              </div>
              <div class="chip ${t}" data-codusu="${c.codusu}" data-nome="${c.nome}" data-iso="${iso}" data-turno="T" data-idx="${dayIndex*2+1}">
                <span>Tarde</span><small>${t}</small>
              </div>
            </div>
          `;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", (ev) => {
          const status = [...chip.classList].find(x => ["L","R"].includes(x));
          if(status !== "L"){
            alert("Este slot j√° est√° reservado (R).");
            return;
          }

          const codusu = chip.dataset.codusu;
          const nome = chip.dataset.nome;
          const iso = chip.dataset.iso;
          const turno = chip.dataset.turno;
          const idx = Number(chip.dataset.idx);

          // Regra: sele√ß√£o m√∫ltipla apenas no MESMO consultor
          if(selectedCodusu && selectedCodusu !== codusu){
            alert("Sele√ß√£o m√∫ltipla permitida apenas para o mesmo consultor. Limpe a sele√ß√£o para escolher outro.");
            return;
          }

          const isShift = !!ev.shiftKey;
          const isCtrl = !!(ev.ctrlKey || ev.metaKey);

          // SHIFT: selecionar intervalo (precisa de √¢ncora)
          if(isShift && lastSelectedIdx !== null){
            selectedCodusu = selectedCodusu || codusu;
            const a = Math.min(lastSelectedIdx, idx);
            const b = Math.max(lastSelectedIdx, idx);

            const chipsSame = [...tbody.querySelectorAll(`.chip[data-codusu="${codusu}"]`)];
            chipsSame.forEach(ch => {
              const st = [...ch.classList].find(x => ["L","R"].includes(x));
              if(st !== "L") return;
              const cidx = Number(ch.dataset.idx);
              if(cidx < a || cidx > b) return;

              const ciso = ch.dataset.iso, cturno = ch.dataset.turno;
              const key = `${codusu}|${ciso}|${cturno}`;
              if(!selectedSlots.some(s => `${s.codusu}|${s.iso}|${s.turno}` === key)){
                selectedSlots.push({codusu, nome, iso: ciso, turno: cturno, idx: cidx});
              }
              ch.classList.add("sel");
            });

            updateMultiBar();
            return;
          }

          // CTRL/CMD ou clique simples: toggle unit√°rio
          selectedCodusu = selectedCodusu || codusu;
          const key = `${codusu}|${iso}|${turno}`;
          const i = selectedSlots.findIndex(s => `${s.codusu}|${s.iso}|${s.turno}` === key);
          if(i >= 0){
            selectedSlots.splice(i,1);
            chip.classList.remove("sel");
          }else{
            selectedSlots.push({codusu, nome, iso, turno, idx});
            chip.classList.add("sel");
            lastSelectedIdx = idx;
          }

          // Se zerou sele√ß√£o, limpa contexto
          if(selectedSlots.length === 0){
            selectedCodusu = null;
            lastSelectedIdx = null;
          }

          updateMultiBar();
        });
      });

      // Atualiza a UI da barra ao renderizar a agenda
      updateMultiBar();
    }

    function clearSelected(){
      selectedSlots = [];
      selectedCodusu = null;
      lastSelectedIdx = null;
      document.querySelectorAll(".chip.sel").forEach(el => el.classList.remove("sel"));
      updateMultiBar();
    }

    function updateMultiBar(){
      const bar = document.getElementById("multiBar");
      const cnt = document.getElementById("multiCount");
      if(!bar || !cnt) return;
      const n = selectedSlots.length;
      if(n >= 1){
        cnt.textContent = `${n} selecionado(s)`;
        bar.classList.add("show");
      }else{
        bar.classList.remove("show");
      }
    }

function getSlotStatusLR(codusu, iso, turno, baseLR){
      const has = reservas.some(r =>
        r.fap===state.fap &&
        r.codusu===codusu &&
        r.dataISO===iso &&
        r.turno===turno
      );
      if(has) return "R";
      return baseLR;
    }

    // Modal / Reservas
    const modalBack = document.getElementById("modalBack");
    let modalCtx = null;

    function openModal(ctx){
      modalCtx = ctx;
      document.getElementById("mConsultor").textContent = ctx.nome;
      document.getElementById("mData").textContent = ctx.slots ? `M√∫ltiplos dias (${ctx.slots.length})` : fmtBR(ctx.iso);
      document.getElementById("mTurno").textContent = ctx.slots ? "Per√≠odos selecionados" : (ctx.turno === "M" ? "Manh√£" : "Tarde");

      // Lista de per√≠odos selecionados (sele√ß√£o m√∫ltipla)
      const selLbl = document.getElementById("mSelectedLabel");
      const selBox = document.getElementById("mSelected");
      if(selLbl && selBox){
        if(ctx.slots && ctx.slots.length){
          selLbl.style.display = "";
          selBox.style.display = "";
          // Monta lista ordenada por data/turno
          const items = ctx.slots.slice().sort((a,b)=> (a.iso===b.iso ? (a.turno>b.turno?1:-1) : (a.iso>b.iso?1:-1)));
          selBox.innerHTML = items.map(s => {
            const t = (s.turno==="M") ? "Manh√£" : "Tarde";
            return `<div class="rowItem"><div><b>${fmtBR(s.iso)}</b></div><div class="muted">${t}</div></div>`;
          }).join("");
        }else{
          selLbl.style.display = "none";
          selBox.style.display = "none";
          selBox.innerHTML = "";
        }
      }
      document.getElementById("mEtapa").value = "";
      const mPack = document.getElementById("mPack");
      if(mPack && mPack.options.length) mPack.selectedIndex = 0;

      // Regra TERCEIRO: justificativa obrigat√≥ria sempre
      const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));
      const cSel = byId[ctx.codusu];
      const vSel = vinculoFromSub(cSel?.sub);
      const needJust = (vSel === "PJ" || vSel === "BP");
      const lbl = document.getElementById("lblJustPJ");
      const ta = document.getElementById("mJustPJ");
      if(lbl && ta){
        lbl.style.display = needJust ? "block" : "none";
        ta.style.display  = needJust ? "block" : "none";
        if(!needJust) ta.value = "";
      }

      // Ajustes para sele√ß√£o m√∫ltipla
      const btnHalf = document.getElementById("btnReserveHalf");
      const btnDay = document.getElementById("btnReserveDay");
      if(ctx.slots){
        if(btnHalf) btnHalf.textContent = "Reservar";
        if(btnDay) btnDay.style.display = "none";
      }else{
        if(btnHalf) btnHalf.textContent = "Reservar s√≥ este turno";
        if(btnDay) btnDay.style.display = "";
      }

      modalBack.classList.add("show");
    }
    function closeModal(){
      modalCtx = null;
      modalBack.classList.remove("show");
    }

    document.getElementById("btnCloseModal").addEventListener("click", closeModal);
    document.getElementById("btnCloseModal2").addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeModal(); });

    document.getElementById("btnReserveHalf").addEventListener("click", () => {
      if(!modalCtx) return;

      // Lote (sele√ß√£o m√∫ltipla): mesma Etapa + mesma Modalidade para todos os per√≠odos selecionados
      if(modalCtx.slots && modalCtx.slots.length){
        const etapa = (document.getElementById("mEtapa").value || "").trim();
        if(!etapa){ alert("Selecione uma etapa (obrigat√≥ria) para salvar a reserva."); return; }

        const packId = document.getElementById("mPack").value || (state.packIds[0] || "");
        const modalidadeEl = document.querySelector('input[name="modalidadeAgenda"]:checked');
        const modalidade = modalidadeEl ? modalidadeEl.value : "";
        if(!modalidade){ alert("‚ö†Ô∏è Selecione se a agenda √© Remota ou Presencial."); return; }

        const slots = modalCtx.slots.slice();
        const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));
        const c = byId[modalCtx.codusu];
        const vSel = vinculoFromSub(c?.sub);
        const needJust = (vSel === "PJ" || vSel === "BP");
        const just = (document.getElementById("mJustPJ")?.value || "").trim();
        if(needJust && !just){
          alert("Justificativa obrigat√≥ria: informe o motivo da escolha do TERCEIRO ou BP.");
          return;
        }
        let ok = 0, skipR = 0;

        slots.forEach(s => {
          const already = reservas.some(r => r.fap===state.fap && r.codusu===s.codusu && r.dataISO===s.iso && r.turno===s.turno);
          if(already){ skipR++; return; }
          // grava reserva com mesma etapa, pack e modalidade
          reservas.push({
            fap: state.fap,
            packId: packId,
            codusu: s.codusu,
            dataISO: s.iso,
            turno: s.turno,
            etapa: etapa,
            modalidade: modalidade,
            justPJ: document.getElementById("mJustPJ")?.value || ""
          });
          ok++;
        });

        closeModal();
        clearSelected();
        renderAgenda();
        try{ syncP2(); }catch(e){}
        renderStepsP1();
        renderResumo();
        alert(`Reserva conclu√≠da: ${ok} reservado(s), ${skipR} ignorado(s) (j√° reservados).`);
        return;
      }

      // Unit√°rio
      reserve(modalCtx.codusu, modalCtx.iso, [modalCtx.turno]);
      closeModal();
      renderAgenda();
      try{ syncP2(); }catch(e){}
      renderStepsP1();
    });

    document.getElementById("btnReserveDay").addEventListener("click", () => {
      if(!modalCtx) return;
      reserve(modalCtx.codusu, modalCtx.iso, ["M","T"]);
      closeModal();
      renderAgenda();
      try{ syncP2(); }catch(e){}
      renderStepsP1();
      renderStepsP1();
    });

    document.getElementById("btnCancelReserve").addEventListener("click", () => {
      if(!modalCtx) return;
      const before = reservas.length;
      reservas = reservas.filter(r => !(r.fap===state.fap && r.codusu===modalCtx.codusu && r.dataISO===modalCtx.iso));
      const after = reservas.length;
      alert(before===after ? "Nenhuma reserva encontrada para este dia." : "Reserva(s) cancelada(s).");
      scheduleSave();
      closeModal();
      renderAgenda();
      try{ syncP2(); }catch(e){}
      renderStepsP1();
    });

    
    function reserve(codusu, iso, turnos){
      const etapa = (document.getElementById("mEtapa").value || "").trim();
      if(!etapa){
        alert("Selecione uma etapa (obrigat√≥ria) para salvar a reserva.");
        return;
      }
      const packId = document.getElementById("mPack").value || (state.packIds[0] || "");

      
      // Modalidade (obrigat√≥ria): Remoto / Presencial
      const modalidadeEl = document.querySelector('input[name="modalidadeAgenda"]:checked');
      const modalidade = modalidadeEl ? modalidadeEl.value : "";
      if(!modalidade){
        alert("‚ö†Ô∏è Selecione se a agenda √© Remota ou Presencial.");
        return;
      }
const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));
      const c = byId[codusu];
      const vSel = vinculoFromSub(c?.sub);
      const needJust = (vSel === "PJ" || vSel === "BP");
      const just = (document.getElementById("mJustPJ")?.value || "").trim();

      if(needJust && !just){
        alert("Justificativa obrigat√≥ria: informe o motivo da escolha do TERCEIRO ou BP.");
        return;
      }

      // conflito: se j√° existe reserva para o consultor naquele turno (qualquer pack) bloqueia
      for(const t of turnos){
        const exists = reservas.some(r =>
          r.fap===state.fap &&
          r.codusu===codusu &&
          r.dataISO===iso &&
          r.turno===t
        );
        if(exists){
          alert("Conflito: j√° existe reserva nesse turno para este consultor.");
          return;
        }
      }

      turnos.forEach(t => reservas.push({
        fap: state.fap,
        modalidade: modalidade,
        packId,
        codusu,
        dataISO: iso,
        turno: t,
        etapa,
        justPJ: needJust ? just : ""
      }));
    }

    // Resumo
document.getElementById("btnVoltarAgenda").addEventListener("click", () => goto("p2"));
document.getElementById("btnLimpar").addEventListener("click", () => {
      if(!confirm("Deseja limpar TODAS as reservas deste FAP?")) return;
      reservas = reservas.filter(r => r.fap !== state.fap);
      scheduleSave();
      renderResumo();
      renderAgenda();
      renderStepsP1();
    });
    // ===== Barra de sele√ß√£o m√∫ltipla (Aba 2) =====
    // handlers registrados via delega√ß√£o no final do script (captura)

	const btnSendVal = document.getElementById("btnSendValidationFromResumo");
    if(btnSendVal){
      btnSendVal.addEventListener("click", () => sendToValidation());
      // Atualiza indicador no lado esquerdo (Aba 2)
      try{ renderStepsP1(); }catch(e){}

    }

    function canExportResumo(){
      const st = validationStatusByFap[state.fap] || "";
      return !!acceptedChangesByFap[state.fap] || st === "Pronto para Validar cronograma com Cliente" || st === "Cronograma atualizado e validado pelo cliente";
    }

    function exportResumoCSV(){
      if(!resumoRowsCache.length){ alert("N√£o h√° dados no resumo para exportar."); return; }
      const header = ["Etapa","Pack","Consultor","Data in√≠cio","Data fim","Per√≠odo","Remoto/Presencial"];
      const rows = resumoRowsCache.map(r => [
        r.etapa, r.pack, r.consultor, r.dtIni, r.dtFim, r.periodo, r.modalidade
      ]);
      const csv = [header, ...rows].map(line => line.map(v => `"${String(v||"").replace(/\"/g,'""')}"`).join(";")).join("\n");
      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `resumo_${state.fap || "cronograma"}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function exportResumoPDF(){
      if(!resumoRowsCache.length){ alert("N√£o h√° dados no resumo para exportar."); return; }
      const win = window.open("", "_blank");
      if(!win){ alert("Pop-up bloqueado. Permita abrir nova janela para gerar o PDF."); return; }
      const rowsHtml = resumoRowsCache.map(r => `
        <tr>
          <td>${r.etapa}</td>
          <td>${r.pack}</td>
          <td>${r.consultor}</td>
          <td>${r.dtIni}</td>
          <td>${r.dtFim}</td>
          <td>${r.periodo}</td>
          <td>${r.modalidade}</td>
        </tr>
      `).join("");
      const genAt = new Date().toLocaleString("pt-BR");
      win.document.write(`
        <html>
          <head>
            <meta charset="utf-8" />
            <title>Resumo das Agendas</title>
            <style>
              body{font-family:Arial,sans-serif; padding:20px;}
              h2{margin:0 0 12px;}
              .meta{font-size:12px; color:#374151; margin-bottom:10px;}
              table{width:100%; border-collapse:collapse; font-size:12px;}
              th,td{border:1px solid #ddd; padding:6px 8px; text-align:left;}
              th{background:#f3f4f6;}
            </style>
          </head>
          <body>
            <h2>Resumo das Agendas - FAP ${state.fap || "‚Äî"}</h2>
            <div class="meta"><b>Projeto:</b> ${state.cliente || "‚Äî"} &nbsp;‚Ä¢&nbsp; <b>Gerente de Projeto:</b> ${state.gp || "‚Äî"} &nbsp;‚Ä¢&nbsp; <b>Gerado em:</b> ${genAt}</div>
            <table>
              <thead>
                <tr>
                  <th>Etapa</th>
                  <th>Pack</th>
                  <th>Consultor</th>
                  <th>Data in√≠cio</th>
                  <th>Data fim</th>
                  <th>Per√≠odo</th>
                  <th>Remoto/Presencial</th>
                </tr>
              </thead>
              <tbody>${rowsHtml}</tbody>
            </table>
          </body>
        </html>
      `);
      win.document.close();
      win.focus();
      win.print();
    }

    function renderResumo(){
      document.getElementById("kpi3Fap").textContent = state.fap || "‚Äî";
      document.getElementById("kpi3Packs").textContent = packsLabel(state.packIds);
      const cEl=document.getElementById("kpi3Cliente"); if(cEl) cEl.textContent = state.cliente || "‚Äî";
      const gEl=document.getElementById("kpi3GP"); if(gEl) gEl.textContent = state.gp || "‚Äî";
      const fEl=document.getElementById("kpi3Filial"); if(fEl) fEl.textContent = state.filial || "‚Äî";
      const elL = document.getElementById("kpi3Lider"); if(elL) elL.textContent = state.lider || "‚Äî";
      const elPMO = document.getElementById("kpi3GestorPMO"); if(elPMO) elPMO.textContent = state.gestorPMO || "‚Äî";

      const list = reservas
        .filter(r => r.fap===state.fap)
        .sort((a,b) => (a.dataISO+a.turno).localeCompare(b.dataISO+b.turno));

      document.getElementById("kpi3Res").textContent = String(list.length);

      const tbody = document.getElementById("resumoBody");
      const empty = document.getElementById("resumoEmpty");
      const exportsBox = document.getElementById("resumoExports");
      if(tbody) tbody.innerHTML = "";
      if(empty) empty.style.display = "none";
      if(exportsBox) exportsBox.style.display = canExportResumo() ? "block" : "none";

      if(!tbody){
        // fallback (se algu√©m remover a tabela no HTML)
        const resList = document.getElementById("resList");
        if(resList){
          resList.innerHTML = list.length ? "" : `<div class="muted">Nenhuma reserva registrada ainda.</div>`;
        }
        return;
      }

      if(list.length === 0){
        if(empty) empty.style.display = "block";
        return;
      }

      const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));

      // --- Agrupar por Etapa + Pack + Consultor + Modalidade e consolidar datas consecutivas ---
      const groups = new Map(); // key -> array reservas
      const keyOf = (r) => `${r.etapa||"‚Äî"}|${r.packId||"‚Äî"}|${r.codusu||"‚Äî"}|${(r.modalidade||"‚Äî")}`;
      list.forEach(r => {
        const k = keyOf(r);
        if(!groups.has(k)) groups.set(k, []);
        groups.get(k).push(r);
      });
      const pad = n => String(n).padStart(2,"0");
      function add1DayISO(iso){
        const [y,m,d]=iso.split("-").map(Number);
        const dt = new Date(y, m-1, d);
        dt.setDate(dt.getDate()+1);
        return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
      }

      function periodoFromTurns(turnsSet){
        const hasM = turnsSet.has("M");
        const hasT = turnsSet.has("T");
        if(hasM && hasT) return "Dia todo";
        if(hasM) return "Manh√£";
        if(hasT) return "Tarde";
        return "‚Äî";
      }

      // Linhas finais
      const rows = [];

      for(const [k, arr] of groups.entries()){
        const [etapa, packId, codusu, modalidade] = k.split("|");
        // map dia -> set(turnos)
        const byDay = new Map();
        arr.forEach(r => {
          const day = r.dataISO;
          if(!byDay.has(day)) byDay.set(day, new Set());
          byDay.get(day).add(r.turno);
        });

        const days = Array.from(byDay.keys()).sort();
        let runStart = null;
        let runEnd = null;
        let runPeriodo = null;

        for(let i=0;i<days.length;i++){
          const day = days[i];
          const periodo = periodoFromTurns(byDay.get(day));

          if(runStart === null){
            runStart = day; runEnd = day; runPeriodo = periodo;
            continue;
          }

          const expectedNext = add1DayISO(runEnd);
          const canExtend = (day === expectedNext) && (periodo === runPeriodo);

          if(canExtend){
            runEnd = day;
          }else{
            rows.push({etapa, packId, codusu, modalidade, dtIni: runStart, dtFim: runEnd, periodo: runPeriodo});
            runStart = day; runEnd = day; runPeriodo = periodo;
          }
        }

        if(runStart !== null){
          rows.push({etapa, packId, codusu, modalidade, dtIni: runStart, dtFim: runEnd, periodo: runPeriodo});
        }
      }

      // Ordenar por data in√≠cio / consultor / pack
      rows.sort((a,b) => (a.dtIni + a.codusu + a.packId).localeCompare(b.dtIni + b.codusu + b.packId));

      const exportRows = [];

      rows.forEach(r => {
        const c = byId[r.codusu];
        const nome = c?.nome || r.codusu;
        const nivel = c?.nivel ? ` ‚Ä¢ ${c.nivel}` : "";
        const vincRaw = c ? vinculoFromSub(c.sub) : "";
        const vinc = vincRaw ? ` ‚Ä¢ ${vincRaw === "PJ" ? "TERCEIRO" : vincRaw}` : "";
        const packNome = packs[r.packId]?.nome || r.packId || "‚Äî";
        const mod = (r.modalidade && r.modalidade !== "‚Äî") ? r.modalidade : "‚Äî";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="text-align:left">${r.etapa || "‚Äî"}</td>
          <td style="text-align:left">${packNome}</td>
          <td style="text-align:left"><b>${nome}</b><span class="muted">${nivel}${vinc}</span></td>
          <td>${fmtBR(r.dtIni)}</td>
          <td>${fmtBR(r.dtFim)}</td>
          <td>${r.periodo || "‚Äî"}</td>
          <td>${mod}</td>
        `;
        tbody.appendChild(tr);

        exportRows.push({
          etapa: r.etapa || "‚Äî",
          pack: packNome,
          consultor: `${nome}${nivel}${vinc}`,
          dtIni: fmtBR(r.dtIni),
          dtFim: fmtBR(r.dtFim),
          periodo: r.periodo || "‚Äî",
          modalidade: mod
        });
      });
      resumoRowsCache = exportRows;
    }



    // ===== Valida√ß√£o / Ajustes do L√≠der =====
    
    function sendToValidation(){
      if(!state.fap){
        const fapFromInput = (document.getElementById("fap")?.value || "").trim();
        const fapFromP2 = (document.getElementById("p2Fap")?.textContent || "").trim();
        state.fap = fapFromInput || (fapFromP2 !== "‚Äî" ? fapFromP2 : "");
      }
      if(!state.fap){
        alert("Informe a FAP antes de enviar para valida√ß√£o.");
        return;
      }
      sentToValidation[state.fap] = true;
      validationStatusByFap[state.fap] = "Em valida√ß√£o L√≠der da Torre";
      scheduleSave();
      alert("Cronograma enviado para valida√ß√£o do L√≠der da Torre.");
      goto("p4");
    }

    function guardP4(){
      const guard = document.getElementById("p4Guard");
      const content = document.getElementById("p4Content");
      if(!guard || !content) return;
      const ok = !!sentToValidation[state.fap];
      guard.style.display = ok ? "none" : "block";
      content.style.display = ok ? "block" : "none";
    }


    
function guardP5(){
  const guard = document.getElementById("p5Guard");
  const content = document.getElementById("p5Content");
  if(!guard || !content) return;
  const ok = !!sentToValidation[state.fap];
  guard.style.display = ok ? "none" : "block";
  content.style.display = ok ? "block" : "none";
}
    function renderLeaderResList(){
      const box = document.getElementById("leaderResList");
      if(!box) return;

      const list = reservas
        .filter(r => r.fap===state.fap)
        .sort((a,b) => (a.dataISO+a.turno).localeCompare(b.dataISO+b.turno));

      if(list.length === 0){
        box.innerHTML = `<div class="muted">Nenhuma reserva para ajustar.</div>`;
        return;
      }

      const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));
      const cltAvail = hasCltAvailabilityInPeriod();
      box.innerHTML = "";

      list.forEach((r, idx) => {
        const c = byId[r.codusu];
        const nome = c?.nome || r.codusu;
        const turno = r.turno === "M" ? "Manh√£" : "Tarde";
        const packNome = packs[r.packId]?.nome || r.packId || "‚Äî";
        const vincRaw = vinculoFromSub(c?.sub);
        const vincLabel = vincRaw === "PJ" ? "TERCEIRO" : vincRaw;
        const warnClt = (vincRaw === "PJ" && cltAvail)
          ? `<div style="margin-top:4px; color:#fde68a"><b>Alerta:</b> h√° CLT dispon√≠vel no per√≠odo.</div>`
          : "";

        const wrap = document.createElement("div");
        wrap.className = "item";

        wrap.innerHTML = `
          <div>
            <b>${nome} ‚Ä¢ ${vincLabel}</b>
            <div>${fmtBR(r.dataISO)} ‚Ä¢ ${turno} ‚Ä¢ Pack: ${packNome}${r.modalidade ? " ‚Ä¢ " + r.modalidade : ""}</div>
            ${warnClt}
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
            <button class="ghost" onclick="leaderCancel(${idx})" style="width:auto; padding:8px 10px">Cancelar</button>
            <button class="secondary" onclick="leaderSwap(${idx})" style="width:auto; padding:8px 10px">Trocar</button>
          </div>
        `;
        box.appendChild(wrap);
      });
    
    }

// ===== A√ß√µes globais (fallback) para Etapa 4: Cancelar/Trocar =====
    // Uso: onclick direto nos bot√µes para evitar problemas de binding em re-render.
    window.leaderCancel = function(i){
      try{
        const list2 = reservas
          .filter(r => r.fap===state.fap)
          .sort((a,b) => (a.dataISO+a.turno).localeCompare(b.dataISO+b.turno));
        const r = list2[i];
        if(!r){ alert("Reserva n√£o encontrada."); return; }

        reservas = reservas.filter(x => !(x.fap===r.fap && x.codusu===r.codusu && x.dataISO===r.dataISO && x.turno===r.turno));
        logLeaderChange("Cancelamento", `Cancelou ${r.codusu} em ${fmtBR(r.dataISO)} (${r.turno}) Pack ${r.packId}`);
        scheduleSave();
        alert("Reserva cancelada (log registrado).");
        renderLeaderResList();
        renderAgenda();
      renderStepsP1();
      }catch(e){
        console.error(e);
        alert("Falha ao cancelar. Verifique o console.");
      }
    };

    window.leaderSwap = function(i){
      try{
        const list2 = reservas
          .filter(r => r.fap===state.fap)
          .sort((a,b) => (a.dataISO+a.turno).localeCompare(b.dataISO+b.turno));
        const r = list2[i];
        if(!r){ alert("Reserva n√£o encontrada."); return; }
        if(typeof openSwapModal !== "function"){
          alert("Fun√ß√£o de troca n√£o encontrada (openSwapModal).");
          return;
        }
        openSwapModal(r);
      }catch(e){
        console.error(e);
        alert("Falha ao abrir a troca. Verifique o console.");
      }
    };




// Etapa 5: Aceite/N√£o Aceite do Gerente de Projeto
const btnGpAccept = document.getElementById("btnGpAccept");
if(btnGpAccept){
  btnGpAccept.addEventListener("click", () => {
    if(!state.fap){ alert("Informe a FAP."); return; }
    const stNow = validationStatusByFap[state.fap] || "Pendente";
    if(stNow !== "Aguardando Aceite do Gerente de Projeto"){
      alert("Este cronograma n√£o est√° aguardando aceite do Gerente de Projeto.");
      return;
    }
    acceptedChangesByFap[state.fap] = true;
    validationStatusByFap[state.fap] = "Pronto para Validar cronograma com Cliente";
    scheduleSave();
    alert("Aceite registrado. Cronograma conclu√≠do.");
    renderResumo();
    renderValidated();
  });
}

const btnGpReject = document.getElementById("btnGpReject");
if(btnGpReject){
  btnGpReject.addEventListener("click", () => {
    if(!state.fap){ alert("Informe a FAP."); return; }

function handleClientValidated(){
  if(!state.fap){ alert("Informe a FAP."); return; }
  const stNow = validationStatusByFap[state.fap] || "Pendente";
  if(stNow !== "Pronto para Validar cronograma com Cliente"){
    alert("Este cronograma ainda n√£o est√° pronto para valida√ß√£o com o cliente.");
    return;
  }
  validationStatusByFap[state.fap] = "Cronograma atualizado e validado pelo cliente";
  scheduleSave();

  const finalMsg = document.getElementById("p5FinalMsg");
  const clientArea = document.getElementById("p5ClientArea");
  const clientFinalMsg = document.getElementById("p5ClientFinalMsg");
  if(finalMsg) finalMsg.style.display = "none";
  if(clientArea) clientArea.style.display = "none";
  if(clientFinalMsg) clientFinalMsg.style.display = "block";
  renderValidated();
}

const btnClientValidated = document.getElementById("btnClientValidated");
if(btnClientValidated){
  btnClientValidated.addEventListener("click", handleClientValidated);
}
const btnReprogramStart = document.getElementById("btnReprogramStart");
if(btnReprogramStart){
  btnReprogramStart.addEventListener("click", () => {
    if(!state.fap){ alert("Informe a FAP."); return; }
    openReprogramModal(state.fap, () => {
      goto("p1");
      document.getElementById("fap")?.focus();
    });
  });
}
    const stNow = validationStatusByFap[state.fap] || "Pendente";
    if(stNow !== "Aguardando Aceite do Gerente de Projeto"){
      alert("Este cronograma n√£o est√° aguardando aceite do Gerente de Projeto.");
      return;
    }
    // Solicita ajustes ao L√≠der da Torre
    acceptedChangesByFap[state.fap] = false;
    validationStatusByFap[state.fap] = "Em ajustes pelo L√≠der da Torre";
    scheduleSave();
    alert("Solicita√ß√£o de ajustes enviada ao L√≠der da Torre. Retornando para a Etapa 4.");
    goto("p4");
  });
}
function renderValidated(){
      document.getElementById("kpi5Fap").textContent = state.fap || "‚Äî";
      document.getElementById("kpi5Packs").textContent = packsLabel(state.packIds);
      const cEl=document.getElementById("kpi5Cliente"); if(cEl) cEl.textContent = state.cliente || "‚Äî";
      const gEl=document.getElementById("kpi5GP"); if(gEl) gEl.textContent = state.gp || "‚Äî";
      const fEl=document.getElementById("kpi5Filial"); if(fEl) fEl.textContent = state.filial || "‚Äî";
      const st = validationStatusByFap[state.fap] || "Pendente";
      document.getElementById("kpi5Status").textContent = st;
      const p5Comment = document.getElementById("p5ValidationComment");
      if(p5Comment) p5Comment.value = state.validationComment || "";
      const reprogramArea = document.getElementById("p5ReprogramArea");
      if(reprogramArea) reprogramArea.style.display = (st === "Cronograma atualizado e validado pelo cliente") ? "block" : "none";
      updateClientValidationUI(st);

      const box = document.getElementById("leaderChangesList");
      const acceptArea = document.getElementById("p5AcceptArea");
      const finalMsg = document.getElementById("p5FinalMsg");
      if(!box) return;

      const logs = leaderChanges
        .filter(x => x.fap === state.fap)
        .sort((a,b) => a.whenISO.localeCompare(b.whenISO));

      box.innerHTML = "";

      const hasChanges = logs.length > 0;
      const accepted = !!acceptedChangesByFap[state.fap];

      // Caso 1: Sem altera√ß√µes -> depende do STATUS (n√£o pode concluir antes da Etapa 4)
if(!hasChanges){
  const stNow = validationStatusByFap[state.fap] || "Pendente";
  const isWaitingGp = stNow === "Aguardando Aceite do Gerente de Projeto";
  const isDone = stNow.toLowerCase().startsWith("conclu√≠do") || stNow.toLowerCase().startsWith("concluido") || stNow === "Pronto para Validar cronograma com Cliente" || stNow === "Cronograma atualizado e validado pelo cliente";

  // Em valida√ß√£o do L√≠der (Etapa 4 ainda n√£o conclu√≠da): n√£o exibe mensagem de conclu√≠do
  if(stNow === "Em valida√ß√£o L√≠der da Torre"){
    if(acceptArea) acceptArea.style.display = "none";
    if(finalMsg) finalMsg.style.display = "none";

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <b>Em valida√ß√£o do L√≠der da Torre</b>
        <div>O cronograma est√° em an√°lise. Nenhuma decis√£o final foi registrada ainda.</div>
      </div>
      <span class="tag">EM VALIDA√á√ÉO</span>
    `;
    box.appendChild(div);
    return;
  }

  // Valida√ß√£o do L√≠der conclu√≠da: pode ir para aceite do GP (mesmo sem altera√ß√µes)
  if(isWaitingGp){
    if(acceptArea) acceptArea.style.display = "block";
    if(finalMsg) finalMsg.style.display = "none";

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <b>Valida√ß√£o do L√≠der da Torre conclu√≠da</b>
        <div>Nenhuma altera√ß√£o foi necess√°ria. Aguardando aceite do Gerente de Projeto.</div>
      </div>
      <span class="tag">AGUARDANDO GP</span>
    `;
    box.appendChild(div);
    return;
  }

  // Conclu√≠do: exibe mensagem final
  if(isDone){
  if(acceptArea) acceptArea.style.display = "none";
  if(finalMsg) finalMsg.style.display = "block";
  updateClientValidationUI(stNow);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <b>Cronograma aprovado</b>
        <div>Nenhuma altera√ß√£o foi necess√°ria.</div>
      </div>
      <span class="tag">CONCLU√çDO</span>
    `;
    box.appendChild(div);
    return;
  }

  // Outros estados: padr√£o (n√£o mostra final nem aceite)
  if(acceptArea) acceptArea.style.display = "none";
  if(finalMsg) finalMsg.style.display = "none";
  updateClientValidationUI(stNow);
  const div = document.createElement("div");
  div.className = "item";
  div.innerHTML = `
    <div>
      <b>Status: ${stNow}</b>
      <div>Acompanhe o fluxo para avan√ßar.</div>
    </div>
    <span class="tag">STATUS</span>
  `;
  box.appendChild(div);
  return;
}

function updateClientValidationUI(stNow){
  const clientArea = document.getElementById("p5ClientArea");
  const btn = document.getElementById("btnClientValidated");
  const note = document.getElementById("p5ClientNote");
  if(clientArea) clientArea.style.display = "block";
  const ready = stNow === "Pronto para Validar cronograma com Cliente";
  if(btn){
    btn.disabled = false;
    btn.classList.toggle("isDisabled", !ready);
  }
  if(note){
    note.textContent = ready
      ? "Ao confirmar, registraremos que todas as agendas foram confirmadas e que o cronograma foi enviado para o Sankhya Experience para valida√ß√£o final."
      : "Dispon√≠vel ap√≥s o aceite do Gerente de Projeto.";
  }
}


      // Caso 2: Com altera√ß√µes -> listar altera√ß√µes
      logs.forEach(l => {
        const d = new Date(l.whenISO);
        const when = d.toLocaleString("pt-BR");
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <b>${l.action}</b>
            <div>${when} ‚Ä¢ ${l.detail}</div>
          </div>
          <span class="tag">ALTERA√á√ÉO</span>
        `;
        box.appendChild(div);
      });

        // Regra de exibi√ß√£o na Etapa 5 baseada em STATUS
  const stNow = validationStatusByFap[state.fap] || "Pendente";
  const isWaitingGp = stNow === "Aguardando Aceite do Gerente de Projeto";
  const isDone = stNow.toLowerCase().startsWith("conclu√≠do") || stNow.toLowerCase().startsWith("concluido") || stNow === "Pronto para Validar cronograma com Cliente" || stNow === "Cronograma atualizado e validado pelo cliente";

  if(isWaitingGp){
    if(acceptArea) acceptArea.style.display = "block";
    if(finalMsg) finalMsg.style.display = "none";
    updateClientValidationUI(stNow);
  }else if(isDone){
        if(acceptArea) acceptArea.style.display = "none";
        if(finalMsg) finalMsg.style.display = "block";
        updateClientValidationUI(stNow);
      }else{
    // Demais estados: n√£o pede aceite do GP ainda
    if(acceptArea) acceptArea.style.display = "none";
    if(finalMsg) finalMsg.style.display = "none";
    updateClientValidationUI(stNow);
  }
}

    // Etapa 4/5 bot√µes
// Etapa 4: ao concluir (enviar para GP), muda status para "Aguardando Aceite do Gerente de Projeto"
const btnEnviar = document.getElementById("btnEnviarValidacao");
if(btnEnviar){
  btnEnviar.addEventListener("click", () => {
    if(!state.fap){
      alert("Informe a FAP antes de enviar.");
      return;
    }
    if(!sentToValidation[state.fap]){
      alert("Envie primeiro para valida√ß√£o do L√≠der da Torre (Etapa 3).");
      return;
    }
    validationStatusByFap[state.fap] = "Aguardando Aceite do Gerente de Projeto";
    scheduleSave();
    alert("Valida√ß√£o do L√≠der conclu√≠da. Aguardando aceite do Gerente de Projeto.");
    goto("p5");
  });
}

    const btnVoltarP4 = document.getElementById("btnVoltarP4");
    if(btnVoltarP4){
      btnVoltarP4.addEventListener("click", () => goto("p4"));
    }

    const btnAprovarFinal = document.getElementById("btnAprovarFinal");
    if(btnAprovarFinal){
      btnAprovarFinal.addEventListener("click", () => {
        validationStatusByFap[state.fap] = "Validado";
        scheduleSave();
        alert("Cronograma marcado como VALIDADO (MVP).");
        renderValidated();
      });
    }



    function renderP4ThirdPartyAlerts(){
      const box = document.getElementById("p4ThirdPartyAlerts");
      if(!box) return;

      // Contexto do pedido (FAP/Cliente/GP/Filial)
      const elFap = document.getElementById("p4Fap"); if(elFap) elFap.textContent = state.fap || "‚Äî";
      const elCli = document.getElementById("p4Cliente"); if(elCli) elCli.textContent = state.cliente || "‚Äî";
      const elGP  = document.getElementById("p4GP"); if(elGP) elGP.textContent = state.gp || "‚Äî";
      const elFil = document.getElementById("p4Filial"); if(elFil) elFil.textContent = state.filial || "‚Äî";
      const elL = document.getElementById("p4Lider"); if(elL) elL.textContent = state.lider || "‚Äî";
      const elPMO = document.getElementById("p4GestorPMO"); if(elPMO) elPMO.textContent = state.gestorPMO || "‚Äî";
      const valComment = document.getElementById("p4ValidationComment");
      if(valComment) valComment.value = state.validationComment || "";
      const obsWrap = document.getElementById("p4ObsWrap");
      const obsText = document.getElementById("p4ObsText");
      if(obsWrap && obsText){
        const t = (state.obs || "").trim();
        if(t){
          obsText.textContent = t;
          obsWrap.style.display = "block";
        }else{
          obsWrap.style.display = "none";
        }
      }




      const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));
      const logs = reservas
        .filter(r => r.fap === state.fap && (r.justPJ || "").trim().length > 0)
        .map(r => {
          const c = byId[r.codusu];
          return {
            codusu: r.codusu,
            nome: c?.nome || r.codusu,
            sub: c?.sub || "",
            dataISO: r.dataISO,
            turno: r.turno,
            packId: r.packId,
            etapa: r.etapa,
            modalidade: r.modalidade || "",
            just: r.justPJ
          };
        });

      // Somente quando for TERCEIRO ou BP
      const thirds = logs.filter(x => {
        const v = vinculoFromSub(x.sub);
        return v === "PJ" || v === "BP";
      });

      if(thirds.length === 0){
        box.innerHTML = `<div class="muted">Nenhum alerta de TERCEIRO/BP nesta FAP.</div>`;
        return;
      }

      // Compactar por consultor + justificativa (para n√£o repetir demais)
      const key = (x) => `${x.codusu}||${x.just}`;
      const seen = new Set();
      const unique = [];
      for(const x of thirds){
        const k = key(x);
        if(seen.has(k)) continue;
        seen.add(k);
        unique.push(x);
      }

      box.innerHTML = "";
      unique.forEach(x => {
        const div = document.createElement("div");
        div.className = "item";
        const turno = x.turno === "M" ? "Manh√£" : "Tarde";
        const packNome = packs[x.packId]?.nome || x.packId;
        const v = vinculoFromSub(x.sub);
        const vLabel = v === "PJ" ? "TERCEIRO" : "BP";
        div.innerHTML = `
          <div>
            <b>${x.nome} ‚Ä¢ ${vLabel}</b>
            <div>${fmtBR(x.dataISO)} ‚Ä¢ ${turno} ‚Ä¢ Pack: ${packNome}${x.modalidade ? " ‚Ä¢ "+x.modalidade : ""}</div>
            <div style="margin-top:4px; color:#fde68a"><b>Justificativa:</b> ${x.just}</div>
          </div>
          <span class="tag">ALERTA</span>
        `;
        box.appendChild(div);
      });
    }



    const btnAccept = document.getElementById("btnAcceptChanges");
    if(btnAccept){
      btnAccept.addEventListener("click", () => {
        if(!state.fap) return;
        acceptedChangesByFap[state.fap] = true;
        validationStatusByFap[state.fap] = "Conclu√≠do - Aloca√ß√£o de recurso";
        alert("Altera√ß√µes aceitas. Seu cronograma foi validado Pelo L√≠der da torre e esta pronto para ser validado cliente.");
        renderValidated();
      });
    }


    // Init
    function initDefaults(){
      const today = new Date();
      const in7 = addDays(today, 7);
      const dtIniEl = document.getElementById("dtIni");
      const dtFimEl = document.getElementById("dtFim");
      const todayISO = toISODate(today);
      if(dtIniEl){
        dtIniEl.min = todayISO;
        dtIniEl.value = state.dtIni || todayISO;
        state.dtIni = dtIniEl.value;
        dtIniEl.addEventListener("change", () => {
          if(dtIniEl.value !== todayISO){
            dtIniEl.value = todayISO;
            state.dtIni = todayISO;
            alert("Data inicio e sempre a data de hoje (MVP).");
            togglePacksVisibility();
            refreshPreview();
            scheduleSave();
          }
        });
      }
      if(dtFimEl){
        dtFimEl.min = todayISO;
        dtFimEl.value = state.dtFim || toISODate(in7);
        state.dtFim = dtFimEl.value;
      }

      if(!state.packIds || state.packIds.length === 0){
        const firstCb = document.querySelector('input[name="packs"]');
        if(firstCb) firstCb.checked = true;
        state.packIds = firstCb ? [firstCb.value] : [];
      }

      renderStepsP1();
      togglePacksVisibility();
      toggleStepsByPacks();
      updateActionButtons();
      refreshPreview();
    }

    async function initApp(){
      const stored = await loadData();
      if(stored) applyData(stored);
      initDefaults();
      applyStateToUI();
      if(state.packIds && state.packIds.length){
        computeEligible();
      }
      renderAgenda();
      renderResumo();
      if(sentToValidation[state.fap]){ renderValidated(); }
      if(!stored) scheduleSave();
    }
    initApp();
  
    /* ===== Etapa 4 ‚Äì Troca de consultor com verifica√ß√£o de recursos (modal) ===== */
let swapCtx = { open:false, reserva:null, selected:null, needJust:false, dateISO:null, turno:null };
let reprogramCtx = { open:false, fap:null, onConfirm:null, prevFap:"", confirmed:false };

    function openSwapModal(reserva){
      // Garante que a lista de eleg√≠veis esteja atualizada (Etapa 4 pode ser acessada sem ter passado pela Etapa 2)
      try{ if(typeof syncP2 === 'function'){ syncP2(); } }catch(e){}

      swapCtx.open = true;
      swapCtx.reserva = reserva;
      swapCtx.selected = null;
      swapCtx.dateISO = reserva.dataISO;
      swapCtx.turno = reserva.turno;
      // Contexto
      const packNome = (packs[reserva.packId]?.nome || reserva.packId);
      const turno = reserva.turno === "M" ? "Manh√£" : (reserva.turno === "T" ? "Tarde" : reserva.turno);
      $("#swapContext").innerHTML = `<b>FAP ${reserva.fap}</b> ‚Ä¢ Atual: ${fmtBR(reserva.dataISO)} ‚Ä¢ ${turno} ‚Ä¢ Pack: <b>${packNome}</b>`;

      // Badges
      $("#swapBadgeSlot").textContent = `Slot atual: ${fmtBR(reserva.dataISO)} ‚Ä¢ ${turno}`;
      const cltAvail = hasCltAvailabilityInPeriod();
      $("#swapBadgeRule").textContent = `Regra PJ/CLT: ${cltAvail ? "h√° CLT dispon√≠vel no per√≠odo" : "sem CLT dispon√≠vel no per√≠odo"}`;

      // Preenche box atual
      const atual = consultoresBase.find(c => c.codusu===reserva.codusu);
      $("#swapCurrentBox").innerHTML = renderPersonMini(atual, reserva, true, swapCtx.dateISO, swapCtx.turno, reserva);

      // Reset UI
      swapCtx.selected = atual || null;
      $("#swapSelectedBox").innerHTML = swapCtx.selected
        ? renderPersonMini(swapCtx.selected, reserva, false, swapCtx.dateISO, swapCtx.turno, reserva)
        : "Selecione um consultor na lista";
      updateCompareHighlight(atual, swapCtx.selected);
      $("#swapJustText").value = "";
      $("#swapJustBox").style.display = "none";
      const btnSwap = $("#btnSwapConfirm");
      if(swapCtx.selected){
        btnSwap?.classList?.remove("isDisabled");
        if(btnSwap) delete btnSwap.dataset.disabled;
      }else{
        btnSwap?.classList?.add("isDisabled");
        if(btnSwap) btnSwap.dataset.disabled = "1";
      }
      swapCtx.needJust = false;

      // Inputs data/turno
      if($("#swapDate")) $("#swapDate").value = reserva.dataISO;
      if($("#swapTurno")) $("#swapTurno").value = reserva.turno;

      // Defaults
      $("#swapOnlyFree").checked = true;
      $("#swapVinculo").value = "REC";
      $("#swapSort").value = "SMART";
      $("#swapSearch").value = "";

      updateSwapSlotUI();

      // Render candidates
      renderSwapCandidates();

      // Open
      $("#swapBackdrop").style.display = "flex";
      $("#swapBackdrop").setAttribute("aria-hidden","false");
    }

    function closeSwapModal(){
      swapCtx.open = false;
      swapCtx.reserva = null;
      swapCtx.selected = null;
      $("#swapBackdrop").style.display = "none";
      $("#swapBackdrop").setAttribute("aria-hidden","true");
    }

    function openReprogramModal(fap, onConfirm, prevFap=""){
      reprogramCtx.open = true;
      reprogramCtx.fap = fap;
      reprogramCtx.onConfirm = onConfirm || null;
      reprogramCtx.prevFap = prevFap || "";
      reprogramCtx.confirmed = false;
      const ctx = document.getElementById("reprogramContext");
      if(ctx) ctx.textContent = `FAP ${fap}`;
      const reason = document.getElementById("reprogramReason");
      const detail = document.getElementById("reprogramDetail");
      const badge = document.getElementById("reprogramBadge");
      if(reason) reason.value = "";
      if(detail) detail.value = "";
      if(badge) badge.textContent = "Motivo obrigat√≥rio";
      const wrap = document.getElementById("reprogramDetailWrap");
      if(wrap) wrap.style.display = "none";
      const back = document.getElementById("reprogramBackdrop");
      if(back){
        back.style.display = "flex";
        back.setAttribute("aria-hidden","false");
      }
    }

    function closeReprogramModal(){
      const prev = reprogramCtx.prevFap || "";
      const wasConfirmed = !!reprogramCtx.confirmed;
      reprogramCtx.open = false;
      reprogramCtx.fap = null;
      reprogramCtx.onConfirm = null;
      reprogramCtx.prevFap = "";
      reprogramCtx.confirmed = false;
      const back = document.getElementById("reprogramBackdrop");
      if(back){
        back.style.display = "none";
        back.setAttribute("aria-hidden","true");
      }
      if(!wasConfirmed){
        const fapEl = document.getElementById("fap");
        if(fapEl) fapEl.value = prev;
      }
    }

    function renderPersonMini(c, reserva, isCurrent=false, slotDateISO=null, slotTurno=null, ignoreReserva=null){
      if(!c) return `<div class="muted">‚Äî</div>`;
      const vinc = (c.vinculo || vinculoFromSub(c.sub) || "").toUpperCase();
      const checkDate = slotDateISO || reserva.dataISO;
      const checkTurno = slotTurno || reserva.turno;
      const slotFree = isSlotFreeConsideringSwap(c.codusu, checkDate, checkTurno, ignoreReserva);
      const badge = slotFree ? `<span class="badge ok">Livre no slot</span>` : `<span class="badge off">Ocupado no slot</span>`;
      const periodPct = Math.round(periodAvailabilityPct(c.codusu) * 100);
      const typeChip = vinc === "CLT"
        ? `<span class="chip good">CLT</span>`
        : (vinc === "BP" ? `<span class="chip warn">BP</span>` : `<span class="chip warn">TERCEIRO</span>`);
      return `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
          <div>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
              <b>${c.nome}</b>
              <span class="chip">${c.codusu}</span>
              ${typeChip}
            </div>
            <div class="muted" style="margin-top:4px">${(c.sub||"").trim() || "‚Äî"}</div>
            <div class="meta" style="margin-top:8px">${badge} <span class="badge">${periodPct}% livre no per√≠odo</span></div>
          </div>
          ${isCurrent ? `<span class="badge">Atual</span>` : ``}
        </div>
      `;
    }

    function isSlotFree(codusu, dataISO, turno){
      // Considera conflito em qualquer FAP (simula√ß√£o de agenda corporativa)
      return !reservas.some(x => x.codusu===codusu && x.dataISO===dataISO && x.turno===turno);
    }

    function isSlotFreeConsideringSwap(codusu, dataISO, turno, ignoreReserva){
      const hasRealConflict = reservas.some(x => {
        if(x.codusu!==codusu || x.dataISO!==dataISO || x.turno!==turno) return false;
        if(!ignoreReserva) return true;
        return !(x.fap===ignoreReserva.fap && x.codusu===ignoreReserva.codusu && x.dataISO===ignoreReserva.dataISO && x.turno===ignoreReserva.turno);
      });
      if(hasRealConflict) return false;

      const simStatus = getSimulatedStatusLR(codusu, dataISO, turno, ignoreReserva);
      return simStatus !== "R";
    }

    function getSimulatedStatusLR(codusu, dataISO, turno, ignoreReserva){
      if(!state.dtIni || !state.dtFim) return "L";
      const days = buildDaysRange(state.dtIni, state.dtFim);
      const dayIndex = days.findIndex(d => toISODate(d) === dataISO);
      const baseLR = dayIndex >= 0 ? baseStatusLR(seedFor(codusu), dayIndex, turno) : "L";
      const hasSameFap = reservas.some(r => {
        if(r.fap!==state.fap || r.codusu!==codusu || r.dataISO!==dataISO || r.turno!==turno) return false;
        if(!ignoreReserva) return true;
        return !(r.fap===ignoreReserva.fap && r.codusu===ignoreReserva.codusu && r.dataISO===ignoreReserva.dataISO && r.turno===ignoreReserva.turno);
      });
      return hasSameFap ? "R" : baseLR;
    }

    function periodAvailabilityPct(codusu){
      if(!state.dtIni || !state.dtFim) return 0;
      const days = buildDaysRange(state.dtIni, state.dtFim);
      let total = 0, free = 0;
      for(const d of days){
        const iso = toISODate(d);
        for(const t of ["M","T"]){
          total += 1;
          const base = baseStatusLR(seedFor(codusu), days.indexOf(d), t);
          const st = getSlotStatusLR(codusu, iso, t, base);
          if(st === "L") free += 1;
        }
      }
      return total ? (free/total) : 0;
    }

    function seedFor(codusu){
      const cElig = currentEligible?.find(x => x.codusu===codusu);
      if(cElig?.seed) return cElig.seed;
      const c = consultoresBase.find(x => x.codusu===codusu);
      return (c?.seed || 1);
    }

    function getSwapTargetSlot(){
      const r = swapCtx.reserva;
      const domDate = document.getElementById("swapDate")?.value;
      const domTurno = document.getElementById("swapTurno")?.value;
      return {
        dateISO: domDate || swapCtx.dateISO || r?.dataISO,
        turno: domTurno || swapCtx.turno || r?.turno
      };
    }

    function updateSwapSlotUI(){
      const r = swapCtx.reserva;
      if(!r) return;
      const { dateISO, turno } = getSwapTargetSlot();
      const packNome = packs[r.packId]?.nome || r.packId || "‚Äî";
      const curTurno = r.turno === "M" ? "Manh√£" : "Tarde";
      const newTurno = turno === "M" ? "Manh√£" : "Tarde";
      const curLabel = `${fmtBR(r.dataISO)} ‚Ä¢ ${curTurno}`;
      const newLabel = `${fmtBR(dateISO)} ‚Ä¢ ${newTurno}`;
      $("#swapContext").innerHTML = `<b>FAP ${r.fap}</b> ‚Ä¢ Atual: ${curLabel} ‚Ä¢ Novo: ${newLabel} ‚Ä¢ Pack: <b>${packNome}</b>`;
      $("#swapBadgeSlot").textContent = (r.dataISO===dateISO && r.turno===turno)
        ? `Slot: ${newLabel}`
        : `Slot atual: ${curLabel} ‚Ä¢ Novo: ${newLabel}`;

      const atual = consultoresBase.find(c => c.codusu===r.codusu);
      $("#swapCurrentBox").innerHTML = renderPersonMini(atual, r, true, dateISO, turno, r);
      if(swapCtx.selected){
        $("#swapSelectedBox").innerHTML = renderPersonMini(swapCtx.selected, r, false, dateISO, turno, r);
      }
      updateCompareHighlight(atual, swapCtx.selected);
    }

    function updateCompareHighlight(atual, novo){
      const curEl = document.getElementById("swapCurrentBox");
      const newEl = document.getElementById("swapSelectedBox");
      if(!curEl || !newEl) return;
      curEl.classList.remove("compareBetter");
      newEl.classList.remove("compareBetter");
      if(!atual || !novo) return;
      const curPct = periodAvailabilityPct(atual.codusu);
      const newPct = periodAvailabilityPct(novo.codusu);
      if(newPct > curPct){
        newEl.classList.add("compareBetter");
      }else if(curPct > newPct){
        curEl.classList.add("compareBetter");
      }
    }

    function renderSwapCandidates(){
      if(!swapCtx.reserva) return;
      const r = swapCtx.reserva;
      const { dateISO, turno } = getSwapTargetSlot();

      const q = ($("#swapSearch").value || "").trim().toLowerCase();
      const vinc = $("#swapVinculo").value;
      const onlyFree = $("#swapOnlyFree").checked;
      const sort = $("#swapSort").value;

      // Lista base: eleg√≠veis
      let cands = currentEligible
        .map(c => {
          const slotFree = isSlotFreeConsideringSwap(c.codusu, dateISO, turno, r);
          const pct = periodAvailabilityPct(c.codusu);
          const v = (c.vinculo || vinculoFromSub(c.sub) || "").toUpperCase();
          return { ...c, _slotFree: slotFree, _pct: pct, _v: v };
        })
        .filter(c => c.codusu !== r.codusu); // evita sugerir o mesmo

      // Filtros
      if(q){
        cands = cands.filter(c => (c.nome||"").toLowerCase().includes(q) || (c.codusu||"").toLowerCase().includes(q));
      }
      if(vinc !== "ALL"){
        if(vinc === "REC"){
          cands = cands.filter(c => c._v === "CLT" || c._v === "PJ");
        }else{
          cands = cands.filter(c => c._v === vinc);
        }
      }
      if(onlyFree){
        cands = cands.filter(c => c._slotFree);
      }

      // Ordena√ß√£o
      if(sort === "NAME"){
        cands.sort((a,b) => (a.nome||"").localeCompare(b.nome||""));
      }else if(sort === "AVAIL"){
        cands.sort((a,b) => (b._pct - a._pct) || (a.nome||"").localeCompare(b.nome||""));
      }else{
        // SMART: preferir CLT, depois slotFree, depois disponibilidade
        cands.sort((a,b) => {
          const aScore = (a._v==="CLT"? 1000:0) + (a._slotFree?100:0) + Math.round(a._pct*100);
          const bScore = (b._v==="CLT"? 1000:0) + (b._slotFree?100:0) + Math.round(b._pct*100);
          return (bScore - aScore) || (a.nome||"").localeCompare(b.nome||"");
        });
      }

      // Render
      const box = $("#swapCandList");
      box.innerHTML = "";
      if(!cands.length){
        box.innerHTML = `<div class="muted">Nenhum consultor encontrado com os filtros atuais.</div>`;
        return;
      }

      const atual = consultoresBase.find(x => x.codusu===r.codusu);
      const atualPct = atual ? periodAvailabilityPct(atual.codusu) : 0;

      for(const c of cands){
        const slotBadge = c._slotFree ? `<span class="badge ok">Livre no slot</span>` : `<span class="badge off">Ocupado</span>`;
        const typeChip = c._v === "CLT"
          ? `<span class="chip good">CLT</span>`
          : (c._v === "BP" ? `<span class="chip warn">BP</span>` : `<span class="chip warn">TERCEIRO</span>`);
        const pct = Math.round(c._pct*100);

        const el = document.createElement("div");
        const isBetter = c._pct > atualPct;
        el.className = "cand" + (swapCtx.selected?.codusu===c.codusu ? " selected" : "") + (isBetter ? " better" : "");
        el.dataset.codusu = c.codusu;
        el.innerHTML = `
          <div>
            <h4>${c.nome}</h4>
            <div class="meta">
              <span class="chip">${c.codusu}</span>
              ${typeChip}
              ${slotBadge}
              <span class="badge">${pct}% livre no per√≠odo</span>
            </div>
            <div class="muted" style="margin-top:6px">${(c.sub||"").trim() || "‚Äî"}</div>
          </div>
          <div class="right">
            <div class="kpi"><b>${c._v==="CLT" ? "Preferencial" : "Exce√ß√£o"}</b><br/><span class="muted">regra PJ/CLT</span></div>
            <button class="secondary" style="width:auto; padding:8px 10px" type="button">Selecionar</button>
          </div>
        `;

        el.querySelector("button").addEventListener("click", () => selectSwapCandidate(c));
        el.addEventListener("click", (ev) => { if(ev.target.tagName !== "BUTTON") selectSwapCandidate(c); });
        box.appendChild(el);
      }
    }

    function selectSwapCandidate(c){
      swapCtx.selected = c;

      // Render selecionado
      const { dateISO, turno } = getSwapTargetSlot();
      $("#swapSelectedBox").innerHTML = renderPersonMini(c, swapCtx.reserva, false, dateISO, turno, swapCtx.reserva);
      const atual = consultoresBase.find(x => x.codusu===swapCtx.reserva?.codusu);
      updateCompareHighlight(atual, c);

      // Regras PJ/CLT
      const cltAvail = hasCltAvailabilityInPeriod();
      const isPJ = (c._v || (c.vinculo||"").toUpperCase()) === "PJ";
      swapCtx.needJust = isPJ && cltAvail;

      $("#swapJustBox").style.display = swapCtx.needJust ? "block" : "none";
      const b=$("#btnSwapConfirm"); if(b){ b.classList.remove("isDisabled"); delete b.dataset.disabled; }

      // Atualiza sele√ß√£o visual
      renderSwapCandidates();
    }

    
    // Fallback robusto: confirma troca mesmo se o swapCtx.selected n√£o tiver sido setado por algum motivo
    function forceConfirmSwap(){
      try{
        if(!swapCtx || !swapCtx.reserva){
          alert("N√£o h√° contexto de troca aberto.");
          return;
        }

        // Se n√£o houver selecionado no contexto, tenta recuperar do DOM (.cand.selected)
        if(!swapCtx.selected){
          const sel = document.querySelector("#swapCandList .cand.selected");
          const cod = sel?.dataset?.codusu;
          if(cod){
            const cand = currentEligible.find(x => x.codusu === cod);
            if(cand){
              // preserva campos auxiliares se existirem
              swapCtx.selected = cand;
            }
          }
        }

        if(!swapCtx.selected){
          alert("Selecione um consultor na lista antes de confirmar a troca.");
          return;
        }

        confirmSwap();
      }catch(e){
        console.error(e);
        alert("Falha ao confirmar a troca. Verifique o console.");
      }
    }

function confirmSwap(){
      try{
        console.log('confirmSwap called', swapCtx);
      const r = swapCtx.reserva;
      const c = swapCtx.selected;
      if(!r){ alert("Reserva inv√°lida."); return; }
      if(!c){ alert("Selecione um consultor na lista antes de confirmar a troca."); return; }

      const { dateISO, turno } = getSwapTargetSlot();
      if(!dateISO || !turno){
        alert("Informe a data e o turno.");
        return;
      }

      if(c.codusu === r.codusu && dateISO === r.dataISO && turno === r.turno){
        alert("Nenhuma altera√É¬ß√É¬£o detectada (mesmo consultor, data e turno).");
        return;
      }

      // Valida slot livre (conflito)
      if(!isSlotFreeConsideringSwap(c.codusu, dateISO, turno, r)){
        alert("Conflito: este consultor j√° est√° ocupado nesse slot (data/turno).");
        return;
      }
    // Garantia: confirmSwap acess√≠vel globalmente
    window.confirmSwap = confirmSwap;

      // Valida elegibilidade (seguran√ßa)
      if(!currentEligible.some(x => x.codusu===c.codusu)){
        alert("Consultor n√£o √© eleg√≠vel para os packs selecionados.");
        return;
      }

      // Justificativa quando PJ com CLT dispon√≠vel
      let just = "";
      if(swapCtx.needJust){
        just = ($("#swapJustText").value || "").trim();
        if(!just){
          alert("Justificativa obrigat√≥ria para escolher Terceiro quando h√° CLT dispon√≠vel no per√≠odo.");
          return;
        }
      }

      const old = r.codusu;
      const oldDateISO = r.dataISO;
      const oldTurno = r.turno;
      const byId = Object.fromEntries(consultoresBase.map(c => [c.codusu, c]));
      const oldName = byId[old]?.nome || old;
      const newName = byId[c.codusu]?.nome || c.codusu;
      const idxReal = reservas.findIndex(x => x.fap===r.fap && x.codusu===r.codusu && x.dataISO===r.dataISO && x.turno===r.turno);
      if(idxReal >= 0){
        reservas[idxReal].codusu = c.codusu;
        reservas[idxReal].justPJ = swapCtx.needJust ? just : "";
        reservas[idxReal].dataISO = dateISO;
        reservas[idxReal].turno = turno;
      }
      scheduleSave();

      const turnoLabel = turno === "M" ? "Manh√É¬£" : "Tarde";
      const oldTurnoLabel = oldTurno === "M" ? "Manh√É¬£" : "Tarde";
      const actionLabel = (old === c.codusu) ? "Ajuste de data/turno" : "Troca de consultor";
      const packNomeLog = packs[r.packId]?.nome || r.packId || "√¢‚Ç¨‚Äù";
      const etapaLog = r.etapa ? ` √¢‚Ç¨¬¢ Etapa: ${r.etapa}` : "";
      const modLog = r.modalidade ? ` √¢‚Ç¨¬¢ ${r.modalidade}` : "";
      const slotLog = (oldDateISO === dateISO && oldTurno === turno)
        ? `${fmtBR(dateISO)} (${turnoLabel})`
        : `${fmtBR(oldDateISO)} (${oldTurnoLabel}) -> ${fmtBR(dateISO)} (${turnoLabel})`;
      logLeaderChange(actionLabel, `${oldName} -> ${newName} √¢‚Ç¨¬¢ Slot: ${slotLog} √¢‚Ç¨¬¢ Pack: ${packNomeLog}${etapaLog}${modLog}`);
      alert("Altera√É¬ß√É¬£o registrada (log registrado).");

      closeSwapModal();
      renderLeaderResList();
      renderAgenda();
      renderStepsP1();
      if(typeof renderP4ThirdPartyAlerts==='function'){ renderP4ThirdPartyAlerts(); }
      }catch(e){
        console.error(e);
        alert('Falha ao confirmar a troca. Verifique o console.');
      }
    }

    // Events do modal
    document.addEventListener("click", (e) => {
// Confirmar troca (delegado): funciona mesmo que o HTML do modal esteja ap√≥s o <script>
const cbtn = e.target?.closest?.("#btnSwapConfirm");
if(cbtn){
  e.preventDefault();
  try{ confirmSwap(); }catch(err){ console.error(err); alert("Falha ao confirmar a troca. Verifique o console."); }
  return;
}
      const btn = e.target?.closest?.("#btnSwapClose, #btnSwapCancel");
      if(btn) closeSwapModal();
      // Fecha clicando fora do modal
      if(e.target?.id === "swapBackdrop") closeSwapModal();
      // Quick reasons
      const rr = e.target?.closest?.("[data-reason]");
      if(rr && $("#swapJustText")){
        const t = $("#swapJustText");
        const reason = rr.getAttribute("data-reason");
        t.value = (t.value ? (t.value.trim() + " ‚Ä¢ ") : "") + reason;
        t.focus();
      }

      const vbtn = e.target?.closest?.("#btnClientValidated");
      if(vbtn){
        e.preventDefault();
        handleClientValidated();
      }

      const rbtn = e.target?.closest?.("#btnReprogramClose, #btnReprogramCancel");
      if(rbtn) closeReprogramModal();
      if(e.target?.id === "reprogramBackdrop") closeReprogramModal();
      const rConfirm = e.target?.closest?.("#btnReprogramConfirm");
      if(rConfirm){
        const reason = document.getElementById("reprogramReason")?.value || "";
        const detail = (document.getElementById("reprogramDetail")?.value || "").trim();
        if(!reason){
          alert("Selecione o motivo da reprograma√ß√£o.");
          return;
        }
        if(reason === "Outro" && !detail){
          alert("Descreva o motivo da reprograma√ß√£o.");
          return;
        }
        const fap = reprogramCtx.fap || state.fap;
        reprogramReasonsByFap[fap] = { reason, detail, whenISO: nowISO() };
        scheduleSave();
        reprogramCtx.confirmed = true;
        closeReprogramModal();
        if(typeof reprogramCtx.onConfirm === "function"){
          reprogramCtx.onConfirm();
        }
      }
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && swapCtx.open) closeSwapModal();
      if(e.key === "Escape" && reprogramCtx.open) closeReprogramModal();
    });

    ["swapSearch","swapVinculo","swapSort","swapOnlyFree"].forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("input", renderSwapCandidates);
        el.addEventListener("change", renderSwapCandidates);
      }
    });

    const reprogramReasonEl = document.getElementById("reprogramReason");
    if(reprogramReasonEl){
      reprogramReasonEl.addEventListener("change", () => {
        const wrap = document.getElementById("reprogramDetailWrap");
        if(wrap) wrap.style.display = (reprogramReasonEl.value === "Outro") ? "block" : "none";
      });
    }

    ["swapDate","swapTurno"].forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("input", () => {
          if(!swapCtx.reserva) return;
          swapCtx.dateISO = $("#swapDate").value || swapCtx.reserva.dataISO;
          swapCtx.turno = $("#swapTurno").value || swapCtx.reserva.turno;
          updateSwapSlotUI();
          renderSwapCandidates();
        });
        el.addEventListener("change", () => {
          if(!swapCtx.reserva) return;
          swapCtx.dateISO = $("#swapDate").value || swapCtx.reserva.dataISO;
          swapCtx.turno = $("#swapTurno").value || swapCtx.reserva.turno;
          updateSwapSlotUI();
          renderSwapCandidates();
        });
      }
    });

    // Delega√ß√£o segura para inputs do modal (HTML pode estar ap√≥s o script)
    document.addEventListener("input", (e) => {
      const id = e.target?.id;
      if(id !== "swapDate" && id !== "swapTurno") return;
      if(!swapCtx.reserva) return;
      swapCtx.dateISO = $("#swapDate").value || swapCtx.reserva.dataISO;
      swapCtx.turno = $("#swapTurno").value || swapCtx.reserva.turno;
      updateSwapSlotUI();
      renderSwapCandidates();
    });
    document.addEventListener("change", (e) => {
      const id = e.target?.id;
      if(id !== "swapDate" && id !== "swapTurno") return;
      if(!swapCtx.reserva) return;
      swapCtx.dateISO = $("#swapDate").value || swapCtx.reserva.dataISO;
      swapCtx.turno = $("#swapTurno").value || swapCtx.reserva.turno;
      updateSwapSlotUI();
      renderSwapCandidates();
    });

    const btnConfirm = document.getElementById("btnSwapConfirm");
    if(btnConfirm) btnConfirm.addEventListener("click", confirmSwap);


    // ===== A√ß√£o robusta: abrir modal de reserva para sele√ß√£o m√∫ltipla =====
    function openSelectedModal(){
      if(!selectedSlots || selectedSlots.length < 1){
        alert("Selecione pelo menos 1 per√≠odo antes de reservar.");
        return;
      }
      const cod = selectedSlots[0].codusu;
      if(selectedSlots.some(s => s.codusu !== cod)){
        alert("Sele√ß√£o m√∫ltipla permitida apenas para o mesmo consultor.");
        return;
      }
      const first = selectedSlots[0];
      const slots = selectedSlots.slice().sort((a,b)=>a.idx-b.idx);
      openModal({
        codusu: first.codusu,
        nome: first.nome,
        iso: first.iso,
        turno: first.turno,
        slots: slots
      });
    }
      // Dispon√≠vel para onclick inline
      window.openSelectedModal = openSelectedModal;


      // Bind seguro do bot√£o de multi-sele√ß√£o
      document.addEventListener('DOMContentLoaded', () => {
        const b = document.getElementById('btnReserveSelected');
        if(b){
          b.addEventListener('click', (e)=>{ e.preventDefault(); openSelectedModal(); });
        }
      });

</script>

  <!-- ===== Modal: Trocar Consultor (Etapa 4 ‚Äì melhoria de usabilidade) ===== -->
  <div class="modalBackdrop" id="swapBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="swapTitle">
      <div class="modalHeader">
        <div>
          <h3 id="swapTitle">Trocar consultor</h3>
          <div class="muted" id="swapContext">‚Äî</div>
        </div>
        <button class="ghost" style="width:auto; padding:8px 10px" id="btnSwapClose">Fechar ‚úï</button>
      </div>

      <div class="modalBody">
        <div class="modalGrid">
          <!-- Coluna esquerda: lista -->
          <div>
            <div class="miniCard" style="margin-bottom:10px">
              <h4 style="margin-bottom:6px">Encontrar recurso dispon√≠vel</h4>
              <div class="toolbar">
                <input id="swapSearch" placeholder="Buscar por nome ou CODUSU (ex.: U001)" />
                <select id="swapVinculo">
                  <option value="REC">Recursos (CLT + Terceiro)</option>
                  <option value="ALL">Todos (CLT + Terceiro + BP)</option>
                  <option value="CLT">Somente CLT</option>
                  <option value="PJ">Somente Terceiro</option>
                  <option value="BP">Somente BP</option>
                </select>
                <select id="swapSort">
                  <option value="SMART">Ordena√ß√£o inteligente (preferir CLT e disponibilidade)</option>
                  <option value="AVAIL">Maior disponibilidade no per√≠odo</option>
                  <option value="NAME">Nome (A-Z)</option>
                </select>
                <label class="chip" style="cursor:pointer">
                  <input type="checkbox" id="swapOnlyFree" style="width:auto; height:auto; margin:0" checked />
                  Apenas livres no slot
                </label>
              </div>
              <div class="muted" id="swapHint" style="margin-top:6px">
                Lista considera consultores <b>eleg√≠veis</b> pelos packs selecionados e evidencia quem est√° livre no mesmo dia/turno.
              </div>
            </div>

            <div class="candList" id="swapCandList"></div>
          </div>

          <!-- Coluna direita: compara√ß√£o / justificativa -->
          <div>
            <div class="miniCard" style="margin-bottom:10px">
              <h4>Ajustar data e turno</h4>
              <div class="row">
                <div>
                  <label>Data</label>
                  <input id="swapDate" type="date" />
                </div>
                <div>
                  <label>Turno</label>
                  <select id="swapTurno">
                    <option value="M">Manh√£</option>
                    <option value="T">Tarde</option>
                  </select>
                </div>
              </div>
              <div class="muted" style="margin-top:6px">Voc√™ pode manter o consultor atual e ajustar o slot.</div>
            </div>

            <div class="miniCard" style="margin-bottom:10px">
              <h4>Compara√ß√£o</h4>
              <div class="compareRow">
                <div>
                  <div class="muted" style="margin-bottom:6px">Atual</div>
                  <div id="swapCurrentBox" class="compareBox">‚Äî</div>
                </div>
                <div>
                  <div class="muted" style="margin-bottom:6px">Novo (selecionado)</div>
                  <div id="swapSelectedBox" class="compareBox">Selecione um consultor na lista</div>
                </div>
              </div>
            </div>

            <div class="miniCard" id="swapJustBox" style="display:none">
              <h4>Justificativa (obrigat√≥ria)</h4>
              <div class="muted">Voc√™ selecionou <b>Terceiro</b> com <b>CLT dispon√≠vel</b> no per√≠odo. Informe a justificativa para auditoria/valida√ß√£o.</div>
              <textarea id="swapJustText" placeholder="Ex.: Especializa√ß√£o t√©cnica necess√°ria / Continuidade do projeto / Indisponibilidade do CLT"></textarea>
              <div class="quickReasons">
                <button class="secondary" type="button" data-reason="Especializa√ß√£o t√©cnica necess√°ria">Especializa√ß√£o t√©cnica</button>
                <button class="secondary" type="button" data-reason="Continuidade do projeto">Continuidade</button>
                <button class="secondary" type="button" data-reason="Indisponibilidade futura do CLT">Indisponibilidade do CLT</button>
                <button class="secondary" type="button" data-reason="Solicita√ß√£o do cliente">Solicita√ß√£o do cliente</button>
              </div>
            </div>

            <div class="miniCard" style="margin-top:10px">
              <h4>Observa√ß√µes</h4>
              <div class="muted">Dica: priorize <b>CLT</b> quando houver disponibilidade e use Terceiro com justificativa clara. Evite conflitos no mesmo slot.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <div class="left">
          <span class="badge" id="swapBadgeSlot">Slot: ‚Äî</span>
          <span class="badge" id="swapBadgeRule">Regra PJ/CLT: ‚Äî</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <button class="secondary" style="width:auto; padding:10px 12px" id="btnSwapCancel">Cancelar</button>
          <button class="primary" style="width:auto; padding:10px 12px" id="btnSwapConfirm" >Confirmar troca</button>
        </div>
      </div>
    </div>
  </div>


  <!-- ===== Modal: Reprograma√ß√£o de Cronograma ===== -->
  <div class="modalBackdrop" id="reprogramBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reprogramTitle">
      <div class="modalHeader">
        <div>
          <h3 id="reprogramTitle">Reprogramar cronograma</h3>
          <div class="muted" id="reprogramContext">‚Äî</div>
        </div>
        <button class="ghost" style="width:auto; padding:8px 10px" id="btnReprogramClose">Fechar ‚úï</button>
      </div>
      <div class="modalBody">
        <label>Motivo da reprograma√ß√£o</label>
        <select id="reprogramReason">
          <option value="">Selecione...</option>
          <option value="Mudan√ßa de escopo">Mudan√ßa de escopo</option>
          <option value="Replanejamento de go-live">Replanejamento de go-live</option>
          <option value="Indisponibilidade de consultor">Indisponibilidade de consultor</option>
          <option value="Solicita√ß√£o do cliente">Solicita√ß√£o do cliente</option>
          <option value="Outro">Outro</option>
        </select>
        <div id="reprogramDetailWrap" style="display:none">
          <label>Detalhes</label>
          <textarea id="reprogramDetail" placeholder="Descreva o motivo"></textarea>
        </div>
      </div>
      <div class="modalFooter">
        <div class="left">
          <span class="badge" id="reprogramBadge">‚Äî</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <button class="secondary" style="width:auto; padding:10px 12px" id="btnReprogramCancel">Cancelar</button>
          <button class="primary" style="width:auto; padding:10px 12px" id="btnReprogramConfirm">Confirmar</button>
        </div>
      </div>
    </div>
  </div>


<script>
function ensureModalidadeUI(){
  const body = document.querySelector('#modalBack .modal .body');
  if(!body || body.querySelector('[name="modalidadeAgenda"]')) return;

  const div = document.createElement('div');
  div.className = 'form-group';
  div.innerHTML = `
    <label><strong>Modalidade da Agenda <span style="color:red">*</span></strong></label>
    <div class="modalidadeRow">
      <label class="modalidadeOption"><input type="radio" name="modalidadeAgenda" value="Remoto" checked> <span>Remoto</span></label>
      <label class="modalidadeOption"><input type="radio" name="modalidadeAgenda" value="Presencial"> <span>Presencial</span></label>
    </div>`;

  // Posi√ß√£o desejada: ap√≥s o select de Etapa e ANTES dos bot√µes de reserva
  const btnRow = body.querySelector('.btnRow');
  if(btnRow){
    body.insertBefore(div, btnRow);
    return;
  }

  // Fallback: abaixo do campo Etapa
  const etapaEl = document.getElementById('mEtapa');
  if(etapaEl && etapaEl.parentNode){
    etapaEl.parentNode.insertBefore(div, etapaEl.nextSibling);
    return;
  }

  // fallback final
  body.appendChild(div);
}
const _openModal = openModal;
openModal = function(ctx){
  _openModal(ctx);
  ensureModalidadeUI();
  const r = document.querySelector('input[name="modalidadeAgenda"][value="Remoto"]');
  if(r) r.checked = true;
}
function getModalidade(){
  const r = document.querySelector('input[name="modalidadeAgenda"]:checked');
  if(!r){ alert('‚ö†Ô∏è Selecione se a agenda √© Remota ou Presencial.'); return null; }
  return r.value;
}
// patch reserve buttons
document.getElementById("btnReserveHalf")?.addEventListener("click", (e)=>{
  const m = getModalidade(); if(!m){ e.stopImmediatePropagation(); return; }
  modalCtx.modalidade = m;
});
document.getElementById("btnResumoPdf")?.addEventListener("click", () => {
  if(!canExportResumo()){ alert("O export s√≥ fica dispon√≠vel ap√≥s o aceite do Gerente de Projeto."); return; }
  exportResumoPDF();
});
document.getElementById("btnResumoCsv")?.addEventListener("click", () => {
  if(!canExportResumo()){ alert("O export s√≥ fica dispon√≠vel ap√≥s o aceite do Gerente de Projeto."); return; }
  exportResumoCSV();
});
document.getElementById("btnReserveDay")?.addEventListener("click", (e)=>{
  const m = getModalidade(); if(!m){ e.stopImmediatePropagation(); return; }
  modalCtx.modalidade = m;
});
</script>

</body>
</html>
